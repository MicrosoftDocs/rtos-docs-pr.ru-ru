---
title: Глава 5. Поддержка NOR для LevelX в ОСРВ Azure
description: Флэш-память NOR состоит из блоков, размер которых обычно составляет 512 байтов. LevelX в ОСРВ Azure делит каждый блок флэш-памяти NOR на 512-байтовые логические сектора.
author: philmea
ms.author: philmea
ms.date: 05/19/2020
ms.topic: article
ms.service: rtos
ms.openlocfilehash: d5d06fa66f0cae29eeb2a89560704b2ef510597e44a565499bf672a75555f208
ms.sourcegitcommit: 93d716cf7e3d735b18246d659ec9ec7f82c336de
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/07/2021
ms.locfileid: "116790570"
---
# <a name="chapter-5---azure-rtos-levelx-nor-support"></a>Глава 5. Поддержка NOR для LevelX в ОСРВ Azure

Флэш-память NOR состоит из *блоков*, размер которых обычно составляет 512 байтов. Во флэш-памяти NOR нет понятия *страницы*. Кроме того, в ней нет *свободных* байтов, поэтому для получения всех сведений об управлении LevelX в ОСРВ Azure должен использовать саму флэш-память NOR. Во флэш-памяти NOR существует прямой доступ для чтения. Для получения доступа на запись обычно требуется выполнить особую последовательность операций. Флэш-память NOR поддерживает многократную запись при условии предварительной очистки битов. Биты во флэш-памяти NOR можно задать только один раз с помощью операции очистки блока.

LevelX делит каждый блок флэш-памяти NOR на 512-байтовые логические *сектора*. Кроме того, LevelX использует первые "n" секторов для каждого блока флэш-памяти NOR для хранения данных об управлении. Ниже приведен формат данных об управлении для флэш-памяти NOR для LevelX.

**Формат блока NOR для LevelX**

| Смещение в байтах  | Содержимое                     |
| ------------ | ---------------------------- |
| 0            | [Число очисток блока]          |
| 4            | [Минимальный сопоставленный сектор]      |
| 8            | [Максимальный сопоставленный сектор]      |
| 12           | [Битовая карта свободного сектора]        |
| m            | [Запись сопоставления сектора 0]     |
|              | …                            |
| m+4*(n-1)    | [Запись сопоставления сектора "n"]   |
|              | …                            |
| s            | [Содержимое сектора 0]          |
|              | …                            |
| s+512*(n-1) | [Содержимое сектора "n"]         |

32-разрядное *число очисток блока* означает, сколько раз выполнялась очистка блока. Основная цель LevelX заключается в том, чтобы число очисток всех блоков было относительно близко к указанному, чтобы избежать преждевременного выхода блока из строя. 32-разрядные поля *Минимальный сопоставленный сектор* и *Максимальный сопоставленный сектор* записываются только в том случае, если все логические секторы в блоке были сопоставлены и в них выполнена запись. Эти поля полезны для оптимизации операции чтения секторов. Запись *Битовая карта свободного сектора* является битовой картой, где каждый заданный бит соответствует несопоставленному сектору в блоке. Это поле используется для повышения эффективности поиска в свободных секторов. Это поле переменной длины, требующее указания одного слова для каждых 32 секторов в блоке. Массив *Запись сопоставления секторов* содержит сведения о сопоставлении для каждого сектора в блоке. Формат каждой записи приведен ниже.

**Запись сопоставления секторов**

| Биты | Значение  |
| ------ | -------- |
| 31     | Флаг допустимости. Если установлен, и логический сектор не состоит только из единиц, значит сопоставление допустимо. |
| 30     | Флаг устаревания. Если не установлен, это сопоставление является устаревшим или находится в процессе устаревания. |
| 29     | Запись сопоставления завершена, если этот бит равен 0. |
| 0–28   | Логический сектор сопоставлен с этой физическим сектором (если не состоит только из единиц). |

Верхний бит 32-разрядного поля (бит 31) используется для обозначения допустимости сопоставления логического сектора. Если этот бит равен 0, информация в этой записи (и соответствующее содержимое сектора) больше недействительна. Следующий бит — 30 — используется, чтобы указать, что этот сектор находится в процессе устаревания и запись осуществляется в новый сектор. Бит 29 используется для указания завершения записи сопоставления. Если бит 29 равен 0, запись сопоставления завершена. Если бит 29 задан, запись сопоставления находилась в процессе записи. Биты 30 и 29 используются при восстановлении после возможного отключения питания, одновременно обновляя новый сектор. Наконец, нижние 29 битов (28–0) содержат номер логического сектора. Если сектор не был сопоставлен, будут заданы биты, то есть сектор будет иметь значение 0xFFFFFFFF.

## <a name="nor-driver-requirements"></a>Требования к драйверу NOR

Для LevelX требуется базовый драйвер флэш-памяти NOR, соответствующий базовой части флэш-памяти и реализации оборудования. Драйвер задается для LevelX во время инициализации через API ***lx_nor_flash_open***. Прототип драйвера LevelX выглядит следующим образом.

```c
INT nor_driver_initialize(LX_NOR_FLASH *instance);
```

Параметр *instance* указывает блок управления NOR для LevelX. Функция инициализации драйвера отвечает за настройку всех остальных служб на уровне драйвера для связанного экземпляра LevelX. Ниже перечислены службы, необходимые для каждого экземпляра NOR для LevelX.

- Чтение сектора
- Запись сектора
- Очистка блока
- Проверка очищенного блока
- Обработчик системных ошибок

## <a name="driver-initialization"></a>Инициализация драйвера

Эти службы устанавливаются посредством установки указателей функций в экземпляре **LX_NOR_FLASH** в функции инициализации драйвера. Функция инициализации драйвера также отвечает за выполнение следующих задач:

1. Указание базового адреса флэш-памяти.
1. Указание общего числа блоков и числа слов на блок.
1. Буфер ОЗУ для чтения одного сектора флэш-памяти (512 байт) и поддержки доступа к ULONG.

Функция инициализации драйвера, скорее всего, также выполнит дополнительные задачи, связанные с инициализацией устройства и (или реализации), прежде чем возвращать **LX_SUCCESS**.

## <a name="driver-read-sector"></a>Чтение сектора драйвера

Служба "Чтение сектора" драйвера NOR для LevelX за чтение определенного сектора в определенном блоке флэш-памяти NOR. Служба драйвера реализует логику проверки и исправления ошибок. В случае успешного выполнения драйвер NOR для LevelX возвращает **LX_SUCCESS**. В случае неудачи драйвер NOR для LevelX возвращает *LX_ERROR*. Ниже приведен прототип службы "Чтение сектора" драйвера NOR для LevelX.

```c
INT nor_driver_read_sector(
    ULONG *flash_address,
    ULONG *destination, 
    ULONG words);
```

*flash_address* указывает адрес логического сектора в блоке флэш-памяти NOR, а *destination* и *words* указывают место размещения содержимого сектора и количество 32-разрядных слов для считывания.

## <a name="driver-write-sector"></a>Запись сектора драйвера

Служба "Запись сектора" драйвера NOR для LevelX за запись определенного сектора в блоке флэш-памяти NOR. Служба драйвера реализует логику проверки ошибок. В случае успешного выполнения драйвер NOR для LevelX возвращает **LX_SUCCESS**. В случае неудачи драйвер NOR для LevelX возвращает **LX_ERROR**. Ниже приведен прототип службы "Запись сектора" драйвера NOR для LevelX.

```c
INT nor_driver_write_sector(
    ULONG *flash_address,
    ULONG *source, 
    ULONG words);
```

*flash_address* указывает адрес логического сектора в блоке флэш-памяти NOR, а *source* и *words* указывают источник записи и число 32-разрядных слов для записи.

> [!NOTE]
> LevelX использует драйвер для проверки успешной записи сектора. Обычно это делается путем считывания запрограммированного значения, чтобы убедиться, что оно соответствует запрошенному для записи значению.

## <a name="driver-block-erase"></a>Очистка блока драйвера

Служба "Очистка блока" драйвера NOR для LevelX отвечает за очистку указанного блока флэш-памяти NOR. В случае успешного выполнения драйвер NOR для LevelX возвращает **LX_SUCCESS**. В случае неудачи драйвер NOR для LevelX возвращает **LX_ERROR**. Ниже приведен прототип службы "Очистка блока" драйвера NOR для LevelX.

```c
INT nor_driver_block_erase(ULONG block,  
    ULONG erase_count);
```

*block* указывает блок NOR для очистки. Параметр *erase_count* указывается в целях диагностики. Например, драйверу может потребоваться предупредить другую часть программного обеспечения приложения о том, что число очисток превышает заданное пороговое значение.

> [!NOTE]
> LevelX использует драйвер для проверки всех байтов блока, чтобы убедиться, что они очищены (содержат только единицы).

## <a name="driver-block-erased-verify"></a>Проверка очищенного блока драйвера

Служба "Проверка очищенного блока" драйвера NOR для LevelX отвечает за проверку очистки указанного блока флэш-памяти NOR. В случае успешной очистки драйвер NOR для LevelX возвращает **LX_SUCCESS**. Если блок не очищен, драйвер NOR для LevelX возвращает **LX_ERROR**. Ниже приведен прототип службы "Проверка очищенного блока" драйвера NOR для LevelX.

```c
INT nor_driver_block_erased_verify(ULONG block);
```

*block* указывает, проверку очистки какого блока следует выполнить.

> [!NOTE]
> LevelX использует драйвер для проверки всех байтов указанного блока, чтобы убедиться, что они очищены (содержат только единицы).

## <a name="driver-system-error"></a>Системная ошибка

Служба "Обработчик системных ошибок" драйвера NOR LevelX отвечает за настройку обработки системных ошибок, обнаруженных LevelX. Обработка в этой подпрограмме зависит от приложения. В случае успешного выполнения драйвер NOR для LevelX возвращает **LX_SUCCESS**. В случае неудачи драйвер NOR для LevelX возвращает **LX_ERROR**. Ниже приведен прототип службы "Системная ошибка" драйвера NOR для LevelX.

```c
INT nor_driver_system_error(UINT error_code);
```

*error_code* представляет возникшую ошибку.

## <a name="nor-simulated-driver"></a>Имитированный драйвер NOR

LevelX предоставляет имитированный драйвер флэш-памяти NOR, который просто использует ОЗУ для имитации работы части флэш-памяти NOR. По умолчанию имитированный драйвер NOR предоставляет 8 блоков флэш-памяти NOR с 16 512-байтными секторами для каждого блока.

Функцией инициализации имитированного драйвера флэш-памяти NOR является ***lx_nor_flash_simulator_initialize** _. Она определена в файле _*_lx_nor_flash_simulator.c_**. Этот драйвер также является хорошим шаблоном для написания конкретных драйверов флэш-памяти NOR.

## <a name="nor-filex-integration"></a>Интеграция NOR с FileX

Как упоминалось ранее, LevelX не использует для работы FileX. Все API-интерфейсы LevelX могут вызываться непосредственно программным обеспечением приложения для хранения и извлечения необработанных данных в логические сектора, предоставляемые LevelX. Однако LevelX также поддерживает FileX.

Файл ***fx_nor_flash_simulated_driver.c*** содержит пример драйвера FileX для использования с имитацией флэш-памяти NOR. Драйвер FileX флэш-памяти NOR для LevelX является хорошей отправной точкой написания пользовательских драйверов FileX.

> [!NOTE]
> Формат флэш-памяти NOR для FileX должен представлять размер одного полного блока секторов, меньший, чем предоставляемый NOR. Это позволит обеспечить лучшую производительность во время обработки выравнивания нагрузки. Ниже приведены дополнительные способы повышения производительности записи в алгоритме выравнивания нагрузки LevelX.
> 1. Убедитесь, что размер всех операций записи соответствует размеру ровно одного или нескольких кластеров и что все они начинаются точно с границ кластера.
> 2. Перед выполнением крупных операций записи файлов предварительно выделите кластеры с помощью класса FileX ***fx_file_allocate*** API-интерфейсов.
> 3.  Периодически используйте ***lx_nor_flash_defragment*** для высвобождения максимально возможного количества блоков NOR, чтобы повысить производительность записи.
> 4. Убедитесь, что драйвер FileX включен для получения сведений об освобождении сектора, и запросы к драйверу для освобождения секторов обрабатываются в драйвере путем вызова ***lx_nor_flash_sector_release***.
