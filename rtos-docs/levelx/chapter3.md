---
title: Поддержка NAND для LevelX в ОСРВ Azure
description: Обычно флэш-память NAND используется в LevelX для больших хранилищ данных, что характерно для файловых систем.
author: philmea
ms.author: philmea
ms.date: 05/19/2020
ms.topic: article
ms.service: rtos
ms.openlocfilehash: 950a4f260d032ebe032aca79ac99cc8217915a3b21b230be9475d82b267da18c
ms.sourcegitcommit: 93d716cf7e3d735b18246d659ec9ec7f82c336de
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/07/2021
ms.locfileid: "116790587"
---
# <a name="chapter-3---azure-rtos-levelx-nand-support"></a>Глава 3. Поддержка NAND для LevelX в ОСРВ Azure

Обычно флэш-память NAND используется для больших хранилищ данных, что характерно для файловых систем. Память NAND состоит из *блоков*. Внутри каждого блока NAND находится ряд *страниц*. Блоки NAND являются очищаемыми. Это означает, что очищаются все страницы в блоке NAND (задаются все единицы). Каждая страница блока NAND имеет набор *свободных байтов*, используемых LevelX в ОСРВ Azure для учета, управления поврежденными блоками и обнаружения ошибок. Страницы блоков NAND могут иметь разные размеры. Ниже приведены наиболее распространенные размеры страниц. 

| **Page Size** | **Свободные байты** |
| ------------- | --------------- |
| 256           | 8               |
| 512           | 16              |
| 2048          | 64              |

Память NAND отличается от памяти NOR тем, что не имеет прямого доступа, то есть память NAND не может быть считана непосредственно из процессора, как память NOR. Запись в память NAND можно выполнять лишь ограниченное количество раз после очистки. Опять же, этим она отличается от памяти NOR, запись в которую можно выполнять неограниченное количество раз при условии, что запрос на запись очищает заданные биты. Наконец, уникальной особенностью флэш-памяти NAND являются свободные байты, связанные с каждой ее страницей. В таблице ниже приведены стандартные конфигурации свободных байтов.

| **Свободные байты** | **Номера байтов** | **Конфигурация**     |
| ------------------------- | -------------- | --------------------- |
| 8                         | Байты 0–2:     | Байты ECC             |
|                           | Байты 3, 4, 6, 7: | Сопоставление секторов LevelX |
|                           | Байт 5:        | Флаг поврежденного блока        |
| 16                        | Байты 0–3, 6–7: | Байты ECC             |
|                           | Байты 8–11:    | Сопоставление секторов LevelX |
|                           | Байты 12–15:   | Не используется                |
|                           | Байт 5:        | Флаг поврежденного блока        |
| 64                        | Байт 0:        | Флаг поврежденного блока        |
|                           | Байты 2–5:     | Сопоставление секторов LevelX |
|                           | Байты 6–39:    | Не используется                |
|                           | Байты 40–63:   | Байты ECC             |

LevelX использует 4 свободных байта каждой страницы NAND для отслеживания логического сектора, сопоставленного с физической страницей NAND. Эти 4 байта используются для представления 32-разрядного целого числа без знака в собственном формате LevelX. Верхний бит 32-разрядного поля (бит 31) используется для обозначения допустимости сопоставления логического сектора со страницей. Если этот бит равен 0, сведения на этой странице больше не являются допустимыми. Следующий бит — 30 — используется, чтобы указать, что эта страница находится в процессе устаревания и запись осуществляется в новый сектор. Бит 29 используется для указания завершения записи сопоставления. Если бит 29 равен 0, запись сопоставления завершена. Если бит 29 задан, запись сопоставления находилась в процессе записи. Биты 30 и 29 используются при восстановлении после возможного отключения питания и одновременно обновляют новую страницу флэш-памяти. Наконец, нижние 29 битов (28–0) содержат номер логического сектора для страницы.

**Запись сопоставления LevelX**

| Биты | Значение |
| ------ | ------- |
| 31     | Флаг допустимости. Если установлен и логический сектор не состоит только из единиц, значит, сопоставление допустимо. |
| 30     | Флаг устаревания. Если не установлен, это сопоставление является устаревшим или находится в процессе устаревания. |
| 29     | Запись сопоставления завершена, если этот бит равен 0. |
| 0–28   | Логический сектор сопоставлен с этой физической страницей (если не состоит только из единиц). |

LevelX также использует первую страницу каждого блока NAND для счетчика стираний блока, а также для вывода списка сопоставленных страниц при заполнении блока. Ниже показан формат первой страницы блока NAND в LevelX.

| Формат страницы 0 блока LevelX |
|:--------------------------:|
| [Число очисток блока]        |
| [Сопоставление сектора страницы 1]    |
| ...                        |
| [Сопоставление сектора страницы "n"]  |
| [0xF0F0F0F0]               |

> [!NOTE]
> Сведения о сопоставлении страниц записываются только в том случае, если блок заполнен, то есть запись выполнена во все страницы блока. Это ускоряет поиск сопоставления свободных страниц и логических секторов во время выполнения.

## <a name="nand-bad-block-support"></a>Поддержка поврежденных блоков NAND

Вероятность наличия поврежденных блоков в памяти NAND выше, чем в памяти NOR. В основном это обусловлено тем, что производители NAND могут увеличивать объем выпускаемой продукции, просто оставляя поврежденные блоки и указывая программному обеспечению находить возможные решения без их использования. LevelX управляет поврежденными блоками NAND, сопоставляя их.

LevelX также предоставляет API-интерфейсы для 256-байтных кодов ECC Хэмминга для базового драйвера LevelX, которые используются для вычисления новых кодов ECC или исправления 1-битной ошибки при чтении страницы в каждом 256-байтном разделе страницы.

## <a name="nand-driver-requirements"></a>Требования к драйверу NAND

Для LevelX требуется базовый драйвер флэш-памяти NAND, соответствующий базовой части флэш-памяти и реализации оборудования. Драйвер задается для LevelX во время инициализации через API ***lx_nand_flash_open***. Прототип драйвера LevelX выглядит следующим образом.

```c
INT nand_driver_initialize(LX_NAND_FLASH *instance);
```

Параметр *instance* указывает блок управления NAND для LevelX. Функция инициализации драйвера отвечает за настройку всех остальных служб на уровне драйвера для связанного экземпляра LevelX. Ниже приведены службы, необходимые для каждого экземпляра NAND для LevelX.

- Чтение страницы
- Запись страницы
- Очистка блока
- Проверка очищенного блока
- Проверка очищенной страницы
- Получение состояния блока
- Здание состояния блока
- Получение дополнительных байтов блока
- Задание дополнительных байтов блока
- Обработчик системных ошибок

## <a name="driver-initialization"></a>Инициализация драйвера

Эти службы устанавливаются посредством установки указателей функций в экземпляре **LX_NAND_FLASH** в функции инициализации драйвера. Функция инициализации драйвера также указывает общее количество блоков, страниц на блок, байтов на страницу и область ОЗУ, достаточную для считывания одной страницы в память. Функция инициализации драйвера, скорее всего, также выполнит дополнительные задачи, связанные с инициализацией устройства и (или реализации), прежде чем возвращать **LX_SUCCESS**.

## <a name="driver-read-page"></a>Чтение страницы драйвера

Служба "Чтение страницы" драйвера NAND для LevelX отвечает за чтение определенной страницы в определенном блоке флэш-памяти NAND. Служба драйвера реализует логику проверки и исправления ошибок. В случае успешного выполнения драйвер NAND для LevelX возвращает **LX_SUCCESS**. В случае неудачи драйвер NAND для LevelX возвращает **LX_ERROR**. Ниже приведен прототип службы "Чтение страницы" драйвера NAND для LevelX.

```c
INT nand_driver_read_page(
    ULONG block,
    ULONG page,
    ULONG *destination, 
    ULONG words);
```

*block* и *page* определяют, какую страницу следует считать. *destination* и *words* указывают место размещения содержимого страницы и количество 32-разрядных слов для считывания.

## <a name="driver-write-page"></a>Запись страницы драйвера

Служба "Запись страницы" драйвера NAND для LevelX отвечает за запись определенной страницы в определенном блоке флэш-памяти NAND. Служба драйвера реализует логику проверки ошибок и вычисления ECC. В случае успешного выполнения драйвер NAND для LevelX возвращает **LX_SUCCESS**. В случае неудачи драйвер NAND для LevelX возвращает **LX_ERROR**. Ниже приведен прототип службы "Записи страницы" драйвера NAND для LevelX.

```c
INT nand_driver_write_page(
    ULONG block, 
    ULONG page,
    ULONG *source, 
    ULONG words);
```

*block* и *page* определяют, на какую страницу следует выполнять запись. *source* и *words* указывают источник записи и количество записываемых 32-разрядных слов.

> [!NOTE]
> При записи на страницу флэш-памяти LevelX использует драйвер для обнаружения ошибок низкого уровня. Это обычно предполагает чтение страницы и сравнение с буфером записи, чтобы гарантировать успешную запись.

## <a name="driver-block-erase"></a>Очистка блока драйвера

Служба "Очистка блока" драйвера NAND для LevelX отвечает за очистку определенного блока флэш-памяти NAND. В случае успешного выполнения драйвер NAND для LevelX возвращает **LX_SUCCESS**. В случае неудачи драйвер NAND для LevelX возвращает **LX_ERROR**. Ниже приведен прототип службы "Очистка блока" драйвера NAND для LevelX.

```c
INT nand_driver_block_erase(ULONG block,  
    ULONG erase_count);
```

*block* указывает блок для очистки. Параметр *erase_count* указывается в целях диагностики. Например, драйверу может потребоваться предупредить другую часть программного обеспечения приложения о том, что число очисток превышает заданное пороговое значение.

> [!NOTE]
> При очистке блока LevelX использует драйвер для обнаружения ошибок низкого уровня. Это обычно предполагает проверку того, что все страницы блока состоят только из единиц.

## <a name="driver-block-erased-verify"></a>Проверка очищенного блока драйвера

Служба "Проверка очищенного блока" драйвера NAND для LevelX отвечает за проверку очистки указанного блока флэш-памяти NAND. В случае успешной очистки драйвер NAND для LevelX возвращает **LX_SUCCESS**. Если блок не очищен, драйвер NAND для LevelX возвращает **LX_ERROR**. Ниже приведен прототип службы "Проверка очищенного блока" драйвера NAND для LevelX.

```c
INT nand_driver_block_erased_verify(ULONG block);
```

*block* указывает, проверку очистки какого блока следует выполнить.

> [!NOTE]
> LevelX использует драйвер для проверки всех страниц и всех байтов на каждой странице, включая свободные байты и байты данных, чтобы убедиться, что они очищены (содержат только единицы).

## <a name="driver-page-erased-verify"></a>Проверка очищенной страницы драйвера

Служба "Проверка очищенной страницы" драйвера NAND для LevelX отвечает за проверку очистки указанной страницы указанного блока флэш-памяти NAND. В случае успешной очистки драйвер NAND для LevelX возвращает **LX_SUCCESS**. Если страница не очищена, драйвер NAND для LevelX возвращает **LX_ERROR**. Ниже приведен прототип службы "Проверка очищенной страницы" драйвера NAND для LevelX.

```c
INT nand_driver_page_erased_verify(
    ULONG block,  
    ULONG page);
```
*block* указывает, проверку очистки какого блока нужно выполнить, а *page* указывает, проверку очистки какой страницы нужно выполнить.

> [!NOTE]
> LevelX использует драйвер для проверки всех байтов на указанной странице, включая свободные байты и байты данных, чтобы убедиться, что они очищены (содержат только единицы).

## <a name="driver-block-status-get"></a>Получение состояния блока драйвера

Служба "Получение состояния блока" драйвера NAND для LevelX отвечает за получение флага поврежденного блока для указанного блока флэш-памяти NAND. В случае успешного выполнения драйвер NAND для LevelX возвращает **LX_SUCCESS**. В случае неудачи драйвер NAND для LevelX возвращает **LX_ERROR**. Ниже приведен прототип службы "Получение состояния блока" драйвера NAND для LevelX.

```c
INT nand_driver_block_status_get(
    ULONG block,  
    UCHAR *bad_block_byte);
```

*block* указывает блок, а *bad_block_byte* указывает назначение для флага поврежденного блока.

## <a name="driver-block-status-set"></a>Задание состояния блока

Служба "Задание состояния блока" драйвера NAND для LevelX отвечает за установку флага поврежденного блока для указанного блока флэш-памяти NAND. В случае успешного выполнения драйвер NAND для LevelX возвращает **LX_SUCCESS**. В случае неудачи драйвер NAND для LevelX возвращает **LX_ERROR**. Ниже приведен прототип службы "Задание состояния блока" драйвера NAND для LevelX.

```c
INT nand_driver_block_status_set(
    ULONG block,
    UCHAR bad_block_byte);
```

*block* указывает блок, а *bad_block_byte* указывает значение флага поврежденного блока.

## <a name="driver-block-extra-bytes-get"></a>Получение дополнительных байтов

Служба "Получение дополнительных байтов" драйвера NAND для LevelX отвечает за получение дополнительных байтов, связанных с определенной страницей определенного блока флэш-памяти NAND. В случае успешного выполнения драйвер NAND для LevelX возвращает **LX_SUCCESS**. В случае неудачи драйвер NAND для LevelX возвращает **LX_ERROR**. Ниже приведен прототип службы "Получение дополнительных байтов блока" драйвера NAND для LevelX.

```c
INT nand_driver_block_extra_bytes_get(
    ULONG block,  
    ULONG page, 
    UCHAR *destination, 
    UINT size);
```

*block* указывает конкретный блок, *page* —конкретную страницу, а *destination* — назначение для дополнительных байтов. Параметр *size* указывает, сколько дополнительных байтов необходимо получить.

## <a name="driver-block-extra-bytes-set"></a>Задание дополнительных байтов

Служба "Задание дополнительных байтов" драйвера NAND для LevelX отвечает за задание дополнительных байтов на определенной странице определенного блока флэш-памяти NAND. В случае успешного выполнения драйвер NAND для LevelX возвращает **LX_SUCCESS**. В случае неудачи драйвер NAND для LevelX возвращает **LX_ERROR**. Ниже приведен прототип службы "Задание дополнительных байтов блока" драйвера NAND для LevelX.

```c
INT nand_driver_block_extra_bytes_set(
    ULONG block,  
    ULONG page, 
    UCHAR *source, 
    UINT size);
```

*block* указывает конкретный блок, *page* — конкретную страницу, а *source* — источник дополнительных байтов. Параметр *size* указывает, сколько дополнительных байтов необходимо задать.

## <a name="driver-system-error"></a>Системная ошибка

Служба "Обработчик системных ошибок" драйвера NAND LevelX отвечает за настройку обработки системных ошибок, обнаруженных LevelX. Обработка в этой подпрограмме зависит от приложения. В случае успешного выполнения драйвер NAND для LevelX возвращает **LX_SUCCESS**. В случае неудачи драйвер NAND для LevelX возвращает **LX_ERROR**. Ниже приведен прототип службы "Системная ошибка" драйвера NAND для LevelX.

```c
INT nand_driver_system_error(
    UINT error_code,  
    ULONG block, 
    ULONG page);
```

*block* указывает конкретный блок, а *page* — конкретную страницу, на которой произошла ошибка, представленная *error_code*.

## <a name="nand-simulated-driver"></a>Имитированный драйвер NAND

LevelX предоставляет имитированный драйвер флэш-памяти NAND, который просто использует ОЗУ для имитации работы части флэш-памяти NAND. По умолчанию имитированный драйвер NAND предоставляет 8 блоков флэш-памяти NAND с 16 страницами на блок и 2048 байтами на страницу.

Функцией инициализации имитированного драйвера флэш-памяти NAND является **lx_nand_flash_simulator_initialize** _. Она определена в файле _*_lx_nand_flash_simulator.c_**. Этот драйвер также является хорошим шаблоном для написания конкретных драйверов флэш-памяти NAND.

## <a name="nand-filex-integration"></a>Интеграция NAND с FileX

Как упоминалось ранее, LevelX не использует для работы FileX. Все API-интерфейсы LevelX могут вызываться непосредственно программным обеспечением приложения для хранения и извлечения необработанных данных в логические сектора, предоставляемые LevelX. Однако LevelX также поддерживает FileX.

Файл ***fx_nand_flash_simulated_driver.c*** содержит пример драйвера FileX для использования с имитацией флэш-памяти NAND. Интересным аспектом этого драйвера является то, что он объединяет 512-байтовые логические секторы, обычно используемые FileX, в отдельные запросы на чтение логического сектора или запись в него к симулятору LevelX, использующему 2048-байтовые страницы. Это приводит к более эффективному использованию флэш-памяти NAND. Драйвер FileX флэш-памяти NAND для LevelX является хорошей отправной точкой написания пользовательских драйверов FileX.  
  
> [!NOTE]
> Формат флэш-памяти NAND для FileX должен представлять размер одного полного блока секторов, меньший, чем предоставляемый NAND. Это позволит обеспечить лучшую производительность во время обработки выравнивания нагрузки. Ниже приведены дополнительные способы повышения производительности записи в алгоритме выравнивания нагрузки LevelX.

1. Убедитесь, что размер всех операций записи соответствует размеру ровно одного или нескольких кластеров и что все они начинаются точно с границ кластера.
1. Перед выполнением крупных операций записи файлов предварительно выделите кластеры с помощью класса FileX ***fx_file_allocate*** API-интерфейсов.
1. Убедитесь, что драйвер FileX включен для получения сведений об освобождении сектора, и запросы к драйверу для освобождения секторов обрабатываются в драйвере путем вызова ***lx_nor_flash_sector_release***.
1. Периодически используйте ***lx_nand_flash_defragment*** для высвобождения максимально возможного количества блоков NAND, чтобы повысить производительность записи.
1. Используйте API ***lx_nand_flash_extended_cache_enable***, чтобы предоставить кэш ОЗУ различных ресурсов блоков NAND для повышения производительности.
