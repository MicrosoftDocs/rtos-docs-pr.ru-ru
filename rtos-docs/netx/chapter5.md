---
title: Глава 5. Сетевые драйверы для NetX в ОСРВ Azure
description: В этой главе содержится описание сетевых драйверов для NetX в ОСРВ Azure.
author: philmea
ms.author: philmea
ms.date: 09/11/2020
ms.topic: article
ms.service: rtos
ms.openlocfilehash: ccc55111d785d84cdb193c387830abbc03a15e7c
ms.sourcegitcommit: e3d42e1f2920ec9cb002634b542bc20754f9544e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/22/2021
ms.locfileid: "104815288"
---
# <a name="chapter-5---netx-network-drivers"></a>Глава 5. Сетевые драйверы для NetX

В этой главе содержится описание сетевых драйверов для NetX. Представленная информация предназначена для помощи разработчикам в написании сетевых драйверов для конкретных приложений для NetX в ОСРВ Azure.

## <a name="driver-introduction"></a>Основные сведения о драйвере

Структура NX_IP содержит все, что нужно для управления одним экземпляром IP. Сюда входят общие сведения о протоколе TCP/IP, а также подпрограмма входа драйвера физической сети для конкретного приложения. Подпрограмма входа драйвера определяется во время работы службы ***nx_ip_create***. К экземпляру IP можно добавить дополнительные устройства через службу ***nx_ip_interface_attach***.

Обмен данными между NetX и сетевым драйвером приложения осуществляется с помощью структуры запросов **NX_IP_DRIVER**. Эта структура чаще всего определяется локально в стеке вызывающего объекта и поэтому освобождается после возврата драйвера и вызова функции. Структура определена следующим образом.

```C
typedef struct NX_IP_DRIVER_STRUCT
{
    UINT nx_ip_driver_command;
    UINT nx_ip_driver_status;
    ULONG nx_ip_driver_physical_address_msw;
    ULONG nx_ip_driver_physical_address_lsw;
    NX_PACKET *nx_ip_driver_packet;
    ULONG *nx_ip_driver_return_ptr;
    NX_IP *nx_ip_driver_ptr;
    NX_INTERFACE *nx_ip_driver_interface;
} NX_IP_DRIVER;
```

## <a name="driver-entry"></a>Вход в драйвер

NetX вызывает функцию входа сетевого драйвера для инициализации драйвера и отправки пакетов, а также для различных операций управления и изменения состояния, в том числе инициализации и включения сетевого устройства. NetX выдает команды сетевому драйверу, задавая поле ***nx_ip_driver_command** _ в структуре запроса _ *NX_IP_DRIVER**. Функция входа драйвера имеет следующий формат.

```C
VOID my_driver_entry(NX_IP_DRIVER *request);
```

## <a name="driver-requests"></a>Запросы драйвера

NetX создает запрос драйвера с определенной командой и вызывает функцию входа драйвера для выполнения этой команды. Так как каждый сетевой драйвер имеет одну функцию входа, NetX выполняет все запросы через структуру данных запроса драйвера. Элемент ***nx_ip_driver_command*** структуры данных запроса драйвера (**NX_IP_DRIVER**) определяет запрос. Сведения о состоянии возвращаются в вызывающий объект в элементе ***nx_ip_driver_status***. Если это поле имеет значение **NX_SUCCESS**, запрос драйвера успешно выполнен.

NetX сериализует все операции доступа к драйверу. Поэтому драйверу не нужно выполнять асинхронный вызов функции входа в нескольких потоках. Обратите внимание, что функция драйвера устройства выполняется с заблокированной функцией взаимного исключения IP. Следовательно, внутренняя функция драйвера устройства не должна блокировать саму себя.

Драйвер устройства обычно также обрабатывает прерывания. Поэтому все функции драйвера должны быть защищенными от прерываний.

### <a name="driver-initialization"></a>Инициализация драйвера

Хотя фактическая обработка инициализации драйвера зависит от приложения, обычно она состоит из инициализации структуры данных и физического оборудования. Сведения, необходимые NetX для инициализации драйвера, — это максимальный передаваемый блок данных (MTU) IP, то есть возможное количество байтов полезной нагрузки на уровне протокола IP, включая заголовок IP, а также необходимость сопоставления "логический к физическому" для физического интерфейса. Драйверу необходимо

настроить MTU интерфейса, задав значение в ***nx_interface_ip_mtu_size** _ в структуре _ *NX_INTERFACE**.

Драйверу устройства также необходимо настроить значение в ***nx_ip_interface_address_mapping_needed*** в

**NX_INTERFACE**, чтобы сообщить NetX, требуется ли сопоставление адреса интерфейса. Если сопоставление адреса требуется, драйвер отвечает за настройку допустимого MAC-адреса для интерфейса и передачу этого MAC-адреса в NetX.

Когда сетевой драйвер принимает запрос NX_LINK_INITIALIZE из NetX, он получает указатель на управляющий блок IP в рамках управляющего блока запроса NX_IP_DRIVER, показанного выше.

После того как приложение вызывает ***nx_ip_create***, вспомогательный поток IP отправляет запрос драйвера с набором команд в NX_LINK_INITIALIZE, чтобы драйвер инициализировал физический сетевой интерфейс. Для запроса на инициализацию используются указанные ниже элементы NX_IP_DRIVER.

| Элемент NX_IP_DRIVER    | Значение |
|------------------------|-----------------------------------------------|
| nx_ip_driver_command   | NX_LINK_INITIALIZE |
| nx_ip_driver_ptr       | Указатель на экземпляр IP. Драйвер должен сохранить это значение, чтобы функция драйвера могла найти экземпляр IP для работы. |
| nx_ip_driver_interface | Указатель на структуру сетевого интерфейса в экземпляре IP. Драйвер должен сохранить эти сведения. При получении пакетов драйвер использует сведения о структуре интерфейса для передачи пакета вверх по стеку. |
| nx_ip_driver_status    | Состояние завершения. Если драйвер не может инициализировать указанный интерфейс в экземпляре IP, он возвращает ненулевое состояние ошибки.                                                                                           |


> [!IMPORTANT]
> *Большинство команд драйвера фактически вызываются из вспомогательного потока IP, созданного для экземпляра IP. Поэтому подпрограмме драйвера следует избегать выполнения операций блокировки. В противном случае вспомогательный поток IP может приостановить работу, что приведет к неограниченным задержкам для приложений, использующих этот поток.*

### <a name="enable-link"></a>Включение канала  

Затем вспомогательный поток IP включает физическую сеть, задавая команду драйвера NX_LINK_ENABLE в запросе драйвера и отправляя запрос сетевому драйверу. Это происходит вскоре после того, как вспомогательный поток IP завершает запрос на инициализацию. Для включения канала может быть достаточно установить поле nx_interface_link_up в экземпляре интерфейса. Но могут потребоваться и операции с физическим оборудованием. Для запроса на включение канала используются указанные ниже элементы NX_IP_DRIVER.

| Элемент NX_IP_DRIVER    | Значение |
|------------------------|------------------------------------------|
| nx_ip_driver_command   | NX_LINK_ENABLE                                                                                                          |
| nx_ip_driver_ptr       | Указатель на экземпляр IP-адреса                                                                                                  |
| nx_ip_driver_interface | Указатель на экземпляр интерфейса                                                                                       |
| nx_ip_driver_status    | Состояние завершения. Если драйвер не может включить указанный интерфейс, он возвращает ненулевое состояние ошибки. |



### <a name="disable-link"></a>Отключение канала  

Этот запрос выполняется NetX во время удаления экземпляра IP службой ***nx_ip_delete** _. Приложение может также выдать эту команду, чтобы временно отключить канал для экономии энергии. Эта служба отключает физический сетевой интерфейс в экземпляре IP. Для отключения канала может быть достаточно снять флаг _nx_interface_link_up* в экземпляре интерфейса. Но могут потребоваться и операции с физическим оборудованием. Обычно эта операция обратна операции ***включения канала**_. После отключения канала приложение запрашивает операцию _ *_включения канала_**, чтобы включить интерфейс. Для запроса на отключение канала используются указанные ниже элементы NX_IP_DRIVER.

| Элемент NX_IP_DRIVER    | Значение |
|------------------------|--------------------------------------|
| nx_ip_driver_command   | NX_LINK_DISABLE |
| nx_ip_driver_ptr       | Указатель на экземпляр IP-адреса |
| nx_ip_driver_interface | Указатель на экземпляр интерфейса |
| nx_ip_driver_status    | Состояние завершения. Если драйвер не может отключить указанный интерфейс в экземпляре IP, он возвращает ненулевое состояние ошибки. |


### <a name="uninitialize-link"></a>Отмена инициализации канала  

Этот запрос выполняется NetX во время удаления экземпляра IP службой ***nx_ip_delete***. Этот запрос отменяет инициализацию интерфейса и освобождает все ресурсы, созданные на этапе инициализации. Обычно эта операция обратна операции ***инициализации канала***. После отмены инициализации интерфейса устройство нельзя использовать до тех пор, пока интерфейс не будет инициализирован снова.

Для запроса на отключение канала используются указанные ниже элементы NX_IP_DRIVER.

| Элемент NX_IP_DRIVER  | Значение                |
|----------------------|------------------------|
| nx_ip_driver_command | NX_LINK_UNINITIALZE    |
| nx_ip_driver_ptr     | Указатель на экземпляр IP-адреса |
| nx_ip_driver_interface | Указатель на экземпляр интерфейса |
| nx_ip_driver_status    | Состояние завершения. Если драйвер не может отменить инициализацию указанного интерфейса в экземпляре IP, он возвращает ненулевое состояние ошибки. |


### <a name="packet-send"></a>Отправка пакета  

Этот запрос выполняется во время внутренней обработки отправки IP, используемой всеми протоколами NetX для передачи пакетов (за исключением ARP, RARP). При получении команды отправки пакета *nx_packet_prepend_ptr* указывает на начало отправляемого пакета, то есть начало заголовка IP.
В *nx_packet_length* указывается общий размер передаваемых данных (в байтах). Если значение *nx_packet_next* допустимо, исходящая датаграмма IP хранится в нескольких пакетах. В этом случае драйверу необходимо следовать по цепочке пакетов и передать весь кадр. Обратите внимание, что допустимая область данных в каждой цепочке пакетов хранится между *nx_packet_prepend_ptr* и *nx_packet_append_ptr*.

Драйвер отвечает за формирование физического заголовка. Если требуется сопоставление физического адреса с IP-адресом (например, Ethernet), то уровень IP уже разрешил MAC-адрес. Конечный MAC-адрес передается из экземпляра IP, который хранится в *nx_ip_driver_physical_address_msw и nx_ip_driver_physical_address_lsw.*

После добавления физического заголовка процесс отправки пакета вызывает выходную функцию драйвера для передачи пакета.

Для запроса на отправку пакета используются указанные ниже элементы NX_IP_DRIVER.

| Элемент NX_IP_DRIVER               | Значение |
|-----------------------------------|---------------------------------------------------------------|
| nx_ip_driver_command              | NX_LINK_PACKET_SEND |
| nx_ip_driver_ptr                  | Указатель на экземпляр IP-адреса |
| nx_ip_driver_packet               | Указатель на пакет для отправки |
| nx_ip_driver_interface            | Указатель на экземпляр интерфейса             |
| nx_ip_driver_physical_address_msw | Старшие 32 бита физического адреса (только если требуется физическое сопоставление) |
| nx_ip_driver_physical_address_lsw | Младшие 32 бита физического адреса (только если требуется физическое сопоставление)    |
| nx_ip_driver_status               | Состояние завершения. Если драйвер не может отправить пакет, он возвращает ненулевое состояние ошибки.  |

### <a name="packet-broadcast"></a>Широковещательная рассылка пакетов  
Этот запрос почти идентичен запросу отправки пакета. Единственное отличие заключается в том, что в полях физического адреса назначения задан MAC-адрес широковещательной рассылки Ethernet. Для запроса на широковещательную рассылку пакета используются указанные ниже элементы NX_IP_DRIVER.

| Элемент NX_IP_DRIVER                | Значение          |
|------------------------------------|--------------------------------------------------------------|
| nx_ip_driver_command               | NX_LINK_PACKET_BROADCAST |
| nx_ip_driver_ptr                   | Указатель на экземпляр IP-адреса  |
| nx_ip_driver_packet                | Указатель на пакет для завершения |
| nx_ip_driver_physical_address_msw | 0x0000FFFF (широковещательная рассылка) |
| nx_ip_driver_physical_address_lsw  | 0xFFFFFFFF (широковещательная рассылка) |
| nx_ip_driver_interface             | Указатель на экземпляр интерфейса |
| nx_ip_driver_status                | Состояние завершения. Если драйвер не может отправить пакет, он возвращает ненулевое состояние ошибки. |

### <a name="arp-send"></a>Отправка ARP  

Этот запрос также аналогичен запросу на отправку IP-пакета.
Единственное отличие заключается в том, что в заголовке Ethernet указывается пакет ARP вместо IP-пакета, а в полях физического адреса назначения задан MAC-адрес широковещательной рассылки. Для запроса на отправку ARP используются указанные ниже элементы NX_IP_DRIVER.

| **Элемент NX_IP_DRIVER** | **Значение** |
| --- | --- |
| nx_ip_driver_command | NX_LINK_ARP_SEND |
| nx_ip_driver_ptr | Указатель на экземпляр IP-адреса. |
| nx_ip_driver_packet | Указатель на пакет для отправки. |
| nx_ip_driver_physical_address_msw | 0x0000FFFF (широковещательная рассылка) |
| nx_ip_driver_physical_address_lsw | 0xFFFFFFFF (широковещательная рассылка) |
| nx_ip_driver_interface | Указатель на экземпляр интерфейса |
| nx_ip_driver_status | Состояние завершения. Если драйвер не может отправить пакет ARP, он возвращает ненулевое состояние ошибки. |

*Если физическое сопоставление не требуется, реализация этого запроса не нужна.*

### <a name="arp-response-send"></a>Отправка ответа ARP  

Этот запрос почти идентичен запросу отправки пакета ARP. Единственное отличие заключается в том, что поля физического адреса назначения передаются из экземпляра IP. Для запроса на отправку ответа ARP используются указанные ниже элементы NX_IP_DRIVER.

| Элемент NX_IP_DRIVER               | Значение |
|-----------------------------------| ------------------------------------|
| nx_ip_driver_command              | NX_LINK_ARP_RESPONSE_SEND |
| nx_ip_driver_ptr                  | Указатель на экземпляр IP-адреса |
| nx_ip_driver_packet               | Указатель на пакет для отправки|
| nx_ip_driver_physical_address_msw | Старшие 32 бита физического адреса |
| nx_ip_driver_physical_address_lsw | Младшие 32 бита физического адреса                     |
| nx_ip_driver_interface            | Указатель на экземпляр интерфейса |
| nx_ip_driver_status               | Состояние завершения. Если драйвер не может отправить пакет ARP, он возвращает ненулевое состояние ошибки. |

> [!NOTE]
> *Если физическое сопоставление не требуется, реализация этого запроса не нужна.*

### <a name="rarp-send"></a>Отправка RARP  

Этот запрос почти идентичен запросу отправки пакета ARP. Единственным отличием является тип заголовка пакета, а также то, что поля физического адреса не требуются, так как физическое назначение всегда является широковещательным адресом.

Для запроса на отправку RARP используются указанные ниже элементы NX_IP_DRIVER.

| Элемент NX_IP_DRIVER               | Значение |
|-----------------------------------|---------------------------------|
| nx_ip_driver_command              |NX_LINK_RARP_SEND |
| nx_ip_driver_ptr                  | Указатель на экземпляр IP-адреса |
| nx_ip_driver_packet               | Указатель на пакет для отправки |
| nx_ip_driver_physical_address_msw | 0x0000FFFF (широковещательная рассылка) |
| nx_ip_driver_physical_address_lsw | 0xFFFFFFFF (широковещательная рассылка) |
| Элемент NX_IP_DRIVER               | Значение |
| nx_ip_driver_interface            | Указатель на экземпляр интерфейса |
| nx_ip_driver_status               | Состояние завершения. Если драйвер не может отправить пакет RARP, он возвращает ненулевое состояние ошибки.  |

> [!NOTE]
> *Эту команду нужно реализовать в приложениях, для которых необходима служба RARP.*

### <a name="multicast-group-join"></a>Присоединение к группе многоадресной рассылки  

Этот запрос выполняется с помощью службы ***nx_igmp_multicast_interface Join***. Сетевой драйвер принимает указанный адрес группы многоадресной рассылки и настраивает физический носитель для приема входящих пакетов с этого адреса. Обратите внимание, что для драйверов, которые не поддерживают фильтрацию многоадресной рассылки, логика приема драйвера может работать в неизбирательном режиме. В этом случае драйверу может потребоваться фильтровать входящие кадры на основе MAC-адреса назначения, чтобы сократить объем трафика, передаваемого в экземпляр IP. Для запроса на присоединение к группе многоадресной рассылки используются указанные ниже элементы NX_IP_DRIVER.

| Элемент NX_IP_DRIVER               | Значение |
|-----------------------------------|-----------------------------------------------------------------------|
| nx_ip_driver_command              | NX_LINK_MULTICAST_JOIN                                                |
| nx_ip_driver_ptr                  | Указатель на экземпляр IP-адреса                                                |
| nx_ip_driver_physical_address_msw | Старшие 32 бита физического адреса многоадресной рассылки                |
| nx_ip_driver_physical_address_lsw | Младшие 32 бита физического адреса многоадресной рассылки               |
| nx_ip_driver_interface            | Указатель на экземпляр интерфейса                                     |
| nx_ip_driver_status               | Состояние завершения. Если драйвер не может присоединиться к группе многоадресной рассылки, он возвращает ненулевое состояние ошибки. |


### <a name="multicast-group-leave"></a>Выход из группы многоадресной рассылки  

Этот запрос вызывается через явный вызов службы ***nx_igmp_multicast_leave***. Драйвер удаляет указанный адрес многоадресной рассылки Ethernet из списка многоадресной рассылки. После выхода узла из группы многоадресной рассылки пакеты в сети с этим адресом многоадресной рассылки Ethernet больше не принимаются данным экземпляром IP. Для запроса на выход из группы многоадресной рассылки используются указанные ниже элементы NX_IP_DRIVER.

| Элемент NX_IP_DRIVER               | Значение |
|-----------------------------------|-----------------------------------------------------------------|
| nx_ip_driver_command              | NX_LINK_MULTICAST_LEAVE |
| nx_ip_driver_ptr                  | Указатель на экземпляр IP-адреса |
| nx_ip_driver_physical_address_msw | Старшие 32 бита физического адреса многоадресной рассылки |
| nx_ip_driver_physical_address_lsw | Младшие 32 бита физического адреса многоадресной рассылки |
| nx_ip_driver_interface            | Указатель на экземпляр интерфейса |
| nx_ip_driver_status               | Состояние завершения. Если драйвер не может выйти из группы многоадресной рассылки, он возвращает ненулевое состояние ошибки. |


### <a name="attach-interface"></a>Подключение интерфейса  

Этот запрос выполняется из NetX к драйверу устройства и позволяет связать экземпляр драйвера с соответствующим экземпляром IP и экземпляром физического интерфейса в пределах IP. Для запроса на подключение интерфейса используются указанные ниже элементы NX_IP_DRIVER.

| Элемент NX_IP_DRIVER    | Значение |
|------------------------|-------------------------------------------------|
| nx_ip_driver_command   | NX_LINK_INTERFACE_ATTACH |
| nx_ip_driver_ptr       | Указатель на экземпляр IP-адреса |
| nx_ip_driver_interface | Указатель на экземпляр интерфейса |
| nx_ip_driver_status    | Состояние завершения. Если драйвер не может отключить указанный интерфейс к экземпляру IP, он возвращает ненулевое состояние ошибки.  |


### <a name="detach-interface"></a>Отключение интерфейса  

Этот запрос выполняется из NetX к драйверу устройства и позволяет отвязать экземпляр драйвера от соответствующего экземпляра IP и экземпляра физического интерфейса в пределах IP. Для запроса на подключение интерфейса используются указанные ниже элементы NX_IP_DRIVER.

| Элемент NX_IP_DRIVER    | Значение |
|------------------------|---------------------------------------------------------|
| nx_ip_driver_command   | NX_LINK_INTERFACE_DETACH |
| nx_ip_driver_ptr       | Указатель на экземпляр IP-адреса |
| nx_ip_driver_interface | Указатель на экземпляр интерфейса |
| nx_ip_driver_status    | Состояние завершения. Если драйвер не может подключить указанный интерфейс в экземпляре IP, он возвращает ненулевое состояние ошибки. |

### <a name="get-link-status"></a>Получение состояния канала  

Приложение может запросить состояние канала сетевого интерфейса с помощью службы NetX ***nx_ip_interface_status_check*** для любого интерфейса на узле. Дополнительные сведения об этих службах см. в главе 4 "Описание служб NetX" на странице 107.

Состояние канала содержится в поле *nx_interface_link_up* в структуре NX_INTERFACE, на которую ссылается указатель *nx_ip_driver_interface*. Для запроса на получение состояния канала используются указанные ниже элементы NX_IP_DRIVER.

| Элемент NX_IP_DRIVER     | Значение                                                                                                      |
|-------------------------|--------------------------------------------------------------------------------------------------------------|
| nx_ip_driver_command    | NX_LINK_GET_STATUS                                                                                           |
| nx_ip_driver_ptr        | Указатель на экземпляр IP-адреса                                                                                       |
| nx_ip_driver_return_ptr | Указатель для размещения состояния                                                              |
| nx_ip_driver_interface  | Указатель на экземпляр интерфейса                                                                            |
| nx_ip_driver_status     | Состояние завершения. Если драйвер не может получить определенное состояние, он возвращает ненулевое состояние ошибки. |
|                         |                                                                                                              |

> [!NOTE]
> Для проверки состояния основного интерфейса можно использовать службу ***nx_ip_status_check**. Однако разработчикам приложений рекомендуется использовать службу **nx_ip_interface_status_check**, предназначенную для интерфейсов.*

### <a name="get-link-speed"></a>Определение скорости канала  

Этот запрос выполняется из службы ***nx_ip_driver_direct_command***. Драйвер сохраняет скорость канала в указанном месте. Для запроса на определение скорости канала используются указанные ниже элементы NX_IP_DRIVER.

| Элемент NX_IP_DRIVER     | Значение |
|-------------------------|---------------------------------------------------------------|
| nx_ip_driver_command    | NX_LINK_GET_SPEED |
| nx_ip_driver_ptr        | Указатель на экземпляр IP-адреса |
| nx_ip_driver_return_ptr | Указатель для размещения скорости канала |
| nx_ip_driver_interface  | Указатель на экземпляр интерфейса |
| nx_ip_driver_status     | Состояние завершения. Если драйвер не может определить скорость, он возвращает ненулевое состояние ошибки.
 |


> [!NOTE]
> *Этот запрос не используется внутри NetX, поэтому его реализация не является обязательной.*

### <a name="get-duplex-type"></a>Получение дуплексного типа  

Этот запрос выполняется из службы ***nx_ip_driver_direct_command***. Драйвер сохраняет дуплексный тип канала в указанном месте. Для запроса на получение дуплексного типа используются указанные ниже элементы NX_IP_DRIVER.

| Элемент NX_IP_DRIVER     | Значение |
|-------------------------|-----------------------------------------------------|
| nx_ip_driver_command    | NX_LINK_GET_DUPLEX_TYPE |
| nx_ip_driver_ptr        | Указатель на экземпляр IP-адреса |
| nx_ip_driver_return_ptr | Указатель для размещения дуплексного типа |
| nx_ip_driver_interface  | Указатель на экземпляр интерфейса |
| nx_ip_driver_status     | Состояние завершения. Если драйвер не может получить сведения о дуплексном типе, он возвращает ненулевое состояние ошибки.
 |


> [!NOTE]
> *Этот запрос не используется внутри NetX, поэтому его реализация не является обязательной.*

### <a name="get-error-count"></a>Получение количества ошибок  

Этот запрос выполняется из службы ***nx_ip_driver_direct_command***. Драйвер сохраняет количество ошибок канала в указанном месте. Чтобы поддерживать эту функцию, драйвер должен отслеживать ошибки операций. Для запроса на получение количества ошибок канала используются указанные ниже элементы NX_IP_DRIVER.

| Элемент NX_IP_DRIVER     | Значение                                                                                                  |
|-------------------------|----------------------------------------------------------------------------------------------------------|
| nx_ip_driver_command    | NX_LINK_GET_ERROR_COUNT                                                                                  |
| nx_ip_driver_ptr        | Указатель на экземпляр IP-адреса                                                                                   |
| nx_ip_driver_return_ptr | Указатель для размещения количества ошибок                                                      |
| nx_ip_driver_interface  | Указатель на экземпляр интерфейса                                                                        |
| nx_ip_driver_status     | Состояние завершения. Если драйвер не может определить количество ошибок, он возвращает ненулевое состояние ошибки. |


> [!NOTE]
> *Этот запрос не используется внутри NetX, поэтому его реализация не является обязательной.*

### <a name="get-receive-packet-count"></a>Определение количества полученных пакетов  

Этот запрос выполняется из службы ***nx_ip_driver_direct_command***. Драйвер сохраняет количество полученных по каналу пакетов в указанном месте. Чтобы поддерживать эту функцию, драйвер должен отслеживать количество полученных пакетов. Для запроса на определение количества полученных по каналу пакетов используются указанные ниже элементы NX_IP_DRIVER.

| Элемент NX_IP_DRIVER     | Значение                                                                                                    |
|-------------------------|------------------------------------------------------------------------------------------------------------|
| nx_ip_driver_command    | NX_LINK_GET_RX_COUNT                                                                                       |
| nx_ip_driver_ptr        | Указатель на экземпляр IP-адреса                                                                                     |
| nx_ip_driver_return_ptr | Указатель для размещения количества полученных пакетов                                               |
| nx_ip_driver_interface  | Указатель на физический сетевой интерфейс                                                                  |
| nx_ip_driver_status     | Состояние завершения. Если драйвер не может определить количество полученных пакетов, он возвращает ненулевое состояние ошибки. |


> [!NOTE]
> *Этот запрос не используется внутри NetX, поэтому его реализация не является обязательной.*

### <a name="get-transmit-packet-count"></a>Определение количества переданных пакетов  

Этот запрос выполняется из службы ***nx_ip_driver_direct_command***. Драйвер сохраняет количество переданных по каналу пакетов в указанном месте. Для поддержки этой функции драйверу необходимо отслеживать каждый пакет, передаваемый через каждый интерфейс. Для запроса на получение количества переданных по каналу пакетов используются указанные ниже элементы NX_IP_DRIVER.

| Элемент NX_IP_DRIVER     | Значение                                                                                                     |
|-------------------------|-------------------------------------------------------------------------------------------------------------|
| nx_ip_driver_command    | NX_LINK_GET_TX_COUNT                                                                                        |
| nx_ip_driver_ptr        | Указатель на экземпляр IP-адреса                                                                                      |
| nx_ip_driver_return_ptr | Указатель для размещения количества переданных пакетов                                               |
| nx_ip_driver_interface  | Указатель на экземпляр интерфейса                                                                           |
| nx_ip_driver_status     | Состояние завершения. Если драйвер не может определить количество переданных пакетов, он возвращает ненулевое состояние ошибки. |


> [!NOTE]
> *Этот запрос не используется внутри NetX, поэтому его реализация не является обязательной.*

### <a name="get-allocation-errors"></a>Получение ошибок выделения  

Этот запрос выполняется из службы ***nx_ip_driver_direct_command***. Драйвер сохраняет количество ошибок выделения пула пакетов для канала в указанном месте. Для запроса на получение ошибок выделения для канала используются указанные ниже элементы NX_IP_DRIVER.

| **Элемент NX_IP_DRIVER** | **Значение** |
| --- | ---|
| nx_ip_driver_command | NX_LINK_GET_ALLOC_ERRORS |
| nx_ip_driver_ptr | Указатель на экземпляр IP-адреса |

| Элемент NX_IP_DRIVER     | Значение                                                                                                        |
|-------------------------|----------------------------------------------------------------------------------------------------------------|
| nx_ip_driver_return_ptr | Указатель для размещения количества ошибок выделения                                                 |
| nx_ip_driver_interface  | Указатель на экземпляр интерфейса                                                                              |
| nx_ip_driver_status     | Состояние завершения. Если драйвер не может определить количество ошибок выделения, он возвращает ненулевое состояние ошибки. |


*Этот запрос не используется внутри NetX, поэтому его реализация не является обязательной.*

### <a name="driver-deferred-processing"></a>Отложенная обработка драйвера  

Этот запрос выполняется из вспомогательного потока IP в ответ на вызов драйвером подпрограммы _ ***nx_ip_driver_deferred_processing*** из подпрограммы обработки прерываний (ISR) при передаче или получении. Это позволяет подпрограмме ISR драйвера распределять обработку операций по приему и передаче пакетов на вспомогательный поток IP, благодаря чему снижается нагрузка на эту подпрограмму. Драйвер может использовать поле *nx_interface_additional_link_info* в структуре NX_INTERFACE, на которую указывает *nx_ip_driver_interface*, для хранения сведений о событии отложенной обработки из контекста вспомогательного потока IP. Для события отложенной обработки используются указанные ниже элементы NX_IP_DRIVER.

**NX_IP_DRIVER**

| член                 | Значение                           |
|------------------------|-----------------------------------|
| nx_ip_driver_command   | NX_LINK_DEFERRED_PROCESSING       |
| nx_ip_driver_ptr       | Указатель на экземпляр IP-адреса            |
| nx_ip_driver_interface | Указатель на экземпляр интерфейса |


### <a name="user-commands"></a>Пользовательские команды  

Этот запрос выполняется из службы ***nx_ip_driver_direct_command***. Драйвер обрабатывает пользовательские команды, относящиеся к приложению. Для запроса на пользовательские команды используются указанные ниже элементы NX_IP_DRIVER.

| Элемент NX_IP_DRIVER     | Значение                                                                                                        |
|-------------------------|----------------------------------------------------------------------------------------------------------------|
| nx_ip_driver_command    | NX_LINK_USER_COMMAND                                                                                           |
| nx_ip_driver_ptr        | Указатель на экземпляр IP-адреса                                                                                         |
| nx_ip_driver_return_ptr | Определяется пользователем                                                                                                   |
| nx_ip_driver_interface  | Указатель на экземпляр интерфейса                                                                              |
| nx_ip_driver_status     | Состояние завершения. Если драйвер не может выполнить пользовательские команды, он возвращает ненулевое состояние ошибки. |


*Этот запрос не используется внутри NetX, поэтому его реализация не является обязательной.*

### <a name="unimplemented-commands"></a>Нереализованные команды  

Для команд, которые не реализуются сетевым драйвером, поле возвращаемого состояния должно иметь значение NX_UNHANDLED_COMMAND.

## <a name="driver-output"></a>Вывод данных драйвером  

Для всех вышеупомянутых запросов на передачу пакетов требуется выходная функция, реализованная в драйвере. Конкретная логика передачи зависит от оборудования, но обычно она включает в себя проверку возможностей аппаратного оборудования для немедленной отправки пакета. Если возможно, полезные данные пакета (и дополнительные полезные данные в цепочке пакетов) загружаются в один или несколько аппаратных буферов передачи, после чего инициируется операция передачи. Если пакет не помещается в доступные буферы передачи, его следует поставить в очередь и осуществить передачу, когда буферы станут доступны.

Рекомендуемая очередь передачи — это односвязный список, имеющий как головной, так и заключительный указатели. Новые пакеты добавляются в конец очереди, вымещая самый старый пакет вперед. Поле *nx_packet_queue_next* используется в качестве ссылки на следующий пакет в очереди. Драйвер определяет головной и заключительный указатели очереди передачи.

*Так как доступ к этой очереди осуществляется из частей драйвера, отвечающих за обработку потока и прерываний, к операциям очереди должна применяться защита от прерываний*.

Большинство аппаратных реализаций создают прерывание по завершении передачи пакета.
Когда драйвер получает такое прерывание, он обычно освобождает ресурсы, связанные с только что переданным пакетом. Если логика передачи считывает данные непосредственно из буфера NX_PACKET, драйвер должен использовать службу ***nx_packet_transmit_release***, чтобы вернуть пакет, связанный с прерыванием завершения передачи, в доступный пул пакетов. Затем драйвер проверяет очередь передачи на наличие дополнительных пакетов, ожидающих на отправку. Из очереди извлекается и загружается в буферы столько пакетов, сколько помещается в аппаратные буферы передачи. За этим следует инициация следующей операции отправки.

Как только данные в NX_PACKET перемещаются в передатчик FIFO (или, если драйвер поддерживает операцию нулевого копирования, как только данные в NX_PACKET передаются), драйвер должен переместить nx_packet_prepend_ptr в начало заголовка IP перед вызовом ***nx_packet_transmit_release.*** Не забудьте соответствующим образом настроить поле *nx_packet_length*. Если IP-кадр состоит из нескольких пакетов, необходимо освободить только головной элемент цепочки пакетов.

## <a name="driver-input"></a>Получение данных драйвером  

Приняв прерывание получения пакета, сетевой драйвер извлекает пакет из приемных буферов физического оборудования и создает допустимый пакет NetX. Формирование допустимого пакета NetX включает в себя настройку поля соответствующей длины и объединение нескольких пакетов в цепочку, если размер входящего пакета превышает размер полезных данных одного пакета. После правильного построения prepend_ptr перемещается на место после заголовка физического слоя и полученный пакет отправляется в NetX.

В NetX предполагается, что заголовки протоколов IP и ARP выравниваются по границе ULONG. Следовательно, драйвер NetX должен обеспечить такое выравнивание. В средах Ethernet это достигается за счет того, что заголовок Ethernet начинается через 2 байта от начала пакета. Когда *nx_packet_prepend_ptr* перемещается за пределы заголовка Ethernet, базовый заголовок IP или ARP выравнивается по границе 4 байта.

В NetX доступно несколько функций получения пакетов. Если полученный пакет является пакетом ARP, вызывается _***nx_arp_packet_deferred_receive**_. Если полученный пакет является пакетом RARP, вызывается _ _*_nx_rarp_packet_deferred_receive_*_. Существует несколько вариантов обработки получаемых IP-пакетов. Для максимально быстрой обработки IP-пакетов вызывается функция _ _*_nx_ip_packet_receive_*_. Этот подход имеет минимальные издержки, но оказывает более высокую нагрузку на подпрограмму обработки прерываний (ISR) драйвера. Для минимальной нагрузки на ISR вызывается __ *_nx_ip_packet_deferred_receive_**.

После того как новый пакет приема будет правильно сформирован, буферы приема физического оборудования подготавливаются к приему дополнительных данных. Для этого может потребоваться выделение пакетов NetX и размещение адреса полезных данных в аппаратном буфере приема или всего лишь изменение параметра в аппаратном буфере приема. Для снижения риска переполнения важно, чтобы буферы приема оборудования становились доступными как можно скорее после получения пакета.

*Исходные буферы приема настраиваются во время инициализации драйвера*.

### <a name="deferred-receive-packet-handling"></a>Отложенная обработка получаемых пакетов  

Драйвер может перекладывать обработку принимаемых пакетов на вспомогательный поток IP в NetX. В некоторых приложениях это может быть необходимо для снижения нагрузки на ISR и уменьшения количества отброшенных пакетов. Для использования отложенной обработки пакетов необходимо сначала скомпилировать библиотеку NetX с параметром ***NX_DRIVER_DEFERRED_PROCESSING** _. В результате логика отложенной обработки пакетов будет добавлена во вспомогательный поток IP NetX. Затем при получении пакета данных драйвер должен вызвать __nx_ip_packet_deferred_receive():*

```C
_nx_ip_packet_deferred_receive(ip_ptr, packet_ptr);
```

Функция отложенного приема помещает полученный пакет, представленный указателем *packet_ptr*, в связанный список FIFO и уведомляет вспомогательный поток IP. После выполнения вспомогательный поток IP многократно вызывает функцию отложенной обработки для обработки каждого отложенного пакета. Отложенная обработка обычно включает в себя удаление заголовка пакета физического уровня (обычно Ethernet) и отправку его в одну из следующих функций приема NetX.  

***_nx_ip_packet_deferred_receive***  
***_nx_arp_packet_deferred_receive***  
***_nx_rarp_packet_deferred_receive*** 


## <a name="example-ram-ethernet-network-driver"></a>Пример сетевого драйвера Ethernet в ОЗУ  

Демонстрационная система NetX поставляется с небольшим сетевым драйвером, работающим в ОЗУ. Он определяется в файле ***nx_ram_network_driver.c***.
В этом драйвере предполагается, что экземпляры IP находятся в одной сети и при их создании каждому экземпляру устройства просто назначаются виртуальные аппаратные адреса (MAC-адреса). Этот файл служит хорошим примером базовой структуры драйверов физической сети NetX. Пользователи могут разрабатывать собственные сетевые драйверы с помощью платформы драйверов, представленной в этом примере.

Функция входа сетевого драйвера — * **_nx_ram_network_driver,** _. Она передается в вызов создания экземпляра IP. Функции входа для дополнительных сетевых интерфейсов можно передать в службу _*_nx_ip_interface_attach_*_. После запуска экземпляра IP вызывается функция входа драйвера для инициализации и включения устройства (см. _ *NX_LINK_INITIALIZE** и **NX_LINK_ENABLE**). После выполнения команды **NX_LINK_ENABLE** устройство должно быть готово к передаче и получению пакетов. 

Экземпляр IP передает сетевые пакеты с помощью одной из следующих команд.

| ***NX_LINK_PACKET_SEND***    | Передается IP-пакет.                             |
| ------------------------------- | -------------------------------------------------------------- |
| ***NX_LINK_ARP_SEND***       | Передается пакет запроса или ответа ARP.    |
| ***NX_LINK_ARP_RARP_SEND*** | Передается пакет запроса или ответа RARP. |

При обработке этих команд сетевому драйверу необходимо добавить в начало соответствующий заголовок кадра Ethernet, а затем отправить его в базовое оборудование для передачи. В процессе передачи сетевой драйвер получает неограниченное право собственности на область буфера пакетов. Таким образом, после передачи данных (или их копирования во внутренний буфер передачи драйвера) сетевой драйвер должен освободить буфер пакетов, сначала переместив указатель prepend на место после заголовка Ethernet в заголовок IP (и изменив длину пакета соответствующим образом), а затем вызвав службу ***nx_packet_transmit_release***, чтобы освободить пакет. Если не освободить пакет после передачи данных, это приведет к утечке пакетов.

Драйвер сетевого устройства также отвечает за обработку принимаемых пакетов данных. В примере драйвера в ОЗУ полученный пакет обрабатывается функцией ***_nx_ram_network_driver_receive***.

Когда устройство получает кадр Ethernet, драйвер должен сохранить данные в

структуре NX_PACKET. Обратите внимание: в NetX предполагается, что заголовок IP начинается с адреса с выравниванием по границе 4 байта. Так как длина заголовка Ethernet равна 14 байтам, драйверу необходимо сохранить начало заголовка Ethernet по адресу с выравниванием по границе 2 байта. Это позволит гарантировать, что заголовок IP будет начинаться с адреса с выравниванием по границе 4 байта.