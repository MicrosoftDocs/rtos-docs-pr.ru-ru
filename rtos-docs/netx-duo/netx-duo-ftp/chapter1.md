---
title: Глава 1. Введение в NetX Duo FTP для ОСРВ Azure
description: Протокол File Transfer Protocol (FTP) предназначен для передачи файлов.
author: philmea
ms.author: philmea
ms.date: 07/14/2020
ms.topic: article
ms.service: rtos
ms.openlocfilehash: 1d56b20b1c7d719d1b7d9c8c5b2fe234d5577da3
ms.sourcegitcommit: e3d42e1f2920ec9cb002634b542bc20754f9544e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/22/2021
ms.locfileid: "104814711"
---
# <a name="chapter-1---introduction-to-azure-rtos-netx-duo-ftp"></a>Глава 1. Введение в NetX Duo FTP для ОСРВ Azure

Протокол File Transfer Protocol (FTP) предназначен для передачи файлов. Для выполнения своей функции передачи файлов протокол FTP использует службы TCP. Именно поэтому FTP является высоконадежным протоколом передачи файлов. FTP также характеризуется высокой производительностью. Фактический перенос файлов FTP выполняется по выделенному FTP-соединению. FTP в NetX Duo поддерживает сети IPv4 и IPv6. IPv6 не вносит прямых изменений в протокол FTP, но для его поддержки требуются некоторые изменения в исходном интерфейсе API FTP в NetX, которые будут описаны в этом документе.

## <a name="ftp-requirements"></a>Требования для FTP

Для правильной работы пакету FTP в NetX требуется NetX Duo. Ведущее приложение должно создать экземпляр IP для запуска служб NetX и периодических задач. Если ведущее приложение FTP запускается по сети IPv6, в задаче IP необходимо включить протоколы IPv6 и ICMPv6. Протокол TCP должен также быть включен для сетей IPv6 или IPv4. Ведущее приложение IPv6 должно использовать для настройки локального и глобального IPv6-адресов интерфейс API IPv6 и (или) DHCPv6. Этот процесс показан в демонстрационной программе в разделе "Пример небольшой системы" **главы 2**.

FTP-сервер и клиент также предназначены для работы со встроенной файловой системой FileX. Если система FileX недоступна, разработчик узла может реализовать собственную файловую систему в соответствии с рекомендациями в файле filex_stub.h, определив каждую из служб, указанных в этом файле. Этот процесс рассматривается в последующих разделах данного руководства.

Дополнительные требования для клиентской части FTP в пакете FTP NetX отсутствуют.

Для серверной части FTP в пакете FTP NetX существует ряд дополнительных требований. Во-первых, она требует полного доступа к *известному TCP-порту 21* для обработки всех запросов команд клиента FTP и к *хорошо известному порту 20* для обработки всех операций передачи данных клиента FTP.

## <a name="ftp-constraints"></a>Ограничения FTP

Стандарт FTP имеет множество параметров, касающихся представления данных файлов. В NetX FTP не реализованы такие параметры, как ls –al. FTP-сервер NetX принимает запросы и их аргументы в одном пакете, а не в виде последовательности пакетов.

Как и в случае с реализациями UNIX, для FTP NetX действуют следующие ограничения формата файлов.

- Тип файла: **двоичный**
- Формат файла: **только непечатаемый**
- Структура файла: **только структура файлов**

## <a name="ftp-file-names"></a>Имена файлов FTP

Имена файлов FTP должны иметь формат целевой файловой системы (обычно FileX). Они должны быть строками символов ASCII с завершающим нулем и сведениями о полном пути, если это необходимо. В реализации FTP NetX ограничение на размер имен файлов FTP отсутствует. Однако размер полезных данных пула пакетов должен поддерживать максимальное значение пути и (или) имени файла.

## <a name="ftp-client-commands"></a>Команды клиента FTP

В FTP доступен простой механизм для открытия подключений и выполнения операций с файлами и каталогами. По сути, существует набор стандартных команд FTP, выдаваемых клиентом после успешной установки подключения на *известном TCP-порту 21*. Ниже приведены некоторые основные команды FTP. Обратите внимание, что единственным отличием при выполнении FTP через IPv6 является то, что команда PORT заменяется командой EPRT.

- CWD path: *изменение рабочего каталога*
- DELE filename: *удаление указанного имени файла*
- EPRT ip_address,port: *указание IPv6-адреса и порта данных клиента*
- EPSV: *запрос пассивного режима передачи для IPv6*
- LIST directory: *получение списка каталогов*
- MKD directory: *создание каталога*
- MKD directory: *получение списка каталогов*
- NOOP: *нет операции, успешное выполнение*
- PASS password: *ввод пароля для входа*
- PASV: *запрос пассивного режима передачи для IPv4*
- PORT ip_address,port: *указание IP-адреса и порта данных клиента*
- PWD path: *выбор текущего пути к каталогу*
- QUIT: *завершение подключения клиента*
- RETR filename: *чтение указанного файла*
- RMD directory: *удаление указанного каталога*
- RNFR oldfilename: *указание файла для переименования*
- RNTO newfilename: *изменение имени файла на указанное*
- STOR filename: *запись указанного файла*
- TYPE I: *выбор образа двоичного файла*
- USER username: *указание имени пользователя для входа*

Эти команды ASCII используются программным обеспечением клиента FTP NetX внутренним образом для выполнения операций FTP с FTP-сервером.

## <a name="ftp-server-responses"></a>Ответы FTP-сервера

После того как FTP-сервер обрабатывает запрос клиента, он возвращает трехзначный закодированный ответ в ASCII, за которым следует необязательный текст ASCII. Программное обеспечение клиента использует числовой ответ для определения успешного выполнения операции или ее сбоя. Ниже перечислены различные ответы FTP-сервера на запросы клиента.

**Первое числовое поле и значение**

- 1xx: *положительное предварительное состояние, дождитесь следующего ответа*.
- 2xx: *положительное состояние завершения*.
- 3xx: *положительное предварительное состояние, должна быть отправлена другая команда*.
- 4xx: *временная ошибка*.
- 5xx: *ошибка*.

**Второе числовое поле и значение**

- x0x: *синтаксическая ошибка в команде*.
- x1x: *информационное сообщение*.
- x2x: *связано с подключением*.
- x3x: *связано с проверкой подлинности*.
- x4x: *не указано*.
- x5x: *связано с файловой системой*.

Например, на запрос клиента на завершение FTP-подключения с помощью команды QUIT сервер обычно дает ответ с кодом 221, означающим успешное отключение.

## <a name="ftp-passive-transfer-mode"></a>Пассивный режим передачи FTP

По умолчанию клиент FTP NetX Duo использует активный режим передачи для обмена данными через сокет данных с FTP-сервером. Проблема этой схемы заключается в том, что для подключения FTP-сервера клиент FTP должен открыть сокет TCP-сервера. Такая ситуация представляет потенциальную угрозу безопасности, поэтому эта возможность может быть заблокирована брандмауэром клиента. Пассивный режим передачи отличается от активного тем, что FTP-сервер создает сокет TCP-сервера при подключении к данным. В этом случае риск безопасности отсутствует (для клиента FTP).

Чтобы включить пассивную передачу данных, приложение вызывает *nx_ftp_client_passive_mode_set* в ранее созданном клиенте FTP со вторым аргументом, имеющим значение NX_TRUE. После этого все последующие службы клиента FTP NetX Duo для передачи данных (NLST, RETR, STOR) выполняются в пассивном режиме передачи.

Клиент FTP сначала отправляет пассивную команду (без аргументов): PASV для IPv4 или EPSV для IPv6. Если FTP-сервер поддерживает такой запрос, он вернет ответ 227 (OK) для PASV или 229 (OK) для EPSV. Затем клиент отправляет запрос, например RETR. Если сервер отклоняет пассивный режим передачи, служба клиента FTP NetX Duo возвращает состояние ошибки.

Чтобы отключить пассивный режим передачи и вернуться в активный режим, приложение вызывает *nx_ftp_client_passive_mode_set* со вторым аргументом, имеющим значение NX_FALSE.

## <a name="ftp-communication"></a>Взаимодействие по FTP

Для обработки запросов клиента FTP-сервер использует *известный TCP-порт 21*. Клиенты FTP могут использовать любой доступный TCP-порт. Общая последовательность событий FTP выглядит следующим образом.

**Запросы FTP на чтение файлов**

1. Клиент отправляет запрос на подключение к TCP-порту 21 сервера.
1. Сервер отправляет ответ 220, информирующий об успешном выполнении.
1. Клиент отправляет сообщение USER с username.
1. Сервер отправляет ответ 331, информирующий об успешном выполнении.
1. Клиент отправляет сообщение PASS с password.
1. Сервер отправляет ответ 230, информирующий об успешном выполнении.
1. Клиент отправляет сообщение TYPE I для передачи двоичных данных.
1. Сервер отправляет ответ 200, информирующий об успешном выполнении.
1. *Приложения IPv4*: клиент отправляет сообщение PORT с IP-адресом и портом.<br />*Приложения IPv6*: клиент отправляет сообщение EPRT с IP-адресом и портом.
1. Сервер отправляет ответ 200, информирующий об успешном выполнении.
1. Клиент отправляет сообщение RETR с именем файла для чтения.
1. Сервер создает сокет данных и подключается к порту данных клиента, указанному в команде PORT.
1. Сервер отправляет ответ 125, информирующий о начале чтения файла.
1. Сервер отправляет содержимое файла через подключение к данным. Этот процесс продолжается до полной передачи файла.
1. По завершении сервер разрывает подключение к данным.
1. Сервер отправляет ответ 250, информирующий об успешном чтении файла.
1. Клиент отправляет сообщение QUIT для завершения FTP-подключения.
1. Сервер отправляет ответ 221, информирующий об успешном отключении.
1. Сервер разрывает FTP-подключение.

Как упоминалось ранее, единственное различие между выполнением FTP через IPv4 и

IPv6 в том, что команда PORT заменяется командой EPRT для IPv6.

Если клиент FTP отправляет запрос на чтение в пассивном режиме передачи, последовательность команд выглядит указанным ниже образом (строки, выделенные **полужирным шрифтом**, означают действие, отличное от действия в активном режиме передачи).

1. Клиент отправляет запрос на подключение к TCP-порту 21 сервера.
1. Сервер отправляет ответ 220, информирующий об успешном выполнении.
1. Клиент отправляет сообщение USER с username.
1. Сервер отправляет ответ 331, информирующий об успешном выполнении.
1. Клиент отправляет сообщение PASS с password.
1. Сервер отправляет ответ 230, информирующий об успешном выполнении.
1. Клиент отправляет сообщение TYPE I для передачи двоичных данных.
1. Сервер отправляет ответ 200, информирующий об успешном выполнении.
1. ***Приложения IPv4:* клиент отправляет сообщение PASV.**<br />**_Приложения IPv6:_ клиент отправляет сообщение EPSV.**
1. ***Приложения IPv4:* сервер отправляет ответ 227 с IP-адресом и портом для подключения клиента, информирующий об успешном выполнении.**<br />**_Приложения IPv6:_ сервер отправляет ответ 229 с IP-адресом и портом для подключения клиента, информирующий об успешном выполнении.**
1. Клиент отправляет сообщение RETR с именем файла для чтения.
1. **Сервер создает сокет сервера данных и прослушивает на нем запрос на подключение клиента, используя порт, указанный в ответе в шаге 10.**
1. **Сервер отправляет ответ 150 на контрольный сокет, информирующий о начале чтения файла.**
1. Сервер отправляет содержимое файла через подключение к данным. Этот процесс продолжается до полной передачи файла.
1. По завершении сервер разрывает подключение к данным.
1. **Сервер отправляет ответ 226 на контрольный сокет, информирующий об успешном чтении файла.**
1. Клиент отправляет сообщение QUIT для завершения FTP-подключения.
1. Сервер отправляет ответ 221, информирующий об успешном отключении.
1. Сервер разрывает FTP-подключение.

**Запросы FTP на запись**

1. Клиент отправляет запрос на подключение к TCP-порту 21 сервера.
1. Сервер отправляет ответ 220, информирующий об успешном выполнении.
1. Клиент отправляет сообщение USER с username.
1. Сервер отправляет ответ 331, информирующий об успешном выполнении.
1. Клиент отправляет сообщение PASS с password.
1. Сервер отправляет ответ 230, информирующий об успешном выполнении.
1. Клиент отправляет сообщение TYPE I для передачи двоичных данных.
1. Сервер отправляет ответ 200, информирующий об успешном выполнении.
1. *Приложения IPv4*: клиент отправляет сообщение PORT с IP-адресом и портом.<br />*Приложения IPv6*: клиент отправляет сообщение EPRT с IP-адресом и портом.
1. Сервер отправляет ответ 200, информирующий об успешном выполнении.
1. Клиент отправляет сообщение STOR с именем файла для записи.
1. Сервер создает сокет данных и подключается к порту данных клиента, указанному в предыдущей команде EPRT или PORT.
1. Сервер отправляет ответ 125, информирующий о начале записи файла.
1. Клиент отправляет содержимое файла через подключение к данным. Этот процесс продолжается до полной передачи файла.
1. По завершении клиент разрывает подключение к данным.
1. Сервер отправляет ответ 250, информирующий об успешном выполнении записи файла.
1. Клиент отправляет сообщение QUIT для завершения FTP-подключения.
1. Сервер отправляет ответ 221, информирующий об успешном отключении.
1. Сервер разрывает FTP-подключение.

Если клиент FTP отправляет запрос на запись в пассивном режиме передачи, последовательность команд выглядит указанным ниже образом (строки, выделенные **полужирным шрифтом**, означают действие, отличное от действия в активном режиме передачи).

1. Клиент отправляет запрос на подключение к TCP-порту 21 сервера.
1. Сервер отправляет ответ 220, информирующий об успешном выполнении.
1. Клиент отправляет сообщение USER с username.
1. Сервер отправляет ответ 331, информирующий об успешном выполнении.
1. Клиент отправляет сообщение PASS с password.
1. Сервер отправляет ответ 230, информирующий об успешном выполнении.
1. Клиент отправляет сообщение TYPE I для передачи двоичных данных.
1. Сервер отправляет ответ 200, информирующий об успешном выполнении.
1. ***Приложения IPv4:* клиент отправляет сообщение PASV.**<br />**_Приложения IPv6:_ клиент отправляет сообщение EPSV.**
1. ***Приложения IPv4:* сервер отправляет ответ 227 с IP-адресом и портом для подключения клиента, информирующий об успешном выполнении.**<br />**_Приложения IPv6:_ сервер отправляет ответ 229 с IP-адресом и портом для подключения клиента, информирующий об успешном выполнении.**
1. Клиент отправляет сообщение STOR с именем файла для записи.
1. **Сервер создает сокет сервера данных и прослушивает на нем запрос на подключение клиента, используя порт, указанный в ответе в шаге 10.**
1. **Сервер отправляет ответ 150 на контрольный сокет, информирующий о начале записи файла.**
1. Клиент отправляет содержимое файла через подключение к данным. Этот процесс продолжается до полной передачи файла.
1. По завершении клиент разрывает подключение к данным.
1. **Сервер отправляет ответ 226 на контрольный сокет, информирующий об успешной записи файла.**
1. Клиент отправляет сообщение QUIT для завершения FTP-подключения.
1. Сервер отправляет ответ 221, информирующий об успешном отключении.
1. Сервер разрывает FTP-подключение.

## <a name="ftp-authentication"></a>FTP Authentication

При каждом FTP-подключении клиент должен предоставить серверу *имя пользователя* и *пароль*. Некоторые FTP-сайты поддерживают так называемый *анонимный доступ к FTP*, который разрешает доступ к FTP без определенного имени пользователя и пароля. Для этого типа подключения в качестве имени пользователя должно быть указано anonymous, а пароль должен быть полным адресом электронной почты.

Пользователь несет ответственность за предоставление FTP NetX подпрограмм проверки подлинности входа и выхода. Они предоставляются во время вызова служб ***nxd_ftp_server_create** _ и _*_nx_ftp_server_create_*_ и вызываются при обработке паролей. Различие между ними заключается в том, что входные указатели функции _*_nxd_ftp_server_create_*_ на функции входа и выхода из системы принимают тип адреса NetX Duo _*_NXD_ADDRESS_*_. Этот тип данных может содержать адрес в формате IPv4 или IPv6, что делает данную функцию универсальной, поддерживающей как сети IPv4, так и сети IPv6. Входные указатели функции _ *_nx_ftp_server_create_** на функции входа и выхода из системы принимают тип IP-адреса ULONG. Эта функция ограничена сетями IPv4. Разработчикам рекомендуется использовать универсальную службу везде, где это возможно.

Если функция *входа в систему* возвращает NX_SUCCESS, значит, подключение прошло проверку подлинности и операции FTP разрешены. В противном случае, если функция *входа в систему* возвращает нечто, отличное от NX_SUCCESS, попытка подключения отклоняется.

## <a name="ftp-multi-thread-support"></a>Поддержка нескольких потоков FTP

Службы клиента FTP NetX можно вызывать из нескольких потоков одновременно. Однако запросы на чтение или запись для конкретного экземпляра клиента FTP должны выполняться последовательно из одного потока.

## <a name="ftp-rfcs"></a>Стандарты RFC для протокола FTP

Протокол FTP в NetX Duo совместим с RFC 959, RFC 2428 и связанными стандартами RFC.
