---
title: Глава 1. Общие сведения о DHCPv6-сервере NetX Duo для ОСРВ Azure
description: В этом документе подробно описано, как DHCPv6-сервер NetX Duo назначает IPv6-адреса клиентам DHCPv6.
author: philmea
ms.author: philmea
ms.date: 06/08/2020
ms.topic: article
ms.service: rtos
ms.openlocfilehash: 6cf7baa91b1804876b97b1d75d1872d1120ad028
ms.sourcegitcommit: e3d42e1f2920ec9cb002634b542bc20754f9544e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/22/2021
ms.locfileid: "104814748"
---
# <a name="chapter-1---introduction-to-azure-rtos-netx-duo-dhcpv6-server"></a>Глава 1. Общие сведения о DHCPv6-сервере NetX Duo для ОСРВ Azure

В сетях IPv6 для получения IPv6-адресов клиентами требуется протокол DHCPv6. Он не заменяет протокол DHCP, так как не может предоставлять IPv4-адреса. Протокол DHCPv6 схож с DHCP по своему функционалу, но имеет множество улучшений. Клиент, который не может использовать или не использует автоматическую настройку IPv6-адресов без отслеживания состояния, может использовать DHCPv6 для получения уникального глобального IPv6-адреса с DHCPv6-сервера.

NetX Duo изначально поддерживает приложения и сетевые протоколы на основе IPv6, такие как DHCPv6. В этом документе подробно описано, как DHCPv6-сервер NetX Duo назначает IPv6-адреса клиентам DHCPv6.

## <a name="dhcpv6-communication"></a>Обмен данными по протоколу DHCPv6

**Структура сообщения DHCPv6**

Сообщение в основе своей состоит из заголовка, за которым следует один блок параметров или, как правило, несколько. Ниже приведена базовая структура, в которой каждый блок представляет один байт.

![Схема сообщения DHCPv6 и структуры блока параметров.](media/image2.jpg)

**Рис. 1. Сообщение DHCPv6 и структура блока параметров**

Однобайтовое поле Msg-Type указывает тип сообщения DHCPv6. Значение трехбайтового поля Transaction-ID задается клиентом. Это может быть любая последовательность символов, но она должна быть уникальной для каждого сообщения от клиента серверу (при отправке повторяющихся сообщений клиентом она сохраняется). Сервер использует поле Transaction-ID в каждом ответе клиенту, чтобы тот мог сопоставлять сообщения от сервера в случае задержки или потери пакетов в сети. За полем Transaction-ID следует один параметр DHCPv6 или несколько, которые указывают, что запрашивает клиент.

Структура параметра DHCPv6 состоит из кода параметра, поля длины параметра (длина полей кодов не учитывается) и, наконец, самих данных параметра, которые представляют собой одно двухбайтовое поле кодов параметров для данных, запрашиваемых клиентом, или несколько.

Некоторые блоки параметров имеют вложенные параметры. Например, параметр *Ассоциация удостоверений для невременных адресов (IANA)* содержит один параметр *Ассоциация удостоверений (IA)* или несколько для запроса IPv6-адресов. Параметр *IANA*, возвращаемый в ответном сообщении сервера, содержит те же параметры *IA* с предоставленным сервером IPv6-адресом и сроком аренды, а также параметр *состояния*, указывающий на наличие ошибки при выполнении запроса адреса от клиента.

Список всех блоков параметров и их описание приводится в **приложении А**.

**Типы сообщений DHCPv6**

Хотя протокол DHCPv6 значительно расширяет функциональные возможности DHCP, в нем предусмотрено то же количество сообщений, что и в DHCP, и поддерживает он те же параметры поставщика. Список сообщений DHCPv6

- SOLICIT (1) (отправляется клиентом)
- ADVERTISE (2) (отправляется сервером)
- REQUEST (3) (отправляется клиентом)
- REPLY (7) (отправляется сервером)
- CONFIRM (4) (отправляется клиентом)
- RENEW (5) (отправляется клиентом)
- REBIND (6) (отправляется клиентом)
- RELEASE (8) (отправляется клиентом)
- DECLINE (9) (отправляется клиентом)
- INFORM_REQUEST (11) (отправляется клиентом)
- RECONFIGURE* (10) (отправляется сервером)

*Сообщение RECONFIGURE не поддерживается DHCPv6-сервером NetX Duo.

Базовая последовательность DHCPv6-запросов выглядит следующим образом (в скобках приводятся эквивалентные типы сообщений DHCPv4).

Клиент ***Solicit** _ (_Discovery *) Сервер **Advertisement** (* Offer *) Клиент **Request** (* Request *) Сервер **Reply** (* DHCPAck*)

Клиент **Renew**(same) Сервер **Reply** (*DHCPAck*)

## <a name="dhcpv6-message-validation"></a>Проверка сообщения DHCPv6

Идентификатор транзакции: клиент должен создавать идентификатор транзакции для каждого сообщения, отправляемого на сервер. DHCPv6-сервер отклоняет любое сообщение от клиента, не совпадающее с этим идентификатором. Сервер, в свою очередь, должен использовать тот же идентификатор транзакции в ответах клиенту.

**Уникальные идентификаторы (DUID) DHCPv6**

Все сообщения от сервера должны также включать в себя уникальный идентификатор DHCPv6 (DUID), иначе клиент DHCPv6 не примет их. Идентификатор DUID канального уровня (LL) — это блок управления, содержащий MAC-адрес клиента, тип оборудования и тип DUID. Идентификатор DUID времени канального уровня (LLT) также содержит поле времени, которое снижает вероятность того, что идентификатор DUID не будет уникальным в сети узла. По этой причине стандарт RFC 3315 рекомендует использовать идентификаторы DUID типа LLT, а не LL. Если ведущее приложение не создает собственное уникальное значение времени, компонент DHCPv6 NetX Duo предоставит значение по умолчанию. Третьим типом идентификатора DUID является DUID предприятия (назначаемый поставщиком). Он содержит идентификатор предприятия, зарегистрированный в IANA, и частные данные, которые могут различаться по типу и длине, например в зависимости от размера памяти, типа операционной системы и конфигурации оборудования. Сведения о настройке назначаемых поставщиком сервера и частных значений идентификатора см. в списке параметров конфигурации далее в этом документе.

Клиент также должен включать свой идентификатор DUID в сообщения серверу (за исключением INFORM_REQUEST), иначе сервер отклонит их.

**Сеансы "клиент — сервер" DHCPv6**

Клиенты и серверы DHCPv6 обмениваются сообщениями по протоколу UDP. Клиент использует порт 546 для отправки и получения сообщений DHCPv6, а сервер использует порт 547. Изначально клиент использует локальный адрес канала для передачи и получения сообщений DHCPv6. Он отправляет все сообщения на DHCPv6-серверы, используя зарезервированный адрес многоадресного взаимодействия канального уровня, известный как адрес многоадресного взаимодействия *All_DHCP_Relay_Agents_and_Servers* *(FF02::01:02)* .

Для обработки запросов на назначение IPv6-адресов DHCPv6-сервер прослушивает сообщения *SOLICIT*, отправляемые по адресу *All_DHCP_Relay_Agents_and_Servers*. В запросе *SOLICIT* клиент может запросить назначение конкретного IPv6-адреса или дать серверу возможность выбрать адрес. Он также может запросить другие сведения о конфигурации сети с сервера.

Если DHCPv6-сервер получает допустимое сообщение *SOLICIT* и может назначить клиенту IPv6-адрес, он отвечает сообщением *ADVERTISE*. Оно содержит IPv6-адрес, который будет предоставлен клиенту, срок аренды IPv6-адреса и дополнительные сведения, запрошенные клиентом. Если клиент принимает предложение сервера, он отправляет в ответ сообщение *REQUEST*, уведомляя тем самым сервер о принятии IPv6-адреса. Сервер подтверждает привязку клиента к IPv6-адресу с помощью сообщения *REPLY*.

Если сообщение клиента DHCPv6 недопустимо, сервер отклоняет его без уведомления. Если сервер не может предоставить адрес, он отправляет сообщение *REPLY* с указанием проблемы в поле состояния параметра IANA IP-адреса. При получении повторяющихся запросов от клиента сервер повторно отправляет предыдущий ответ DHCPv6, предполагая, что клиент просто не получил пакет.

Клиент должен проверить, что IPv6-адрес, назначаемый сервером, не назначен другому узлу в системе. Для этого он использует различные протоколы IPv6, например протокол обнаружения дублирующихся адресов (DAD). Если адрес не уникален, клиент отправляет серверу сообщение *DECLINE*. На основе этих сведений сервер обновляет свою таблицу аренды IP-адресов, регистрируя адрес как назначенный. Тем временем клиент должен начать процесс запроса DHCPv6 заново с помощью еще одного сообщения *SOLICIT*.

Помимо IPv6-адреса, клиенту, скорее всего, также потребуются сведения о DNS-сервере и другие сведения о сети, например доменное имя сети. Протокол DHCPv6 дает возможность запрашивать эти сведения с помощью запросов параметров в сообщениях *SOLICIT* и *REQUEST* или отдельно в сообщениях *запроса информации*. Параметры DHCPv6 описываются далее в этой главе.

**Срок аренды IPv6-адреса**

Когда сервер предоставляет клиенту IPv6-адрес, он также назначает срок его аренды (время существования) в параметре IANA. По истечении этого срока клиенту рекомендуется начать продление (T1) или повторную привязку (T2) IPv6-адреса с помощью сообщений *RENEW* и *REBIND*. Различие между ними заключается в том, что клиент направляет сообщение *RENEW* серверу, включая в запрос *RENEW* идентификатор DUID сервера. Однако в сообщении *REBIND* на адрес *All_DHCP_Relay_Agents_and_Servers* конкретный сервер не указывается и, следовательно, не включается идентификатор DUID сервера. Параметр IA, который содержит фактический IPv6-адрес, предоставляемый сервером клиенту, также содержит предпочтительное и допустимое время существования, когда арендуемый IPv6-адрес станет нерекомендуемым или устаревшим (недопустимым).

DHCPv6-сервер NetX Duo сохраняет время ожидания сеанса для каждого клиента, чтобы отслеживать время между сообщениями от него. Это необходимо на случай потери подключения узлом клиента или отказа сети. По истечении времени ожидания сеанса предполагается, что клиент больше не планирует или не может выполнять DHCPv6-запросы к серверу. Сервер удаляет запись клиента и возвращает все предварительно назначенные IPv6-адреса обратно в доступный пул. Время ожидания сеанса — это настраиваемый пользователем параметр.

Если клиент хочет освободить свой IPv6-адрес или обнаруживает, что IPv6-адрес, назначенный ему DHCPv6-сервером, уже используется, он отправляет сообщение *RELEASE* или *DECLINE* соответственно. В случае сообщения *RELEASE* сервер возвращает IPv6-адрес обратно в доступный пул. В случае сообщения *DECLINE* он обновляет свою таблицу аренды IP-адресов, чтобы указать, что этот IPv6-адрес недоступен (принадлежит другому объекту в сети).

**Аренда IPv6-адреса и данные записи клиента**

Когда DHCPv6-сервер начинает принимать запросы клиентов, он ведет список активных клиентов, которые запрашивают или получили IPv6-адреса. Сервер проверяет срок аренды IP-адреса с помощью таймера аренды, который периодически обновляет длительность аренды клиента. Если длительность превышает допустимое время существования, сервер очищает запись клиента и возвращает его IPv6-адрес в доступный пул. Клиент должен начать процесс продления или повторной привязки до того, как это произойдет.

Таблица записей клиента на DHCPv6-сервере NetX Duo содержит сведения для идентификации клиентов, а также сведения о состоянии для проверки клиентских DHCPv6-запросов и назначения или повторного назначения IPv6-адресов. Эти сведения включают в себя следующее.

- Уникальный идентификатор DHCPv6 (DUID) клиента, который уникальным образом определяет каждый узел клиента в сети. Клиент должен использовать этот идентификатор DUID во всех сообщениях DHCPv6.

- Ассоциация удостоверений для невременных адресов (IANA) и IPv6-адрес ассоциации удостоверений (IA) клиента вместе определяют параметры назначения IPv6-адреса клиенту.

- Запросы параметров клиента (DNS-сервер, доменное имя и т. д.).

- Исходный IPv6-адрес клиента (если задан) и адрес назначения (если не является многоадресным) последнего DHCPv6-запроса.

- Тип последнего сообщения клиента и состояние DHCPv6.

## <a name="netx-duo-dhcpv6-server-requirements-and-constraints"></a>Требования и ограничения для DHCPv6-сервера NetX Duo

Для использования интерфейса API DHCPv6-сервера NetX Duo требуется ThreadX 5.1 или более поздней версии и NetX Duo 5.5 или более поздней версии.

**Требования**

***Настройка задачи потока IP***

DHCPv6-сервер NetX Duo требует создания экземпляра IP для отправки и получения сообщений DHCPv6 по сетевому каналу. Это выполняется с помощью службы *nx_ip_create*. Должен быть создан сам DHCPv6-сервер NetX Duo. Это выполняется с помощью службы *nx_dhcpv6_server_create*.

Компонент DHCPv6 использует протоколы NetX Duo, ICMPv6 и UDP. Поэтому прежде чем использовать DHCPv6-сервер, необходимо включить IPv6, вызвав следующие службы NetX Duo.

- *nx_udp_enable*
- *nxd_ipv6_enable*
- *nxd_icmp_enable*

Кроме того, перед запуском DHCPv6-сервера нужно выполнить ряд задач по настройке.

- Создание и проверка локального канального и глобального IPv6-адресов. Проверка адресов выполняется NetX Duo автоматически с помощью обнаружения повторяющихся адресов, если оно включено. Подробные сведения о проверке локальных канальных и глобальных IP-адресов см. в *руководстве пользователя NetX Duo*.

- Задание индекса сетевого интерфейса для интерфейса DHCPv6.

- Создание диапазона IP-адресов для назначаемых IPv6-адресов. Если остались данные от предыдущего сеанса DHCPv6-сервера, то таблицу аренды IPv6-адресов и записи клиентов из этого сеанса необходимо передать из энергонезависимой памяти на DHCPv6-сервер. В примере небольшой системы далее в этом документе будут продемонстрированы службы DHCPv6-сервера для выполнения этого требования.

- Задание идентификатора DUID сервера. Если сервер создал идентификатор DUID в предыдущем сеансе, он должен использовать те же данные для создания того же DUID для сообщений клиентам. В примере небольшой системы далее в этом документе будет показано, как выполняется это требование.

На этом этапе DHCPv6-сервер готов к запуску. На внутреннем уровне DHCPv6-сервер NetX Duo создаст сокет UDP, привязанный к порту 547, и начнет прослушивание запросов клиентов.

***Требования к пулу пакетов***

Для отправки сообщений DHCPv6 DHCPv6-сервером NetX Duo требуется пул пакетов. Пользователь может настроить размер этого пула пакетов, указав размер полезных данных и количество доступных пакетов, с учетом ожидаемого объема сообщений DHCPv6 и других данных, которые будут отправляться ведущим приложением.

Типичное сообщение DHCPv6 имеет размер около 200–300 байт в зависимости от числа дополнительных параметров, запрошенных клиентом, и сведений, доступных на сервере.

***Настройка интерфейса DHCPv6-сервера***

По умолчанию DHCPv6-сервер принимает запросы от клиентов через основной сетевой интерфейс. Однако ведущее приложение по-прежнему должно задавать индекс глобального адреса, который использовался для создания глобального адреса сервера. Индекс интерфейса DHCPv6 и индекс глобального адреса задаются с помощью службы *nx_dhcpv6_server_interface_set*. Это также продемонстрировано в примере небольшой системы в этом документе.

***Сохранение интерфейса DUID DHCPv6 между перезагрузками сервера***

Протокол DHCPv6 требует, чтобы сервер использовал один и тот же DUID между перезагрузками. Для выполнения этого требования все данные, использовавшиеся для создания DUID, должны храниться в энергонезависимой памяти. Для узлов, использующих идентификаторы DUID канального уровня со временем, для которых требуется доступ к часам в реальном времени, ведущее приложение DHCPv6 NetX Duo должно иметь доступ к данным в реальном времени для генерации значения времени при создании первого идентификатора DUID сервера и сохранять эти данные для повторного использования в последующих сеансах сервера. Затем служба *nx_dhcpv6_set_server_duid* принимает в качестве аргументов данные DUID, а также параметры конфигурации в зависимости от типа DUID, чтобы создать (или воспроизвести) собственный идентификатор DUID.

***Создание списка назначаемых IPv6-адресов***

После создания DHCPv6-сервера его ведущее приложение должно создать диапазон назначаемых глобальных IPv6-адресов, если нет ранее сохраненного списка адресов. Это делается с помощью службы *nx_dhcpv6_create_ip_address_range*, которая принимает в качестве входных данных начальный и конечный IPv6-адреса.

***Сохранение сведений о назначаемых DHCPv6-адресах и клиентах***

Протокол DHCPv6 требует, чтобы DHCPv6-сервер сохранял сведения о клиентах и IPv6-адресах в энергонезависимой памяти на случай перезагрузки сервера. DHCPv6-сервер NetX Duo имеет несколько интерфейсов API для передачи и скачивания сведений о клиентах и IPv6-адресах.

*nx_dhcpv6_add_client_record*

*nx_dhcpv6_add_ip_address_lease*

*nx_dhcpv6_retrieve_client_record*

*nx_dhcpv6_retrieve_ip_address_lease*

Отправлять данные на сервер необходимо перед его перезагрузкой. Скачивать данные следует только после того, как DHCPv6-сервер остановлен (или приостановлен). Соответствующие службы подробно описаны далее в этом документе. Однако компонент DHCPv6 NetX Duo не определяет способ доступа к энергонезависимому хранилищу. За это отвечает ведущее приложение. Данная операция демонстрируется в примере небольшой системы.

***Уникальный идентификатор DHCP-сервера (DUID)***

Идентификатор DUID сервера однозначно определяет узел DHCPv6-сервера в сети. Если сервер ранее не создал свой идентификатор DUID, он может сделать это с помощью *nx_dhcpv6_server_set_duid*. Согласно стандарту RFC 3315, DHCPv6-сервер должен сохранить этот идентификатор DUID в энергонезависимой памяти, чтобы его можно было получить после перезагрузки сервера. DHCPv6-сервер поддерживает следующие типы DUID: канального уровня, канального уровня со временем и предприятия (назначенный поставщиком). Обратите внимание, что клиент должен напрямую отправлять идентификатор DUID от поставщика. Параметр DUID поставщика (17) не поддерживается напрямую DHPv6-сервером NetX Duo.

Ведущее приложение DHCPv6-сервера имеет значения по умолчанию для назначения IPv6-адресов, включая срок аренды. Сведения о настройке этих параметров см. в разделе "Настраиваемые параметры" далее в этом документе. :

Блок управления *IANA* содержит поля T1 и T2. Блок *IA* в блоке управления *IANA* содержит поля предпочтительного и допустимого времени существования. Ведущее приложение имеет настраиваемые параметры для настройки этих параметров. Они определены далее в этом документе. Эти параметры назначаются всем клиентским запросам IPv6-адресов.

Параметры DHCPv6 для аренды IP-адресов определены ниже.

T1 — время в секундах, когда клиент должен начать продление IPv6-адреса на сервере, который его назначил.

T2 — время в секундах, когда клиент должен начать повторную привязку IPv6-адреса, если продление завершилось сбоем, по каналу связи с любым сервером.

Предпочтительное время существования — время в секундах, когда адрес клиента становится нерекомендуемым, если клиент не продлил или не привязал его повторно. Клиент по-прежнему может использовать этот адрес.

Допустимое время существования — время в секундах, когда срок действия IP-адреса клиента истекает. Клиент не должен использовать такой адрес в сообщениях.

В стандарте RFC рекомендуется использовать значения T1 и T2, равные 0,5 и 0,8 соответственно, в качестве предпочтительного времени существования в параметре *IANA* клиента. Если сервер не имеет предпочтений, он должен установить эти значения равными нулю. Если в ответе сервера содержатся значения T1 и T2, равные нулю, клиент может установить собственные значения T1 и T2.

**Ограничения**

DHCPv6-сервер NetX Duo не поддерживает следующие параметры протокола DHCPv6.

  - Параметр быстрой фиксации, который оптимизирует процесс запроса адреса DHCPv6, сводя его к обмену сообщениями SOLICIT и REPLY.

  - Параметр повторной настройки, позволяющий серверу инициировать изменение состояния IP-адреса клиента.

  - Параметр одноадресной рассылки. Все клиентские сообщения должны отправляться на адрес многоадресного взаимодействия *All_DHCP_Relay_Agents_and_Servers*, а не на DHCPv6-сервер напрямую.

  - Параметр ассоциации удостоверений для временных адресов (IA_TA), который представляет временный IP-адрес, предоставляемый клиенту.

  - Несколько параметров IA (IPv6-адресов) на один запрос клиента.

  - Узел ретрансляции между клиентом и сервером DHCPv6, то есть клиент и сервер должны находиться в одной сети.

  - Протокол IPSec и проверка подлинности не поддерживаются в сообщениях DHCPv6. Однако в зависимости от используемой версии NetX Duo для экземпляра IP может быть включен протокол IPSec.

  - DHCPv6-сервер NetX Duo напрямую поддерживает только запрос параметра DNS-сервера. В будущих выпусках это может измениться.

  - Параметр делегирования префикса не поддерживается.

  - Проверка подлинности сообщений DHCPv6, хотя протокол IPSec можно включить в базовой среде NetX Duo. DHCPv6-сервер NetX Duo также не поддерживает релейные подключения к клиентам. Предполагается, что все запросы клиентов поступают от узлов в сети сервера.

## <a name="netx-duo-dhcpv6-server-callback-functions"></a>Функции обратного вызова DHCPv6-сервера NetX Duo

*nx_dhcpv6_IP_address_declined_handler*

Когда клиент DHCPv6 отправляет сообщение DECLINE, DHCPv6-сервер NetX Duo помечает адрес как недоступный в своих таблицах IPv6-адресов. Настроить обработку данного сообщения сервером можно с помощью *nx_dhcpv6_IP_address_declined_handler* *.* Однако этот обратный вызов в настоящее время не реализован.

*nx_dhcpv6_server_option_request_handler*

Когда сообщение клиента DHCPv6 содержит данные запроса параметра, DHCPv6-сервер NetX Duo перенаправляет каждый код параметра запроса в этот пользовательский обратный вызов, если он определен. Таким образом сервер NetX Duo может позволить пользовательскому обратному вызову заполнить данные. Однако в настоящее время эта функция не реализована.

## <a name="supported-dhcpv6-rfcs"></a>Поддерживаемые стандарты RFC DHCPv6

Протокол DHCPv6 в NetX Duo соответствует требованиям RFC3315, RFC3646 и связанных с ними стандартов RFC.