---
title: Глава 2. Установка и использование компонента PPP (Point-to-Point Protocol) для NetX Duo (ОСРВ Azure)
description: В этой главе описываются различные проблемы, связанные с установкой, настройкой и использованием компонента PPP (Point-to-Point Protocol) для NetX Duo (ОСРВ Azure).
author: philmea
ms.author: philmea
ms.date: 06/04/2020
ms.topic: article
ms.service: rtos
ms.openlocfilehash: 2270a2668884dbecc8368d4ee130e419afa92491
ms.sourcegitcommit: e3d42e1f2920ec9cb002634b542bc20754f9544e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/22/2021
ms.locfileid: "104814604"
---
# <a name="chapter-2---installation-and-use-of-azure-rtos-netx-duo-point-to-point-protocol-ppp"></a>Глава 2. Установка и использование компонента PPP (Point-to-Point Protocol) для NetX Duo (ОСРВ Azure)

В этой главе описываются различные проблемы, связанные с установкой, настройкой и использованием компонента PPP (Point-to-Point Protocol) для NetX Duo (ОСРВ Azure).

## <a name="product-distribution"></a>Распространение продукта

Пакет PPP (Point-to-Point Protocol) для NetX Duo (ОСРВ Azure) предоставляется по адресу <https://github.com/azure-rtos/netxduo>. В состав пакета входят следующие файлы:

- **nx_ppp.h** — файл заголовка для PPP для NetX;
- **nx_ppp.c** — исходный файл C для PPP для NetX;
- **nx_ppp.pdf** — описание PPP для NetX в формате PDF;
- **demo_netx_ppp.c** — демонстрационный пример PPP для NetX.

## <a name="ppp-installation"></a>Установка PPP

Чтобы использовать PPP для NetX, следует скопировать упомянутый выше дистрибутив целиком в каталог с установленным экземпляром NetX. Например, если экземпляр NetX установлен в каталоге *\threadx\arm7\green*, файлы *nx_ppp.h* и *nx_ppp.c* необходимо скопировать в этот каталог.

## <a name="using-ppp"></a>Использование PPP

Использование PPP для NetX не представляет никаких сложностей. В код приложения нужно включить файл *nx_ppp.h* после *tx_api.h* и *nx_api.h*, чтобы использовать ThreadX и NetX соответственно. После включения файла *nx_ppp.h* код приложения сможет выполнять вызовы функций PPP, описанные ниже в этом руководстве. В приложение также нужно включить файл *nx_ppp.c* для процесса сборки. Этот файл должен быть скомпилирован так же, как и другие файлы приложения, а его форма объекта должна быть связана с файлами приложения. Это все, что необходимо для использования PPP для NetX.

## <a name="using-modems"></a>Использование модемов

Если для подключения к Интернету требуется модем, при работе с продуктом PPP для NetX необходимо учитывать некоторые особенности. По сути, использование модема добавляет логику инициализации и логику потери связи. Кроме того, большая часть дополнительной логики модема реализуется вне контекста PPP для NetX. Основной процесс использования PPP для NetX с модемом выглядит примерно так:

1. Инициализация модема.

1. Установка связи с поставщиком услуг Интернета.

1. Ожидание подключения.

1. Ожидание запроса на ввод идентификатора пользователя.

1. Запуск PPP для NetX [PPP работает].

1. Потеря связи.

1. Остановка PPP для NetX (или перезапуск с помощью nx_ppp_restart).

### <a name="initialize-modem"></a>Инициализация модема

В низкоуровневой подпрограмме приложения для последовательного вывода модем инициализируется с помощью ряда команд с ASCII-символами (дополнительные сведения см. в документации по модему).

### <a name="dial-internet-service-provider"></a>Установка связи с поставщиком услуг Интернета

Низкоуровневая подпрограмма для последовательного вывода дает модему команду установить связь с поставщиком услуг Интернета. Например, ниже приведена стандартная строка ASCII для установки связи с поставщиком услуг Интернета по номеру телефона 123-45-67:

ATDT123456\r

### <a name="wait-for-connection"></a>Ожидание подключения

Теперь приложение ожидает от модема сообщения о том, что подключение установлено. Чтобы проверить состояние, проверяются символы, выводимые низкоуровневой подпрограммой приложения для последовательного вывода. Как правило, модемы возвращают строку CONNECT в формате ASCII, когда подключение успешно устанавливается.

### <a name="wait-for-user-id-prompt"></a>Ожидание запроса на ввод идентификатора пользователя

После установки подключения приложение ожидает начальный запрос имени входа от поставщика услуг Интернета. Обычно он имеет вид строки ASCII, например Login?.

### <a name="start-netx-ppp"></a>Запуск PPP для NetX

На этом этапе можно запустить PPP для NetX. Для этого последовательно вызываются службы *nx_ppp_create* и *nx_ip_create*. Кроме того, могут потребоваться дополнительные службы для включения PAP и настройки IP-адресов для PPP. Дополнительные сведения см. в следующих разделах этого руководства.

### <a name="loss-of-communication"></a>Потеря связи

После запуска PPP все сведения, не относящиеся к PPP, передаются в подпрограмму обработки недопустимых пакетов, которую приложение указало при вызове службы *nx_ppp_create*. Как правило, при потере связи с поставщиком услуг Интернета модемы отправляют строку ASCII, например NO CARRIER. Когда приложение получает пакет с такой информацией в формате, отличающемся от PPP, оно должно либо остановить экземпляр PPP NetX, либо перезапустить конечный автомат PPP с помощью API *nx_ppp_restart*.

### <a name="stop-netx-ppp"></a>Остановка PPP для NetX

Остановить PPP для NetX довольно просто. По сути, нужно освободить и удалить все созданные сокеты. Затем следует удалить экземпляр IP с помощью службы *nx_ip_delete*. После удаления экземпляра IP необходимо вызвать службу *nx_ppp_delete*, чтобы завершить процесс остановки PPP. После этого приложение может попытаться восстановить связь с поставщиком услуг Интернета.

## <a name="small-example-system"></a>Пример небольшой системы

В блоке 1.1 ниже приведен пример, демонстрирующий, насколько просто использовать PPP для NetX. В этом примере включается файл *nx_ppp.h* для компонента PPP (строка 3). Затем в *tx_application_define* в строке 56 создается экземпляр PPP. Блок управления PPP (*my_ppp*) был определен в глобальной переменной выше (строка 9). 

>[!NOTE]
>PPP следует создать до создания экземпляра IP. После успешного создания PPP и IP поток *my_thread* ожидает перехода канала PPP в активное состояние (строка 98). В строке 104 и PPP, и NetX уже полностью настроены к работе.

В этом примере отсутствует только подпрограмма приложения для обработки прерывания, которая получает последовательные байты. В ней нужно вызвать *nx_ppp_byte_receive*, передав в качестве параметров объект *my_ppp* и полученный байт.

```c
0001 #include   "tx_api.h"
0002 #include   "nx_api.h"
0003 #include   "nx_ppp.h"
0004
#define     DEMO_STACK_SIZE         4096
TX_THREAD               my_thread;
NX_PACKET_POOL          my_pool;
NX_IP                   my_ip;
NX_PPP                  my_ppp;

/* Define function prototypes. */

void    my_thread_entry(ULONG thread_input);
void    my_serial_driver_byte_output(UCHAR byte);
void    my_invalid_packet_handler(NX_PACKET *packet_ptr);
 
/* Define main entry point. */
intmain()
{

    /* Enter the ThreadX kernel. */
    tx_kernel_enter();
 }


/* Define what the initial system looks like. */

void    tx_application_define(void *first_unused_memory)
{

CHAR    *pointer;
UINT    status;

/* Setup the working pointer. */
pointer =  (CHAR *) first_unused_memory;

/* Create “my_thread”. */
    tx_thread_create(&my_thread, "my thread", my_thread_entry, 0,  
                  pointer, DEMO_STACK_SIZE, 
                  2, 2, TX_NO_TIME_SLICE, TX_AUTO_START);
    pointer =  pointer + DEMO_STACK_SIZE;

    /* Initialize the NetX system. */
    nx_system_initialize();

    /* Create a packet pool. */
    status =  nx_packet_pool_create(&my_pool, "NetX Main Packet Pool", 
                                    1024, pointer, 64000);
    pointer = pointer + 64000;

    /* Check for pool creation error. */
    if (status)
        error_counter++;

    /* Create a PPP instance. */
    status = nx_ppp_create(&my_ppp, “My PPP”, &my_ip, pointer, 1024, 2, 
                           &my_pool, my_invalid_packet_handler, my_serial_driver_byte_output);
    pointer =  pointer + 1024;
    /* Check for PPP creation pool. */
    if (status)
        error_counter++;

    /* Create an IP instance with the PPP driver. */
    status = nx_ip_create(&my_ip,"My NetX IP Instance", 
                           IP_ADDRESS(216,2,3,1), 0xFFFFFF00, &my_pool, 
                           nx_ppp_driver, pointer, DEMO_STACK_SIZE, 1);
    pointer =  pointer + DEMO_STACK_SIZE;

    /* Check for IP create errors. */
    if (status)
        error_counter++;

    /* Enable ICMP for my IP Instance. */
    status =  nx_icmp_enable(&my_ip);

    /* Check for ICMP enable errors. */
    if (status)
        error_counter++;

    /* Enable UDP. */
    status =  nx_udp_enable(&my_ip);
    if (status)
        error_counter++;
}

/* Define my thread. */
void    my_thread_entry(ULONG thread_input)
{

UINT        status;
ULONG       ip_status;
NX_PACKET   *my_packet;

/* Wait for the PPP link in my_ip to become enabled. */
    status =  nx_ip_status_check(&my_ip,NX_IP_LINK_ENABLED,&ip_status,3000);

    /* Check for IP status error. */
    if (status) 
        return;

    /* Link is fully up and operational. All NetX activities 
    are now available. */

}
```
## <a name="configuration-options"></a>Параметры конфигурации

Существует ряд параметров конфигурации для использования PPP для NetX. Их подробное описание приводится ниже:

- **NX_DISABLE_ERROR_CHECKING** — если определен, этот параметр удаляет базовую проверку ошибок PPP. Обычно он включается после отладки приложения.
- **NX_PPP_PPPOE_ENABLE** — если определен, PPP может передавать пакеты через Ethernet.
- **NX_PPP_BASE_TIMEOUT** — определяет частоту периода (в тактах таймера) активации задачи потока PPP для проверки на наличие событий PPP. Значение по умолчанию — 1*NX_IP_PERIODIC_RATE (100 тактов).
- **NX_PPP_DISABLE_INFO** — если определен, внутренний сбор данных PPP отключен.
- **NX_PPP_DEBUG_LOG_ENABLE** — если определен, внутренний журнал отладки PPP включен.
- **NX_PPP_DEBUG_LOG_PRINT_ENABLE** — если определен, внутренний журнал отладки PPP для вывода *printf* в *stdio* включен. Этот параметр допустим, только если также включен журнал отладки.
- **NX_PPP_DEBUG_LOG_SIZE** — размер журнала отладки (число записей в журнале отладки). При достижении последней записи подсистема сбора отладочных данных переходит к первой записи и перезаписывает все записанные ранее данные. Значение по умолчанию — 50.
- **NX_PPP_DEBUG_FRAME_SIZE** — максимальный объем данных, которые могут быть получены из полезных данных полученного пакета и сохранены в выходных данных отладки. Значение по умолчанию — 50.
- **NX_PPP_DISABLE_CHAP** — если определен, удаляется внутренняя логика CHAP PPP, включая логику дайджеста MD5.
- **NX_PPP_DISABLE_PAP** — если определен, удаляется внутренняя логика PAP PPP.
- **NX_PPP_DNS_OPTION_DISABLE** — если определен, отключается параметр основного DNS-сервера в ответе IPCP. По умолчанию этот параметр не определен.
- **NX_PPP_DNS_ADDRESS_MAX_RETRIES** — указывает, сколько раз узел PPP будет запрашивать адрес DNS-сервера от однорангового узла в состоянии IPCP. Этот параметр не работает, если определен параметр NX_PPP_DNS_OPTION_DISABLE. Значение по умолчанию — 2.
- **NX_PPP_HASHED_VALUE_SIZE** — указывает размер строк хэшированного значения, используемых при проверке подлинности CHAP. Значение по умолчанию равно 16 байтов, но может быть переопределено перед включением *nx_ppp.h*.
- **NX_PPP_MAX_LCP_PROTOCOL_RETRIES** — определяет максимальное число повторных попыток, если время ожидания PPP истекло до отправки другого сообщения запроса настройки LCP. При достижении этого значения подтверждение PPP прерывается, а канал переходит в нерабочее состояние. Значение по умолчанию — 20.
- **NX_PPP_MAX_PAP_PROTOCOL_RETRIES** — определяет максимальное число повторных попыток, если время ожидания PPP истекло до отправки другого сообщения запроса проверки подлинности PAP. При достижении этого значения подтверждение PPP прерывается, а канал переходит в нерабочее состояние. Значение по умолчанию — 20.
- **NX_PPP_MAX_CHAP_PROTOCOL_RETRIES** — определяет максимальное число повторных попыток, если время ожидания PPP истекло до отправки другого сообщения запроса CHAP. При достижении этого значения подтверждение PPP прерывается, а канал переходит в нерабочее состояние. Значение по умолчанию — 20.
- **NX_PPP_MAX_IPCP_PROTOCOL_RETRIES** — определяет максимальное число повторных попыток, если время ожидания PPP истекло до отправки другого сообщения запроса настройки IPCP. При достижении этого значения подтверждение PPP прерывается, а канал переходит в нерабочее состояние. Значение по умолчанию — 20.
- **NX_PPP_MRU** — указывает максимальный размер данных, передаваемых в пакете (MRU) для PPP. По умолчанию это значение равно 1500 байтов (минимальное значение). Это определение можно задать в приложении перед включением *nx_ppp.h*.
- **NX_PPP_MINIMUM_MRU** — указывает минимальный объем MRU, полученный в сообщении запроса настройки LCP. По умолчанию это значение равно 1500 байтов (минимальное значение). Это определение можно задать в приложении перед включением *nx_ppp.h*.
- **NX_PPP_NAME_SIZE** — указывает размер строк имени, используемых при проверке подлинности. Значение по умолчанию равно 32 байтов, но может быть переопределено перед включением *nx_ppp.h.
- **NX_PPP_PASSWORD_SIZE** — указывает размер строк пароля, используемых при проверке подлинности. Значение по умолчанию равно 32 байтов, но может быть переопределено перед включением *nx_ppp.h*.
- **NX_PPP_PROTOCOL_TIMEOUT** — определяет параметр ожидания (в секундах), в течение которого задача PPP получает ответ на сообщение запроса протокола PPP. Значение по умолчанию — 4 секунды.
- **NX_PPP_RECEIVE_TIMEOUTS** — определяет, сколько раз истекает время ожидания задачи потока PPP до получения следующего символа в потоке сообщений PPP. После этого протокол PPP освобождает пакет и ожидает получения следующего сообщения PPP. Значение по умолчанию — 4.
- **NX_PPP_SERIAL_BUFFER_SIZE** — указывает размер последовательного буфера для получения символов. По умолчанию это значение равно 3000 байтов. Это определение можно задать в приложении перед включением *nx_ppp.h*.
- **NX_PPP_TIMEOUT** — определяет параметр ожидания (в тактах таймера) для выделения пакетов для передачи данных, а также для добавления последовательных данных PPP в пакеты для отправки на уровень IP. Значение по умолчанию — 4*NX_IP_PERIODIC_RATE (400 тактов).
- **NX_PPP_THREAD_TIME_SLICE** — параметр временного среза для потоков PPP. По умолчанию имеет значение TX_NO_TIME_SLICE. Это определение можно задать в приложении перед включением *nx_ppp.h*.
- **NX_PPP_VALUE_SIZE** — указывает размер строк значения, используемых при проверке подлинности CHAP. Значение по умолчанию равно 32 байтов, но может быть переопределено перед включением nx_ppp.h.