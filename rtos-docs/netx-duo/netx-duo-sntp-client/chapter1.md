---
title: Глава 1. Введение в SNTP для NetX Duo (ОСРВ Azure)
description: Протокол SNTP для NetX (ОСРВ Azure) используется для синхронизации часов через Интернет.
author: philmea
ms.author: philmea
ms.date: 06/04/2020
ms.topic: article
ms.service: rtos
ms.openlocfilehash: b3e1170197c6c4981060459104da80e354fac5db
ms.sourcegitcommit: e3d42e1f2920ec9cb002634b542bc20754f9544e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/22/2021
ms.locfileid: "104814555"
---
# <a name="chapter-1---introduction-to-azure-rtos-netx-duo-sntp"></a><span data-ttu-id="d7382-103">Глава 1. Введение в SNTP для NetX Duo (ОСРВ Azure)</span><span class="sxs-lookup"><span data-stu-id="d7382-103">Chapter 1 - Introduction to Azure RTOS NetX Duo SNTP</span></span> 

<span data-ttu-id="d7382-104">Протокол SNTP для NetX (ОСРВ Azure) используется для синхронизации часов через Интернет.</span><span class="sxs-lookup"><span data-stu-id="d7382-104">The Azure RTOS NetX Simple Network Time Protocol (SNTP) is a protocol designed for synchronizing clocks over the Internet.</span></span> <span data-ttu-id="d7382-105">SNTP версии 4 — это упрощенный протокол на базе протокола NTP.</span><span class="sxs-lookup"><span data-stu-id="d7382-105">SNTP Version 4 is a simplified protocol based on the Network Time Protocol (NTP).</span></span> <span data-ttu-id="d7382-106">Этот простой протокол без отслеживания состояния использует службы UDP для обновления сведений о времени.</span><span class="sxs-lookup"><span data-stu-id="d7382-106">It utilizes User Datagram Protocol (UDP) services to perform time updates in a simple, stateless protocol.</span></span> <span data-ttu-id="d7382-107">Хотя протокол SNTP не такой сложный, как NTP, он является точным и надежным.</span><span class="sxs-lookup"><span data-stu-id="d7382-107">Though not as complex as NTP, SNTP is highly reliable and accurate.</span></span> <span data-ttu-id="d7382-108">В большинстве расположений в современном Интернете SNTP обеспечивает точность от 1 до 50 миллисекунд в зависимости от характеристик источника синхронизации и сетевых путей.</span><span class="sxs-lookup"><span data-stu-id="d7382-108">In most places of the Internet of today, SNTP provides accuracies of 1-50 milliseconds, depending on the characteristics of the synchronization source and network paths.</span></span> <span data-ttu-id="d7382-109">SNTP поддерживает много возможностей для обеспечения надежности получения обновлений времени.</span><span class="sxs-lookup"><span data-stu-id="d7382-109">SNTP has many options to provide reliability of receiving time updates.</span></span> <span data-ttu-id="d7382-110">Возможность переключения на альтернативные серверы, применение алгоритмов опроса с задержкой и автоматическое обнаружение серверов времени — вот лишь некоторые из средств, которые клиент SNTP может применять в изменчивой среде службы времени в Интернете.</span><span class="sxs-lookup"><span data-stu-id="d7382-110">Ability to switch to alternative servers, applying back off polling algorithms and automatic time server discovery are just a few of the means for an SNTP client to handle a variable Internet time service environment.</span></span> <span data-ttu-id="d7382-111">Недостаток точности компенсируется простотой в применении и реализации.</span><span class="sxs-lookup"><span data-stu-id="d7382-111">What it lacks in precision it makes up for in simplicity and ease of implementation.</span></span> <span data-ttu-id="d7382-112">Протокол SNTP предназначен главным образом для предоставления полнофункциональных механизмов доступа к национальным службам времени и частоты (например, к серверу NTP).</span><span class="sxs-lookup"><span data-stu-id="d7382-112">SNTP is intended primarily for providing comprehensive mechanisms to access national time and frequency dissemination (e.g. NTP server) services.</span></span>

## <a name="netx-duo-sntp-client-requirements"></a><span data-ttu-id="d7382-113">Требования для клиента SNTP для NetX Duo</span><span class="sxs-lookup"><span data-stu-id="d7382-113">NetX Duo SNTP Client Requirements</span></span>

<span data-ttu-id="d7382-114">Для клиента SNTP NetX Duo требуется, чтобы заранее был создан экземпляр IP-адреса.</span><span class="sxs-lookup"><span data-stu-id="d7382-114">The NetX Duo SNTP Client requires that an IP instance has already been created.</span></span> <span data-ttu-id="d7382-115">Кроме того, в этом экземпляре IP-адреса должен быть включен протокол UDP и предоставлен доступ к *хорошо известному* порту 123 для отправки данных о времени на сервер SNTP. Впрочем, другие порты тоже подойдут.</span><span class="sxs-lookup"><span data-stu-id="d7382-115">In addition, UDP must be enabled on that same IP instance and should have access to the *well-known* port 123 for sending time data to an SNTP Server, although alternative ports will work as well.</span></span> <span data-ttu-id="d7382-116">Широковещательным клиентам нужно привязать UDP-порт, на котором работает соответствующий широковещательный сервер, обычно это порт 123.</span><span class="sxs-lookup"><span data-stu-id="d7382-116">Broadcast clients should bind the UDP port their broadcast server is sending on, usually 123.</span></span> <span data-ttu-id="d7382-117">Приложение клиента SNTP для NetX Duo должно использовать один или несколько IP-адресов сервера SNTP.</span><span class="sxs-lookup"><span data-stu-id="d7382-117">The NetX Duo SNTP Client application must have one or more IP SNTP Server addresses.</span></span>

## <a name="netx-duo-sntp-client-limitations"></a><span data-ttu-id="d7382-118">Ограничения для клиентов SNTP для NetX Duo</span><span class="sxs-lookup"><span data-stu-id="d7382-118">NetX Duo SNTP Client Limitations</span></span> 

<span data-ttu-id="d7382-119">Точность представления местного времени при обновлениях времени NTP через API клиента SNTP ограничена миллисекундами.</span><span class="sxs-lookup"><span data-stu-id="d7382-119">Precision in local time representation in NTP time updates handled by the SNTP Client API is limited to millisecond resolution.</span></span>

<span data-ttu-id="d7382-120">В любой момент времени клиент SNTP использует только один адрес сервера SNTP.</span><span class="sxs-lookup"><span data-stu-id="d7382-120">The SNTP Client only holds a single SNTP Server address at any time.</span></span> <span data-ttu-id="d7382-121">Если этот сервер прекратит работу, приложение должно прервать задачу клиента SNTP и повторно инициализировать ее с другим адресом сервера SNTP, используя широковещательную или одноадресную связь SNTP.</span><span class="sxs-lookup"><span data-stu-id="d7382-121">If that Server appears to be no longer valid, the application must stop the SNTP Client task, and reinitialize it with another SNTP server address, using either broadcast or unicast SNTP communication.</span></span>

<span data-ttu-id="d7382-122">Клиент SNTP не поддерживает многоадресную трансляцию.</span><span class="sxs-lookup"><span data-stu-id="d7382-122">The SNTP Client does not support manycast.</span></span>

<span data-ttu-id="d7382-123">Клиент SNTP для NetX Duo не поддерживает механизмы проверки подлинности для проверки полученных данных.</span><span class="sxs-lookup"><span data-stu-id="d7382-123">NetX Duo SNTP Client does not support authentication mechanisms for verifying received packet data.</span></span>

## <a name="netx-duo-sntp-client-operation"></a><span data-ttu-id="d7382-124">Операции с клиентом SNTP для NetX Duo</span><span class="sxs-lookup"><span data-stu-id="d7382-124">NetX Duo SNTP Client Operation</span></span>

<span data-ttu-id="d7382-125">Стандарт RFC 4330 рекомендует, чтобы клиенты SNTP работали только с самыми высоким уровнем (стратой) локальной сети и чтобы синхронизация клиентов NTP или SNTP не зависела от них.</span><span class="sxs-lookup"><span data-stu-id="d7382-125">RFC 4330 recommends that SNTP clients should operate only at the highest stratum of their local network and preferably in configurations where no NTP or SNTP client is dependent them for synchronization.</span></span> <span data-ttu-id="d7382-126">Страта обозначает позицию узла в иерархии времени NTP, где страта 1 является самым высоким уровнем (корневой сервер времени), а страта 15 — самым низким допустимым уровнем (клиент).</span><span class="sxs-lookup"><span data-stu-id="d7382-126">Stratum level reflects the host position in the NTP time hierarchy where stratum 1 is the highest level (a root time server) and 15 is the lowest allowed level (e.g. Client).</span></span> <span data-ttu-id="d7382-127">По умолчанию клиент SNTP использует минимальное значение — страту 2.</span><span class="sxs-lookup"><span data-stu-id="d7382-127">The SNTP Client default minimum stratum is 2.</span></span>

<span data-ttu-id="d7382-128">Клиент SNTP для NetX Duo может работать для получения времени через Интернет в одном из двух основных режимов: одноадресная или широковещательная передача.</span><span class="sxs-lookup"><span data-stu-id="d7382-128">The NetX Duo SNTP Client can operate in one of two basic modes, unicast or broadcast, to obtain time over the Internet.</span></span> <span data-ttu-id="d7382-129">В режиме одноадресной передачи клиент опрашивает сервер SNTP через равные промежутки времени и ожидает получения ответа от этого сервера.</span><span class="sxs-lookup"><span data-stu-id="d7382-129">In unicast mode, the Client polls its SNTP Server on regular intervals and waits to receive a reply from that Server.</span></span> <span data-ttu-id="d7382-130">При получении ответа клиент проверяет, что в нем содержится допустимое обновление времени, применяя набор проверок в соответствии со стандартом RFC 4330.</span><span class="sxs-lookup"><span data-stu-id="d7382-130">When one is received, the Client verifies that the reply contains a valid time update by applying a set of ‘sanity checks’ recommended by RFC 4330.</span></span> <span data-ttu-id="d7382-131">Затем клиент применяет разницу во времени, если она обнаружена, с часами сервера к своим локальным часам.</span><span class="sxs-lookup"><span data-stu-id="d7382-131">The Client then applies the time difference, if any, with the Server clock to its local clock.</span></span> <span data-ttu-id="d7382-132">В широковещательном режиме клиент просто ожидает широковещательные пакеты обновления времени и согласовывает с ними свои локальные часы после применения аналогичного набора проверок к данным об обновлении времени.</span><span class="sxs-lookup"><span data-stu-id="d7382-132">In broadcast mode, the Client merely listens for time update broadcasts and maintains its local clock after applying a similar set of sanity checks to verify the update time data.</span></span> <span data-ttu-id="d7382-133">Эти проверки подробно описаны в разделе **Проверки SNTP** ниже.</span><span class="sxs-lookup"><span data-stu-id="d7382-133">Sanity checks are described in detail in the **SNTP Sanity Checks** section below.</span></span>

<span data-ttu-id="d7382-134">Прежде чем клиент сможет работать в любом режиме, он должен определить рабочие параметры.</span><span class="sxs-lookup"><span data-stu-id="d7382-134">Before the Client can run in either mode, it must establish its operating parameters.</span></span> <span data-ttu-id="d7382-135">Для этого выполняется вызов *nx_sntp_client_initialize_unicast* или *nx_sntp_client_initialize_broadcast* для режимов широковещательной или одноадресной трансляции.</span><span class="sxs-lookup"><span data-stu-id="d7382-135">This is done by calling either *nx_sntp_client_initialize_unicast* or *nx_sntp_client_initialize_broadcast* for unicast or broadcast modes, respectively.</span></span> <span data-ttu-id="d7382-136">Эти серверы задают максимально допустимый промежуток времени без допустимого обновления, ограничение на количество последовательно принятых недопустимых обновлений, интервал опроса в одноадресном режиме, режим работы (одноадресная и широковещательная трансляция) и сервер SNTP.</span><span class="sxs-lookup"><span data-stu-id="d7382-136">These serves set the time outs for maximum time lapse without a valid update, the limit on consecutive invalid updates received, a polling interval for unicast mode, operation mode e.g. unicast vs. broadcast, and SNTP Server.</span></span>

<span data-ttu-id="d7382-137">Если максимально допустимый промежуток времени или максимальное количество недопустимых обновлений превышаются, клиент SNTP продолжит работу, но установит для этого сервера SNTP состояние "Недопустимо".</span><span class="sxs-lookup"><span data-stu-id="d7382-137">If the maximum time lapse or maximum invalid updates received is exceeded, the SNTP Client continues to run but sets the current SNTP Server status to invalid.</span></span> <span data-ttu-id="d7382-138">Приложение может опросить клиент SNTP через службу *nx_sntp_client_receiving_updates*, чтобы убедиться, что сервер SNTP по-прежнему отправляет допустимые обновления.</span><span class="sxs-lookup"><span data-stu-id="d7382-138">The application can poll the SNTP Client using the *nx_sntp_client_receiving_updates* service to verify the SNTP Server is still sending valid updates.</span></span> <span data-ttu-id="d7382-139">Если это не так, он прерывает поток клиента SNTP с помощью службы *nx_sntp_client_stop* и вызывает любую из двух служб инициализации с другим адресом сервера SNTP.</span><span class="sxs-lookup"><span data-stu-id="d7382-139">If not, it should stop the SNTP Client thread using the *nx_sntp_client_stop* service and call either of the two initialize services to set another SNTP Server address.</span></span> <span data-ttu-id="d7382-140">Чтобы перезапустить клиент SNTP, приложение вызывает *nx_sntp_client_run_broadcast* или *nx_sntp_client_run_unicast*.</span><span class="sxs-lookup"><span data-stu-id="d7382-140">To restart the SNTP Client, the application calls *nx_sntp_client_run_broadcast* or *nx_sntp_client_run_unicast*.</span></span> <span data-ttu-id="d7382-141">Обратите внимание, что приложение может изменить режим работы клиента SNTP при инициализации, чтобы выбрать одноадресную или широковещательную трансляцию.</span><span class="sxs-lookup"><span data-stu-id="d7382-141">Note that the application can change SNTP Client operating mode in the initialize call to switch to unicast or broadcast as desired.</span></span>

### <a name="local-clock-operation"></a><span data-ttu-id="d7382-142">Работа локальных часов</span><span class="sxs-lookup"><span data-stu-id="d7382-142">Local Clock Operation</span></span>

<span data-ttu-id="d7382-143">Время SNTP выражается в количестве секунд на главных часах NTP или в количестве секунд, прошедших в первой эпохе NTP, т. е. с **00:00:00 1 января 1900 года** по **00:00:00 1 января 1999 года**.</span><span class="sxs-lookup"><span data-stu-id="d7382-143">The SNTP time based on the number of seconds on the master NTP clock, or number of seconds elapsed in the first NTP epoch e.g. from Jan 1 **1900 00:00:00 to** Jan 1 **1999 00:00:00**.</span></span> <span data-ttu-id="d7382-144">Дата 01-01-1999 важна тем, что на нее пришлась последняя корректировочная секунда.</span><span class="sxs-lookup"><span data-stu-id="d7382-144">The significance of 01-01-1999 was when the last leap second occurred.</span></span> <span data-ttu-id="d7382-145">Это значение определяется следующим образом:</span><span class="sxs-lookup"><span data-stu-id="d7382-145">This value is defined as follows:</span></span>

<span data-ttu-id="d7382-146">\#define NTP_SECONDS_AT_01011999 0xBA368E80</span><span class="sxs-lookup"><span data-stu-id="d7382-146">\#define NTP_SECONDS_AT_01011999 0xBA368E80</span></span>

<span data-ttu-id="d7382-147">Перед запуском клиента SNTP приложение может дополнительно инициализировать местное время клиента SNTP, которое будет использоваться в качестве базового времени.</span><span class="sxs-lookup"><span data-stu-id="d7382-147">Before the SNTP Client runs, the application can optionally initialize the SNTP Client local time for the Client to use as a baseline time.</span></span> <span data-ttu-id="d7382-148">Для этого оно использует службу *nx_sntp_client_set_local_time*.</span><span class="sxs-lookup"><span data-stu-id="d7382-148">To do so, it must use the *nx_sntp_client_set_local_time* service.</span></span> <span data-ttu-id="d7382-149">Она принимает время в формате NTP, секунды и дробную часть, которая обозначает количество миллисекунд в сжатом формате времени NTP.</span><span class="sxs-lookup"><span data-stu-id="d7382-149">This takes the time in NTP format, seconds and fraction, where fraction is the milliseconds in the NTP condensed time.</span></span> <span data-ttu-id="d7382-150">В идеале приложение может получать время SNTP из независимого источника.</span><span class="sxs-lookup"><span data-stu-id="d7382-150">Ideally the application can obtain an SNTP time from an independent source.</span></span> <span data-ttu-id="d7382-151">В клиенте SNTP для NetX Duo отсутствуют API для преобразования года, месяца, даты и времени в формат NTP.</span><span class="sxs-lookup"><span data-stu-id="d7382-151">There is no API for converting year, month, date and time to an NTP time in the NetX Duo SNTP Client.</span></span> <span data-ttu-id="d7382-152">Описание формата времени NTP можно найти в стандарте *RFC4330 "Simple Network Time Protocol (SNTP) Version 4 for IPv4, IPv6 and OSI"* (RFC4330. Протокол SNMP версии 4 для IPv4, IPv6 и OSI).</span><span class="sxs-lookup"><span data-stu-id="d7382-152">For a description of NTP time format, refer to *RFC4330 “Simple Network Time Protocol (SNTP) Version 4 for IPv4, IPv6 and OSI”.*</span></span>

<span data-ttu-id="d7382-153">Если при запуске клиента SNTP не указано базовое местное время, клиент SNTP при первом обновлении SNTP примет полученное значение без сравнения с местным временем.</span><span class="sxs-lookup"><span data-stu-id="d7382-153">If no base local time is supplied when the SNTP Client starts up, the SNTP Client will accept the SNTP updates without comparing to its local time on the first update.</span></span> <span data-ttu-id="d7382-154">После этого обновления местного времени будут выполняться с учетом требуемых значений максимального и минимального времени обновления.</span><span class="sxs-lookup"><span data-stu-id="d7382-154">Thereafter it will apply the maximum and minimum time update values to determine if it will modify its local time.</span></span>

<span data-ttu-id="d7382-155">Чтобы получить местное время клиента SNTP, приложение может использовать службу *nx_sntp_client_get_local_time_extended*.</span><span class="sxs-lookup"><span data-stu-id="d7382-155">To obtain the SNTP Client local time, the application can use the *nx_sntp_client_get_local_time_extended* service.</span></span>

### <a name="sntp-sanity-checks"></a><span data-ttu-id="d7382-156">Проверки SNTP</span><span class="sxs-lookup"><span data-stu-id="d7382-156">SNTP Sanity Checks</span></span> 

<span data-ttu-id="d7382-157">Клиент проверяет входящий пакет по следующим критериям:</span><span class="sxs-lookup"><span data-stu-id="d7382-157">The Client examines the incoming packet for the following criteria:</span></span>

  - <span data-ttu-id="d7382-158">Исходный IP-адрес должен соответствовать текущему IP-адресу сервера.</span><span class="sxs-lookup"><span data-stu-id="d7382-158">Source IP address must match the current server IP address.</span></span>

  - <span data-ttu-id="d7382-159">Исходный порт отправителя должен соответствовать текущему исходному порту сервера.</span><span class="sxs-lookup"><span data-stu-id="d7382-159">Sender source port must match with the current server source port.</span></span>

  - <span data-ttu-id="d7382-160">Длина пакета должна быть не меньше минимально необходимой для хранения сообщения с временем SNTP.</span><span class="sxs-lookup"><span data-stu-id="d7382-160">Packet length must be the minimum length to hold an SNTP time message.</span></span>

<span data-ttu-id="d7382-161">После этого клиент извлекает данные о времени из буфера пакета и применяет к ним следующий набор проверок:</span><span class="sxs-lookup"><span data-stu-id="d7382-161">Next, the time data is extracted from the packet buffer to which the Client then applies a set of specific ‘sanity checks’:</span></span>

  - <span data-ttu-id="d7382-162">Значение 3 для поля Leap Indicator (Индикатор корректировки) означает, что сервер не синхронизирован.</span><span class="sxs-lookup"><span data-stu-id="d7382-162">The Leap Indicator set to 3 indicates the Server is not synchronized.</span></span> <span data-ttu-id="d7382-163">Клиент должен попытаться найти другой сервер.</span><span class="sxs-lookup"><span data-stu-id="d7382-163">The Client should attempt to find an alternative server.</span></span>

  - <span data-ttu-id="d7382-164">Значение 0 для поля Stratum характеризует особый пакет, условно именуемый "поцелуем смерти" (пакет KOD, Kiss of Death).</span><span class="sxs-lookup"><span data-stu-id="d7382-164">A stratum field set to zero is known as a Kiss of Death (KOD) packet.</span></span> <span data-ttu-id="d7382-165">В этой ситуации обработчик KOD в клиенте SMTP вызывает процедуру, определенную пользователем.</span><span class="sxs-lookup"><span data-stu-id="d7382-165">The SMTP Client KOD handler for this situation is a user defined callback.</span></span> <span data-ttu-id="d7382-166">В нашем примере представлен демонстрационного файл с простым обработчиком KOD для этой ситуации.</span><span class="sxs-lookup"><span data-stu-id="d7382-166">The small example demo file contains a simple KOD handler for this situation.</span></span> <span data-ttu-id="d7382-167">Поле Reference ID (Идентификатор ссылки) содержит необязательный код, указывающий причину ответа KOD.</span><span class="sxs-lookup"><span data-stu-id="d7382-167">The Reference ID field optionally contains a code indicating the reason for the KOD reply.</span></span> <span data-ttu-id="d7382-168">В любом случае обработчик KOD должен определять способ обработки пакета KOD, полученного от сервера SNTP.</span><span class="sxs-lookup"><span data-stu-id="d7382-168">At any rate, the KOD handler must indicate how to handle receiving a kiss of death from the SNTP Server.</span></span> <span data-ttu-id="d7382-169">Обычно в этом случае выполняется повторная инициализация клиента SNTP с другим сервером SNTP.</span><span class="sxs-lookup"><span data-stu-id="d7382-169">Typically it will want to reinitialize the SNTP Client with another SNTP Server.</span></span>

  - <span data-ttu-id="d7382-170">Версия сервера SNTP, уровень Stratum и режим работы должны соответствовать параметрам службы клиента.</span><span class="sxs-lookup"><span data-stu-id="d7382-170">The Server SNTP version, stratum and mode of operation must be matched to the Client service.</span></span>

  - <span data-ttu-id="d7382-171">Если для клиента настроена максимально допустимая дисперсия серверных часов, клиент проверяет дисперсию серверных часов при получении первого обновления, и если оно превышает максимально допустимое для этого клиента, он отклоняет сервер.</span><span class="sxs-lookup"><span data-stu-id="d7382-171">If the Client is configured with a server clock dispersion maximum, the Client checks the server clock dispersion on the first update received only, and if it exceeds the Client maximum, the Client rejects the Server.</span></span>

  - <span data-ttu-id="d7382-172">Поля с метками времени сервера также проходят определенные проверки.</span><span class="sxs-lookup"><span data-stu-id="d7382-172">The Server time stamp fields must also pass specific checks.</span></span> <span data-ttu-id="d7382-173">Для одноадресного сервера все поля времени должны быть заполнены и не могут иметь значений NULL.</span><span class="sxs-lookup"><span data-stu-id="d7382-173">For the unicast Server, all time fields must be filled in and cannot be NULL.</span></span> <span data-ttu-id="d7382-174">Метка времени Origination (Создание) должна совпадать с меткой времени Transmit (Передача) в запросе времени от клиента SNTP.</span><span class="sxs-lookup"><span data-stu-id="d7382-174">The Origination time stamp must equal the Transmit time stamp in the Client’s SNTP time message request.</span></span> <span data-ttu-id="d7382-175">Это защищает клиента от вредоносных воздействий и нестандартных действий сервера.</span><span class="sxs-lookup"><span data-stu-id="d7382-175">This protects the Client from malicious intruders and rogue Server behavior.</span></span> <span data-ttu-id="d7382-176">Широковещательный сервер должен заполнять только метку времени Transmit (Передача).</span><span class="sxs-lookup"><span data-stu-id="d7382-176">The broadcast Server need only fill in the Transmit time stamp.</span></span> <span data-ttu-id="d7382-177">Так как он ничего не получает от клиента, поля Receive (Получение) или Origin (Создание) не могут быть заполнены.</span><span class="sxs-lookup"><span data-stu-id="d7382-177">Since it does not receive anything from the Client it has no Receive or Origination fields to fill in.</span></span>

    <span data-ttu-id="d7382-178">Если проверка не пройдена, полученное обновление времени считается недопустимым.</span><span class="sxs-lookup"><span data-stu-id="d7382-178">A failed sanity check brands a time update as an invalid time update.</span></span> <span data-ttu-id="d7382-179">Служба проверки в клиенте SNTP отслеживает количество последовательно полученных недопустимых обновлений времени от одного сервера.</span><span class="sxs-lookup"><span data-stu-id="d7382-179">The SNTP Client sanity check service tracks the number of consecutive invalid time updates received from the same Server.</span></span>

<span data-ttu-id="d7382-180">Когда задача, выполняющая поток клиента SNTP, проверяет допустимость пакета SNTP для изменения местного времени клиента SNTP, она увеличивает значение `nx_sntp_client_invalid_time_updates.` для клиента SNTP. Также она возвращает вызывающему объекту состояние ошибки, но это внутренний процесс, который не будет сразу же заметен для приложения.</span><span class="sxs-lookup"><span data-stu-id="d7382-180">When SNTP Client thread task checks the validity of an SNTP packet for applying to the local SNTP Client time, it increments the count of the SNTP Client `nx_sntp_client_invalid_time_updates.` It also returns an error status to the caller but this is all internal processing so it is not immediately visible to the application.</span></span> <span data-ttu-id="d7382-181">Чтобы обнаружить проблемы с обновлением времени, нужно запросить значение `nx_sntp_client_invalid_time_updates` для клиента SNTP после получения обновления времени от сервера SNTP.</span><span class="sxs-lookup"><span data-stu-id="d7382-181">The way to detect failed time updates is to query the value of the SNTP Client `nx_sntp_client_invalid_time_updates` after receiving SNTP Server time updates.</span></span>

<span data-ttu-id="d7382-182">Если обновление времени пройдет все проверки, клиент попытается преобразовать полученные данные времени в местное время.</span><span class="sxs-lookup"><span data-stu-id="d7382-182">If the Server time update passes the sanity checks, the Client then attempts to process the time data to its local time.</span></span> <span data-ttu-id="d7382-183">Если на клиенте настроено вычисление кругового пути, т е. период времени от отправки запроса на обновление до получения ответа, он выполняет такое вычисление.</span><span class="sxs-lookup"><span data-stu-id="d7382-183">If the Client is configured for round trip calculation, e.g. the time from sending an update request to the time one is received, the round trip time is calculated.</span></span> <span data-ttu-id="d7382-184">Половина полученного значения добавляется к времени, полученному от сервера.</span><span class="sxs-lookup"><span data-stu-id="d7382-184">This value is halved and then added to the Server’s time.</span></span>

<span data-ttu-id="d7382-185">Затем, если это первое обновление от текущего сервера SNTP, клиент SNTP определяет, следует ли игнорировать разницу между временем сервера и местным временем клиента.</span><span class="sxs-lookup"><span data-stu-id="d7382-185">Next, if this is the first update received from the current SNTP Server, the SNTP Client determines if it should ignore the difference between the Server and Client local time.</span></span> <span data-ttu-id="d7382-186">После этого для всех обновлений от сервера SNTP оценивается отклонение от местного времени клиента.</span><span class="sxs-lookup"><span data-stu-id="d7382-186">Thereafter all updates from the SNTP Server are evaluated for the difference with the Client local time.</span></span>

<span data-ttu-id="d7382-187">Разница между временем клиента и временем сервера сравнивается с `NX_SNTP_CLIENT_MAX_TIME_ADJUSTMENT`.</span><span class="sxs-lookup"><span data-stu-id="d7382-187">The difference between Client and Server time is compared with `NX_SNTP_CLIENT_MAX_TIME_ADJUSTMENT`.</span></span> <span data-ttu-id="d7382-188">Если она превышает это значение, данные отбрасываются. Если разница меньше или равна `NX_SNTP_CLIENT_MIN_TIME_ADJUSTMENT`, различия считаются незначительными и коррекция не применяется.</span><span class="sxs-lookup"><span data-stu-id="d7382-188">If it exceeds this value, the data is thrown out. If the difference is less than the `NX_SNTP_CLIENT_MIN_TIME_ADJUSTMENT` the difference is considered too small to require adjustment.</span></span>

<span data-ttu-id="d7382-189">После выполнения всех этих проверок время обновления будет применено к клиенту SNTP с некоторыми корректировками для учета задержки при внутренней обработке в клиенте SNTP.</span><span class="sxs-lookup"><span data-stu-id="d7382-189">Passing all these checks, the time update is then applied to the SNTP Client with some corrections for delays in internal SNTP Client processing.</span></span>

### <a name="sntp-asynchronous-unicast-requests"></a><span data-ttu-id="d7382-190">Асинхронные одноадресные запросы SNTP</span><span class="sxs-lookup"><span data-stu-id="d7382-190">SNTP Asynchronous Unicast Requests</span></span> 

<span data-ttu-id="d7382-191">Клиент SNTP позволяет ведущему приложению асинхронно отправлять одноадресный запрос на получение текущего времени от сервера NTP.</span><span class="sxs-lookup"><span data-stu-id="d7382-191">The SNTP Client allows the host application to asynchronously send a unicast request for the current time from the NTP server.</span></span>

```C
UINT _nx_sntp_client_request_unicast_time(
NX_SNTP_CLIENT *client_ptr, 
UINT wait_option)
```

<span data-ttu-id="d7382-192">Параметр wait (ожидание) означает период времени для ожидания ответа.</span><span class="sxs-lookup"><span data-stu-id="d7382-192">The wait option is the expiration to wait for a response.</span></span>

<span data-ttu-id="d7382-193">Если сервер NTP вернет ответ вовремя, к полученному пакету применяются все процессы обработки и проверки, которые описаны в предыдущем разделе, а затем обновляется местное время клиента SNTP.</span><span class="sxs-lookup"><span data-stu-id="d7382-193">If the NTP Server responds, the packet is subjected to the same processing and sanity checks as described in the previous section before updating the SNTP Client local time.</span></span>

<span data-ttu-id="d7382-194">Если вызов возвращает сообщение об успешном завершении, приложение может вызвать *nx_sntp_client_utility_display_date_time* или *nx_sntp_client_get_local_time_extended*, чтобы получить обновленное время.</span><span class="sxs-lookup"><span data-stu-id="d7382-194">If the call returns successful completion, the application can call *nx_sntp_client_utility_display_date_time* or *nx_sntp_client_get_local_time_extended* for the updated local time.</span></span>

<span data-ttu-id="d7382-195">Эти одноадресные запросы не влияют на стандартное расписание работы клиента SNTP, по которому он отправит следующий запрос в одноадресном режиме или будет ожидать сообщение от сервера NTP в широковещательном режиме.</span><span class="sxs-lookup"><span data-stu-id="d7382-195">These unicast requests do not interfere with the normal SNTP Client schedule for sending the next unicast request, or if in broadcast mode, when to expect the next NTP broadcast.</span></span>

### <a name="periodic-local-time-updates"></a><span data-ttu-id="d7382-196">Периодические обновления местного времени</span><span class="sxs-lookup"><span data-stu-id="d7382-196">Periodic Local Time Updates</span></span>

<span data-ttu-id="d7382-197">Максимально допустимая корректировка местного времени задается в миллисекундах в параметре NX_SNTP_CLIENT_MAX_TIME_ADJUSTMENT.</span><span class="sxs-lookup"><span data-stu-id="d7382-197">The maximum adjustment to the local time is set in the NX_SNTP_CLIENT_MAX_TIME_ADJUSTMENT option (in milliseconds).</span></span> <span data-ttu-id="d7382-198">Интервал обновления для опросов в одноадресном режиме работы клиента SNTP задается в секундах в параметре NX_SNTP_CLIENT_UNICAST_POLL_INTERVAL.</span><span class="sxs-lookup"><span data-stu-id="d7382-198">The polling update interval for unicast SNTP Client operations is set in the NX_SNTP_CLIENT_UNICAST_POLL_INTERVAL option (in seconds).</span></span> <span data-ttu-id="d7382-199">Если интервал опроса превышает максимальное допустимую корректировку, будут отклоняться все последующие обновления от сервера после первого обновления.</span><span class="sxs-lookup"><span data-stu-id="d7382-199">If the polling interval is greater than the maximum adjustment, then subsequent server updates after the first server update will be rejected.</span></span> <span data-ttu-id="d7382-200">Чтобы избежать этого, клиент SNTP периодически будет обновлять местное время, заданное как NX_SNTP_UPDATE_TIMEOUT_INTERVAL.</span><span class="sxs-lookup"><span data-stu-id="d7382-200">To prevent this, the SNTP Client will update the local time periodically defined as NX_SNTP_UPDATE_TIMEOUT_INTERVAL.</span></span> 

<span data-ttu-id="d7382-201">Если возникает расхождение времени между часами реального времени (RTC) на плате и временем сервера (которое должно применяться для изменения местного времени клиента SNTP), часы RTC должны синхронизироваться со временем клиента SNTP (этот процесс не описан в этом руководстве пользователя).</span><span class="sxs-lookup"><span data-stu-id="d7382-201">If there is a difference in time between the on board RTC and the server time (which the SNTP Client local time should be set to), the RTC should be synched to the SNTP Client time (we do not demonstrate that in this User Guide).</span></span>

<span data-ttu-id="d7382-202">Так как обновления сервера SNTP не могут происходить чаще, чем раз в час, нет никакого смысла опрашивать клиент SNTP на наличие обновлений на сервере чаще этого интервала.</span><span class="sxs-lookup"><span data-stu-id="d7382-202">Since SNTP server updates should not occur more often than once per hour, it is not useful to poll the SNTP Client for server updates or server status more often than that.</span></span> <span data-ttu-id="d7382-203">Но при этом клиент SNTP должен обновлять свои часы местного времени достаточно часто, чтобы не нарушить ограничения, заданные параметром максимально допустимой корректировки времени NX_SNTP_CLIENT_MAX_TIME_LAPSE.</span><span class="sxs-lookup"><span data-stu-id="d7382-203">However, the SNTP Client should update its local clock often enough not to fall further than the maximum time adjustment parameter NX_SNTP_CLIENT_MAX_TIME_LAPSE.</span></span>

<span data-ttu-id="d7382-204">Кроме того, максимально допустимая корректировка NX_SNTP_CLIENT_MAX_TIME_LAPSE может иметь значение больше, чем период обновления для одноадресного режима (или ожидаемый период широковещательных пакетов).</span><span class="sxs-lookup"><span data-stu-id="d7382-204">Alternatively, the maximum adjustment NX_SNTP_CLIENT_MAX_TIME_LAPSE can be set to greater than the unicast polling update (or anticipated broadcast intervals).</span></span> <span data-ttu-id="d7382-205">Это устраняет необходимость в использовании независимых часов RTC.</span><span class="sxs-lookup"><span data-stu-id="d7382-205">The latter eliminates the need for an independent real time clock.</span></span> <span data-ttu-id="d7382-206">Но протокол SNTP предназначен для того, чтобы избежать полной зависимости от локальных часов RTC или сетевых обновлений времени.</span><span class="sxs-lookup"><span data-stu-id="d7382-206">However, the intention of SNTP protocol is to avoid total reliance on either local RTC or network time updates.</span></span> <span data-ttu-id="d7382-207">Кроме того, обновления от сервера SNTP позволяют избежать постепенного отклонения местного времени.</span><span class="sxs-lookup"><span data-stu-id="d7382-207">Further, the SNTP Server updates are intended to prevent drift in the local time clock.</span></span>

## <a name="multiple-network-interfaces"></a><span data-ttu-id="d7382-208">Использование нескольких сетевых интерфейсов</span><span class="sxs-lookup"><span data-stu-id="d7382-208">Multiple Network Interfaces</span></span>

<span data-ttu-id="d7382-209">Клиент SNTP для NetX Duo можно настроить для работы в вторичных сетях, если для них зарегистрирован экземпляр IP-адреса.</span><span class="sxs-lookup"><span data-stu-id="d7382-209">NetX Duo SNTP Client can be configured to run on secondary networks as long as those networks are registered with the IP instance.</span></span> <span data-ttu-id="d7382-210">Дополнительные сведения о регистрации дополнительных сетей см. в руководстве пользователя NetX Duo или NetX.</span><span class="sxs-lookup"><span data-stu-id="d7382-210">See the NetX Duo or NetX User Guide for more information on how to register secondary networks.</span></span>

<span data-ttu-id="d7382-211">В вызове *nx_sntp_client_create* установите для третьего входного параметра, iface_index, значение индекса сети, чтобы клиент SNTP получал обновления времени.</span><span class="sxs-lookup"><span data-stu-id="d7382-211">In the *nx_sntp_client_create* call, set the third input, iface_index, to the index of the network for the SNTP Client to receive time updates on.</span></span> <span data-ttu-id="d7382-212">Первичный интерфейс всегда имеет значение индекса 0.</span><span class="sxs-lookup"><span data-stu-id="d7382-212">The primary interface is always at index 0.</span></span> <span data-ttu-id="d7382-213">Клиент SNTP для NetX Duo не поддерживает одновременное обновление времени через несколько сетевых интерфейсов.</span><span class="sxs-lookup"><span data-stu-id="d7382-213">NetX Duo SNTP Client cannot support time updates simultaneously on multiple network interface.</span></span>

## <a name="sntp-and-ntp-rfcs"></a><span data-ttu-id="d7382-214">RFC для SNTP и NTP</span><span class="sxs-lookup"><span data-stu-id="d7382-214">SNTP and NTP RFCs</span></span>

<span data-ttu-id="d7382-215">Клиент SNTP для NetX Duo соответствует требованиям стандарта RFC4330 "Simple Network Time Protocol (SNTP) Version 4 for IPv4, IPv6 and OSI" (RFC4330. Протокол SNMP версии 4 для IPv4, IPv6 и OSI) и всех смежных RFC.</span><span class="sxs-lookup"><span data-stu-id="d7382-215">NetX Duo SNTP client is compliant with RFC4330 “Simple Network Time Protocol (SNTP) Version 4 for IPv4, IPv6 and OSI” and related RFCs.</span></span>