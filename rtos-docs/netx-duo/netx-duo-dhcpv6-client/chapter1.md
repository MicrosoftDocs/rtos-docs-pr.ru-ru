---
title: Глава 1. Введение в DHCPv6-клиент NetX Duo для ОСРВ Azure
description: В сетях IPv6 протокол DHCPv6 используется вместо DHCP для динамического назначения глобальных IP-адресов с сервера DHCPv6. Он поддерживает большинство прежних функций и предоставляет множество улучшений.
author: philmea
ms.author: philmea
ms.date: 06/04/2020
ms.topic: article
ms.service: rtos
ms.openlocfilehash: f938be404c121f3080cfed1a81aa356f698538c4f557387009d951df40496a6d
ms.sourcegitcommit: 93d716cf7e3d735b18246d659ec9ec7f82c336de
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/07/2021
ms.locfileid: "116791318"
---
# <a name="chapter-1---introduction-to-azure-rtos-netx-duo-dhcpv6-client"></a>Глава 1. Введение в DHCPv6-клиент NetX Duo для ОСРВ Azure

В сетях IPv6 протокол DHCPv6 используется вместо DHCP для динамического назначения глобальных IP-адресов с сервера DHCPv6. Он поддерживает большинство прежних функций и предоставляет множество улучшений. В этом документе подробно описано, как получать IPv6-адреса через API DHCPv6-клиента NetX Duo для ОСРВ Azure.

## <a name="dhcpv6-communication"></a>Обмен данными по протоколу DHCPv6

Протокол DHCPv6 использует UDP. Для обмена сообщениями DHCPv6-клиент использует порт 546, а сервер — порт 547. Клиент использует локальный адрес канала в качестве исходного адреса для отправки запросов DHCPv6 к доступным серверам DHCPv6. Когда клиент отправляет сообщения, предназначенные для всех серверов DHCPv6 в сети, он использует адрес многоадресной рассылки *All_DHCP_Relay_Agents_and_Servers*, который имеет значение *FF02::01:02*. Это зарезервированный адрес для многоадресной рассылки в области канала.

## <a name="dhcpv6-process-of-requesting-an-ipv6-address"></a>Процесс запроса IPv6-адреса по протоколу DHCPv6

Чтобы начать процесс запроса глобального IPv6-адреса, клиент отправляет сообщение SOLICIT с помощью службы *nx_dhcpv6_send_solicit*:

**UINT nx_dhcpv6_request_solicit(NX_DHCPV6 \*dhcpv6_ptr)**

Это сообщение отправляется на адрес *All_DHCP_Relay_Agents_and_Servers*, то есть на все доступные серверы. В запросе SOLICIT клиент может предоставить серверу указание с конкретными IPv6-адресами, которые он желает получить. Кроме того, он может включить в сообщение SOLICIT запрос параметра (Option Request), чтобы получить от сервера другие сведения о конфигурации сети, например адреса DNS-сервера, сервера NTP и т. п.

Сервер DHCPv6, который может обслужить этот запрос клиента, возвращает ему сообщение ADVERTISE с указанием IPv6-адресов, которые он может назначить клиенту, времени аренды этих IPv6-адресов и дополнительных сведений, запрошенных клиентом. Протокол DHCPv6-клиента требует, чтобы клиент определенное время ожидал сообщения ADVERTISE от всех серверов DHCPv6 в сети. Он предварительно обрабатывает каждое сообщение ADVERTISE как допустимое и изучает параметры DHCPv6 по полученным данным. Также он проверяет значение Preference в параметре Preference Option, если оно предоставлено сервером. Если получено несколько сообщений ADVERTISE, DHCPv6-клиент NetX выбирает сервер с самым высоким значением предпочтения из числа тех, которые предоставили ответы в пределах периода ожидания.

Исключением является ситуация, в которой клиент получает сообщение ADVERTISE со значением предпочтения 255. В этом случае он немедленно принимает это сообщение и отклоняет все последующие сообщения ADVERTISE.

Период ожидания определяется как период повторной передачи, в течение которого DHCPv6-клиент ожидает ответы. Если не получено ни одного ответа от серверов, по окончании этого периода клиент отправляет новое сообщение SOLICIT. Начальное время ожидания для повторной передачи в состоянии SOLICIT определяется для протокола DHCPv6 по стандарту RFC 3315 равным 1 секунде. Если DHCPv6-клиент не получает допустимого ответа от сервера, последующие интервалы повторной передачи удваиваются, но не превышают 120 секунд.

После выбора сервера клиент извлекает данные из сообщения ADVERTISE и отправляет выбранному серверу сообщение REQUEST, чтобы принять назначенные значения адреса и срока аренды. Сервер возвращает сообщение REPLY с подтверждением того, что переданные клиенту IPv6-адреса успешно зарегистрированы на сервере как выделенные этому клиенту.

DHCPv6-клиент регистрирует назначенные IPv6-адреса для экземпляра IP-адреса (например, NetX Duo). Если настроено использование протокола обнаружения дубликатов адресов (DAD, по умолчанию включен), NetX Duo автоматически отправит сообщения Neighbor Solicit для проверки того, что назначенные адреса уникальны в сети. Если проверка прошла успешно, он уведомляет DHCPv6-клиент о повышении уровня каждого назначенного адреса с TENTATIVE до VALID. DHCPv6-клиент переходит в состояние BOUND, и устройство может использовать полученный IPv6-адрес для отправки и передачи сообщений. Если протокол DAD возвращает ошибку, NetX Duo уведомляет об этом DHCPv6-клиент, который в свою очередь отправляет серверу сообщение DECLINE для полученных ранее IPv6-адресов и сбрасывает состояние DHCPv6-клиента до начальной инициализации (INIT).

### <a name="notification-of-successful-address-assignment-and-validation"></a>Уведомление об успешном назначении и проверке адреса

Приложение может определять результат запроса адресов для DHCPv6-клиента по изменениям состояния, если настроить на DHCPv6-клиенте обратные вызовы по изменению состояния с помощью службы *nx_dhcpv6_client_create*. Если ответов от сервера не получено, наблюдаемое состояние изменится с SOLICIT на INIT. Если от сервера получен ответ, но нет возможности выделить адреса, DHCPv6-клиент выполнит зарегистрированный для приложения обратный вызов по ошибке (также регистрируется через службу *nx_dhcpv6_client_create*). Если клиент достигает состояния BOUND, но не может пройти проверку DAD, состояние изменится с BOUND на INIT. Обратите внимание, что при использовании DAD приложение должно оставить достаточно времени для завершения проверки DAD с момента начала процесса запроса. Обычно на это требуется около 400–500 тактов (около 4-5 секунд в большинстве случаев).

### <a name="relinquishing-an-ipv6-address"></a>Освобождение IPv6-адреса

Если клиенту потребуется освободить назначенный ему IPv6-адрес, он информирует об этом сервер DHCPv6 путем вызова службы *nx_dhcpv6_request_release*:

### <a name="uint-nx_dhcpv6_request_releasenx_dhcpv6-dhcpv6_ptr"></a>UINT nx_dhcpv6_request_release(NX_DHCPV6 \*dhcpv6_ptr)

DHCPv6-клиент отправляет сообщение одноадресной рассылки RELEASE с назначенными адресами на тот сервер, который ранее назначил эти адреса, и ожидает сообщения REPLY с подтверждением получения этого сообщения сервером.

Примечание. Существует другой процесс для клиентов, которые отключаются от питания, но намерены после перезапуска сохранить назначенные IPv6-адреса для дальнейшего использования. Такой клиент не отправляет сообщение RELEASE при выключении питания, если не планирует запрашивать новый адрес после включения питания. Эта ситуация подробнее описана в разделе "Требования к энергонезависимой памяти".

### <a name="dhcpv6-lease-timeouts"></a>Истечение срока аренды DHCPv6

Аренда IPv6, предоставляемая сервером, содержит два параметра срока ожидания (T1 и T2) в каждом блоке IANA (сопоставления удостоверения для постоянных адресов). Стандарт IANA описан в других разделах этого руководства пользователя. Если с момента привязки DHCPv6-клиента к назначенному IPv6-адресу прошло время, равное T1, DHCPv6-клиент автоматически начинает процесс обновления IPv6-адреса, отправляя сообщение продления (RENEW). Если прошло время, равное T2, и клиент DHCPv6 не получил ответы на запросы RENEW, он автоматически отправляет сообщение REBIND.

Еще два параметра аренды IPv6 (предпочтительное и допустимое время существования) назначаются каждому блоку IA (сопоставления удостоверений), которые содержатся в блоках IANA. Предпочтительное и допустимое время существования обозначают периоды, после которых назначенный IPv6-адрес объявляется устаревшим или недопустимым, соответственно. Значение T1 должно быть меньше предпочтительного времени существования. Значение T2 должно быть меньше допустимого времени существования.

### <a name="ip-thread-task-requirements"></a>Требования к задачам для потока IP

DHCPv6-клиент NetX Duo требует создать экземпляр IP-адреса NetX Duo до того, как будет создан DHCPv6-клиент для использования клиентских служб DHCPv6.

Протоколы UDP, IPv6 и ICMPv6 должны быть включены для этого экземпляра IP, прежде чем применять DHCPv6-клиент.

  - *nx_udp_enable*

  - *nxd_ipv6_enable*

  - *nxd_icmp_enable*

### <a name="packet-pool-requirements"></a>Требования к пулу пакетов

Для создания DHCPv6-клиента NetX Duo требуется ранее созданный пул пакетов для отправки сообщений DHCPv6. Пользователь может настроить размер этого пула пакетов, указав размер полезных данных и количество доступных пакетов, с учетом ожидаемого объема сообщений DHCPv6 и других данных, которые будут отправляться приложением.

Размер обычного сообщения DHCPv6 составляет около 200 байтов в зависимости от количества IA-адресов и параметров DHCPv6, запрошенных клиентом.

### <a name="network-requirements"></a>Требования к сети

Для DHCPv6-клиента NetX Duo требуется создание сокета UDP, привязанного к порту 546. Этот сокет создается одновременно с задачей DHCPv6-клиента.

### <a name="non-volatile-memory-requirements"></a>Требования к энергонезависимой памяти

Если DHCPv6-клиент при выключении питания освобождает арендованный у сервера DHCPv6 IPv6-адрес и запрашивает новые IPv6-адреса после перезагрузки, наличие энергозависимой памяти не требуется. Если клиенту нужно сохранить назначенную аренду, он должен сохранять некоторые сведения о DHCPv6-клиенте в энергонезависимой памяти при перезагрузках.

Требования к долговременной памяти и API-интерфейсы DHCPv6-клиента подробнее обсуждаются в главе 2 руководства **Использование DHCPv6-клиента NetX Duo**.

### <a name="netx-duo-dhcpv6-client-limitations"></a>Ограничения DHCPv6-клиента NetX Duo

В текущем выпуске для DHCPv6-клиента NetX Duo действуют следующие ограничения:

  - DHCPv6-клиент NetX Duo не поддерживает возможность отправки одноадресных сообщений DHCPv6 на сервер DHCPv6, даже если это разрешено сервером.

  - DHCPv6-клиент NetX Duo не поддерживает запрос Reconfigure, в котором сервер сообщает об изменениях IPv6-адресов для клиентов в сети.

  - DHCPv6-клиент NetX Duo не поддерживает формат Enterprise для блока управления "Уникальный идентификатор DHCPv6". Он поддерживает только форматы "Канальный уровень" и "Канальный уровень и время".

  - DHCPv6-клиент NetX Duo не поддерживает запросы адресов по временным каналам связи (TA), но поддерживает запрос постоянных адресов (IANA).

## <a name="multihome-and-multiple-address-support"></a>Поддержка множественной адресации и нескольких адресов

DHCPv6-клиент поддерживает несколько интерфейсов и несколько адресов для каждого интерфейса. Служба DHCPv6-клиента *nx_dhcpv6_client_set_interface* позволяет клиентскому приложению задать сетевой интерфейс, через который приложение будет взаимодействовать с сервером DHCPv6. DHCPv6-клиент по умолчанию использует основной интерфейс (с нулевым индексом).

Для использования нескольких адресов на интерфейс DHCPv6-клиент поддерживает внутренний список адресов, которые нумеруются последовательно с индекса 0. Обратите внимание, что зарегистрированный в DHCPv6-клиенте адрес не обязательно получит тот же индекс в таблице IP-адресов для интерфейсов.

Некоторым службам DHCPv6-клиента, которые получают сведения об аренде IPv6-адреса для клиента, требуется указать индекс адреса. Ниже представлен пример получения периодов предпочтительного и допустимого времени существования адреса:

```C
UINT nx_dhcpv6_get_valid_ip_address_lease_time(NX_DHCPV6 *dhcpv6_ptr, 
                                              UINT address_index, 
                                              NXD_ADDRESS *ip_address,
                                              ULONG preferred_lifetime, 
                                              ULONG *valid_lifetime)
```

Клиентское приложение также может получить число допустимых назначенных IPv6-адресов, вызвав службу *nx_dhcpv6_get_valid_ip_address_count*:

```C
UINT nx_dhcpv6_get_valid_ip_address_count(NX_DHCPV6 *dhcpv6_ptr, 
                                          UINT *address_count)
```

Устаревшие службы DHCPv6-клиента, созданные до появления поддержки нескольких адресов в NetX Duo, не принимают индекс адреса. Поэтому для работы с такими службами запрошенные данные передаются через основной глобальный адрес IA независимо от того, сколько IA-адресов назначено клиенту. Пример приведен ниже.

```C
UINT nx_dhcpv6_get_IP_address(NX_DHCPV6 *dhcpv6_ptr, 
                              NXD_ADDRESS *ip_address)
```

## <a name="netx-duo-dhcpv6-client-callback-functions"></a>Функции обратного вызова в DHCPv6-клиенте NetX Duo

*nx_dhcpv6_state_change_callback*

Когда DHCPv6-клиент в результате обработки запроса DHCPv6 переходит в новое состояние DHCPv6, он уведомляет приложение через эту функцию обратного вызова.

*nx_dhcpv6_server_error_handler*

Когда DHCPv6-клиент получает в ответе сервера ненулевое значение параметра *Status* (Состояние), которое обозначает сбой выполнения, он уведомляет приложение через этот обратный вызов с указанием кода состояния ошибки сервера.

Примечание. Поскольку эти функции обратного вызова вызываются из задачи в потоке DHCPv6-клиента, клиентское приложение не должно вызывать службы DHCPv6-клиента NetX Duo, которые требуют управления мьютексом DHCPv6-клиента. К ним относятся *nx_dhcpv6_start, nx_dhcpv6_stop* и все API, которые отправляют сообщения непосредственно из обратного вызова, например *nx_dhcpv6_request_release*.

## <a name="dhcpv6-rfcs"></a>Стандарты RFC для DHCPv6

DHCP для NetX Duo соответствует требованиям RFC 3315, RFC 3646 и связанных с ними стандартов RFC.