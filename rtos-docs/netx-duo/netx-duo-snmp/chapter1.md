---
title: Глава 1. Введение в SNMP для NetX Duo в ОСРВ Azure
description: Реализация SNMP NetX Duo является агентом SNMP. Агент отвечает за реагирование на команды диспетчера SNMP и отправку ловушек, управляемых событиями.
author: philmea
ms.author: philmea
ms.date: 06/04/2020
ms.topic: article
ms.service: rtos
ms.openlocfilehash: 5760e35fdbe8d7b27e2ccc82abac37b1f6fb5118
ms.sourcegitcommit: e3d42e1f2920ec9cb002634b542bc20754f9544e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/22/2021
ms.locfileid: "104814575"
---
# <a name="chapter-1---introduction-to-azure-rtos-netx-duo-snmp"></a>Глава 1. Введение в SNMP для NetX Duo в ОСРВ Azure

Протокол SNMP — это протокол, предназначенный для управления устройствами в сети. Протокол SNMP для управляющей функции использует протокол UDP без контроля соединения. Реализация SNMP NetX Duo для ОСРВ Azure является агентом SNMP. Агент отвечает за реагирование на команды диспетчера SNMP и отправку ловушек, управляемых событиями. 

SNMP NetX Duo поддерживает обмен данными с диспетчерами SNMP по протоколам IPv4 и IPv6. Приложения SNMP NetX должны компилироваться и выполняться в SNMP NetX Duo. Однако разработчику рекомендуется перенести существующие SNMP-приложения на использование эквивалентных служб "Duo". Например, при отправке сообщений SNMP-ловушки следующие службы "Duo" должны заменить их эквиваленты NetX:

*nxd_snmp_object_trap_send*

*nxd_snmp_object_trapv2_send*

*nxd_snmp_object_trapv3_send*

Дополнительные сведения см. в разделах **Описание служб агента SNMP** в данном руководстве пользователя.

## <a name="netx-duo-snmp-agent-requirements"></a>Требования для агента SNMP NetX Duo

Для пакета SNMP NetX Duo требуется, чтобы заранее был создан экземпляр IP. Кроме того, в таком экземпляре IP должен быть включен протокол UDP.

Агент SNMP NetX Duo имеет несколько дополнительных требований. Во-первых, для обработки всех запросов диспетчером SNMP требуется доступ к порту 161. Также требуется доступ к порту 162 для отправки менеджеру сообщений ловушек.

Чтобы использовать агент SNMP NetX Duo по протоколу IPv6 и получать объекты IPv6, необходимо включить IPv6 в NetX Duo. Дополнительные сведения о включении в экземпляре IP поддержку служб IPv6 см. в ***Руководстве пользователя по NetX Duo***.

## <a name="netx-duo-snmp-constraints"></a>Ограничения SNMP NetX Duo

Протокол SNMP NetX Duo реализует SNMP версий 1, 2 и 3. Реализация SNMPv3 поддерживает проверку подлинности MD5 и SHA, а также шифрование DES. Эта версия агента SNMP NetX Duo имеет следующие ограничения.

1. Один агент SNMP на один экземпляр IP NetX.
2. Отсутствует поддержка RMON.
3. Информационные сообщения SNMP v3 не поддерживаются.
4. Типы данных OPAQUE и NSAP не поддерживаются.
5. Адреса IPv6 определяются как строки октетов, а проверка правильности форматирования лежит на приложении.

## <a name="snmp-object-names"></a>Имена объектов SNMP

Протокол SNMP предназначен для управления устройствами в сети. Для этого каждое устройство, управляемое SNMP, имеет набор объектов, определенных структурой управляющих данных (SMI), как это определено в документе RFC 1155. Структура представляет собой иерархический древовидный тип структуры, который выглядит следующим образом:

![Схема структуры данных управления.](media/image3.png)

Каждый узел дерева является объектом. Объект "dod" в дереве определяется нотацией 1.3.6, а объект "internet" в дереве определяется нотацией 1.3.6.1. Все имена объектов SNMP начинаются с нотации 1.3.6.

Диспетчер SNMP использует эту нотацию объектов, чтобы указать, какой объект на устройстве требуется получить или задать. Агент SNMP NetX Duo интерпретирует подобные запросы диспетчера и предоставляет приложениям механизмы для выполнения запрошенной операции.

## <a name="snmp-manager-requests"></a>Запросы диспетчера SNMP

Протокол SNMP имеет простой механизм управления устройствами. Существует набор стандартных команд SNMP, которые выдает диспетчер SNMP устройству SNMP через *порт 161*. Ниже приведены некоторые основные команды диспетчера SNMP.

| Команда SNMP | Значение                                                        |
|--------------|----------------------------------------------------------------|
| GET          | *Получить указанный объект*                                       |
| GETNEXT      | *Получить следующий логический объект после указанного идентификатора объекта*      |
| GETBULK      | *Получить несколько логических объектов после указанного идентификатора объекта* |
| SET          | *Установить указанный объект*                                       |

Эти команды кодируются в первой версии абстрактного синтаксиса данных (ASN.1) и размещаются в полезных данных пакета UDP, отправляемого диспетчером SNMP. Агент SNMP NetX Duo обрабатывает запрос, а затем вызывает соответствующую подпрограмму обработки, указанную в вызове ***nx_snmp_agent_create***.

## <a name="netx-duo-snmp-agent-traps"></a>Ловушки агента SNMP NetX Duo

Агент SNMP NetX Duo позволяет также асинхронно оповещать диспетчер SNMP о событиях. Это делается с помощью команды SNMP-ловушки. Для каждой версии SNMP существует свой уникальный API для отправки ловушек диспетчеру SNMP. По умолчанию ловушки отправляются диспетчеру SNMP по порту 162.

Агент SNMP NetX Duo предоставляет отдельные ключи безопасности для сообщений о ловушках протокола SNMPv3. Для этого SNMP-приложение должно создать отдельный набор ключей, применяемых к ответам на запросы диспетчера. Система безопасности ловушек позволяет агенту SNMP использовать одни и те же или разные пароли для проверки подлинности и конфиденциальности. Дополнительные сведения о создании ключей безопасности см. в разделе **Проверка подлинности и шифрование SNMP NetX Duo**.

Список стандартных переменных ловушек SNMP приведен в начале файла *nxd_snmp.h:*

| Переменные                                 | Значение  |
|-------------------------------------------|---|
| #define NX_SNMP_TRAP_COLDSTART            | 0 |
| #define NX_SNMP_TRAP_WARMSTART            | 1 |
| #define NX_SNMP_TRAP_LINKDOWN             | 2 |
| #define NX_SNMP_TRAP_LINKUP               | 3 |
| #define NX_SNMP_TRAP_AUTHENTICATE_FAILURE | 4 |
| #define NX_SNMP_TRAP_EGPNEIGHBORLOSS      | 5 |
| #define NX_SNMP_TRAP_ENTERPRISESPECIFIC   | 6 |

Чтобы включить эти переменные в сообщение ловушки, входному аргументу trap_type в *nx_snmp_agent_trapv2_send* (SNMPv2) или *nx_snmp_agent_trapv3_send* (SNMPv3) присваивается перечисляемое значение этих переменных. Ниже приведен пример уведомления диспетчера SNMP о событии холодного запуска для протокола SNMPv2:

```c
UINT trap_type = NX_SNMP_TRAP_COLDSTART;

status = nx_snmp_agent_trapv2_send(&my_agent, MIB_IP_ADDRESS,
                                  (UCHAR *)"public", trap_type,
                                  tx_time_get(), NX_NULL);

```

Чтобы включить в сообщение ловушки собственные переменные, входному аргументу trap_type присваивается значение NX_SNMP_TRAP_CUSTOM и входной аргумент списка ловушек содержит собственные данные. Обратите внимание, что сообщение ловушки будет содержать время доступности системы (1.3.6.1.6.3.1.1.4.1.0). Ниже приведен пример для протокола SNMPv2:

```c
NX_SNMP_TRAP_OBJECT trap_list[3];
NX_SNMP_OBJECT_DATA trap_data0;

    /* Load the data into the OBJECT. */
    nx_snmp_object_id_get((void*)"1.3.6.1.4.1.7428.1.3.2.0", &trap_data0);

    /* Update the Trap Object with the object and OID. */
    trap_list[0].nx_snmp_object_string_ptr = (UCHAR *)"1.3.6.1.6.3.1.1.4.0";
    trap_list[0].nx_snmp_object_data  = &trap_data0;

    /* Null terminate the trap list. */
    trap_list[1].nx_snmp_object_string_ptr = NX_NULL;

    status = nx_snmp_agent_trapv2_send(&my_agent, MIB_IP_ADDRESS,
                                      (UCHAR *)"trapduo",
                                      NX_SNMP_TRAP_CUSTOM,
                                      tx_time_get(), trap_list);
```

## <a name="netx-duo-snmp-authentication-and-encryption"></a>Проверка подлинности и шифрование SNMP NetX Duo

Различают две разновидности проверки подлинности: *обычную* и *с использованием дайджеста*. Обычная проверка подлинности эквивалентна простой проверке подлинности *имени пользователя* в обычном текстовом формате во многих протоколах. При обычной проверке подлинности SNMP пользователь просто проверяет допустимость заданного имени пользователя для выполнения операций SNMP. Обычная проверка подлинности является единственным вариантом для SNMP версий 1 и 2.

Основным недостатком обычной проверки подлинности является то, что имя пользователя передается в виде обычного текста. Дайджест-проверка подлинности SNMPv3 решает эту проблему и никогда не передает имя пользователя в виде обычного текста. Вместо этого используется определенный алгоритм для получения 96-разрядного "дайджеста" из имени пользователя, обработчика контекста и других сведений. Агент SNMP NetX Duo поддерживает алгоритмы дайджестов MD5 и SHA.

Чтобы включить проверку подлинности, агент SNMP должен задать идентификатор обработчика контекста с помощью службы *nx_snmp_agent_context_engine_set*. Идентификатор обработчика контекста используется при создании ключа проверки подлинности.

Шифрование данных SNMPv3 доступно с использованием алгоритма DES. Шифрование требует включения проверки подлинности (нельзя шифровать данные без настройки параметров проверки подлинности).

Для создания ключей проверки подлинности и конфиденциальности используются следующие API:

```c
UINT  _nx_snmp_agent_md5_key_create(NX_SNMP_AGENT *agent_ptr,
                                    UCHAR *password, NX_SNMP_SECURITY_KEY
                                   *destination_key)

UINT  _nx_snmp_agent_sha_key_create(NX_SNMP_AGENT *agent_ptr,
                                    UCHAR *password, NX_SNMP_SECURITY_KEY
                                   *destination_key)
```

Затем необходимо настроить агент SNMP для использования этих ключей. Чтобы зарегистрировать ключ в агенте SNMP, используются следующие API:

```c
UINT  _nx_snmp_agent_authenticate_key_use(NX_SNMP_AGENT *agent_ptr,
                                          NX_SNMP_SECURITY_KEY *key)

UINT  _nx_snmp_agent_privacy_key_use(NX_SNMP_AGENT *agent_ptr,
                                    NX_SNMP_SECURITY_KEY *key)
```

Для сообщений о ловушках можно создавать отдельные ключи. Для применения ключей к сообщениям ловушки доступны следующие API:

```c
UINT  _nx_snmp_agent_auth_trap_key_use(NX_SNMP_AGENT *agent_ptr,
                                       NX_SNMP_SECURITY_KEY *key)

UINT  _nx_snmp_agent_priv_trap_key_use(NX_SNMP_AGENT *agent_ptr,
                                       NX_SNMP_SECURITY_KEY *key)
```

Чтобы отключить проверку подлинности или шифрование для ответных сообщений и отправки ловушек, используйте эти службы с входными указателями ключей, установленными в значение NULL.

## <a name="netx-duo-snmp-community-strings"></a>Строки сообщества SNMP NetX Duo

Агент SNMP NetX Duo поддерживает как общедоступные, так и закрытые строки сообщества. Открытая строка задается с помощью службы *nx_snmp_agent _public_string_set*. Закрытая строка агента SNMP NetX Duo задается с помощью службы *nx_snmp_agent_private_string_set*.

## <a name="netx-duo-snmp-username-callback"></a>Обратный вызов имени пользователя SNMP NetX Duo

Пакет агента SNMP NetX Duo позволяет приложению указать (с помощью вызова ***nx_snmp_agent_create***) обратный вызов имени пользователя, который вызывается в начале обработки каждого запроса SNMP-клиента.

Подпрограммы обратного вызова предоставляют агенту SNMP NetX Duo имя пользователя. Если указанное имя пользователя является допустимым или проверка имени пользователя не требуется для ответа на запрос, функция обратного вызова имени пользователя должна возвращать значение **NX_SUCCESS**. В противном случае подпрограмма должна возвращать **NX_SNMP_ERROR**, чтобы указать, что указанное имя пользователя является недопустимым.

Формат подпрограммы обратного вызова имени пользователя приложения приведен ниже:

```c
UINT nx_snmp_agent_username_process(NX_SNMP_AGENT *agent_ptr,
                                    UCHAR *username);
```

Входные параметры определяются следующим образом:

| Параметр | Значение                                              |
|-----------|------------------------------------------------------|
| *agent_ptr* | Указатель на вызывающий агент SNMP                        |
| username  | Назначение для указателя на требуемое имя пользователя |

Для сеансов протоколов SNMPv1 и SNMPv2/v2C приложение захочет проверить строку сообщества во входящем SNMP-запросе, чтобы определить, имеет ли SNMP-запрос допустимую строку сообщества. Для этого приложения SNMP существует несколько служб.есть несколько служб.

Приложение SNMP может запросить, является ли текущий запрос диспетчера SNMP запросом GET (например, GET, GETNEXT или GETBULK) или запросом SET, используя следующую службу:

```c
UINT nx_snmp_agent_request_get_type_test(NX_SNMP_AGENT *agent_ptr,
                                         UINT *is_get_type);
```

Если запрос является типом GET, приложение может сравнить входную строку сообщества с общедоступной строкой SNMP-агента:

```c
UINT nx_snmp_agent_public_string_test(NX_SNMP_AGENT *agent_ptr,
                                      UCHAR *username,
                                      UINT *is_public);
```

Аналогично, если запрос является типом SET, приложение может сравнить входную строку сообщества с закрытой строкой SNMP-агента:

```c
UINT nx_snmp_agent_private_string_test(NX_SNMP_AGENT *agent_ptr,
                                       UCHAR *username,
                                       UINT *is_private);
```

Возвращаемые значения is_public и is_private указывают, является ли входная строка сообщества допустимой общедоступной или закрытой строкой сообщества соответственно.

Возвращаемое значение подпрограммы обратного вызова имени пользователя указывает, является ли имя пользователя допустимым. Значение **NX_SUCCESS** возвращается, если имя пользователя является допустимым, а **NX_SNMP_ERROR** — если имя пользователя является недопустимым.

## <a name="netx-duo-snmp-agent-get-callback"></a>Обратный вызов GET для агента SNMP NetX Duo

Приложение должно задать подпрограммы обратного вызова для обработки запросов объектов GET от диспетчера SNMP. Обратный вызов извлекает значение объекта, указанного в запросе.

Подпрограмма обратного вызова запроса GET приложения определена ниже.

```c
UINT nx_snmp_agent_get_process(NX_SNMP_AGENT *agent_ptr,
                               UCHAR *object_requested,
                               NX_SNMP_OBJECT_DATA *object_data);
```

Входные параметры определяются следующим образом:

| Параметр        | Значение |
|------------------|----------------------------------|
| *agent_ptr*        | Указатель на вызывающий агент SNMP |
| object_requested | Строка ASCII, представляющая идентификатор объекта, для которого предназначена операция GET. |
| object_data      | Структура данных для хранения значения, полученного функцией обратного вызова. Эту задачу можно выполнить с помощью ряда API SNMP NetX Duo, описанных ниже. |

> [!NOTE]
> *Для строк октетов объекту должна быть назначена длина, чтобы ее значение знала внутренняя функция, так как сам обратный вызов не имеет аргумента длины:*

```c
object_data -> nx_snmp_object_octet_string_size = mib2_mib[i].length;
```

Поскольку обратному вызову GET неизвестен тип данных, нет необходимости проверять тип данных. Длина не будет оказывать влияния на числовые типы и строки с разделителями null.

Затем вызовите внутреннюю функцию:

```c
status = mib2_mib[i].object_get_callback)
                   (mib2_mib[i].object_value_ptr, object_data);
```

Если функции обратного вызова не удается найти запрошенный объект, должен возвращаться код ошибки **NX_SNMP_ERROR_NOSUCHNAME**. Если обнаружена какая-либо другая ошибка, возвращается **NX_SNMP_ERROR**.

## <a name="netx-duo-snmp-agent-getnext-callback"></a>Обратный вызов GETNEXT для агента SNMP NetX Duo

Приложение также должно задать подпрограммы обратного вызова для запросов объектов GETNEXT из диспетчера SNMP. Обратный вызов GETNEXT извлекает значение следующего объекта, указанного в запросе.

Подпрограмма обратного вызова запроса GETNEXT приложения определена ниже:

```c
UINT nx_snmp_agent_getnext_process(NX_SNMP_AGENT *agent_ptr,
                                   UCHAR *object_requested,
                                   NX_SNMP_OBJECT_DATA *object_data);
```

Входные параметры определяются следующим образом:

| Параметр        | Значение |
|------------------|-------------------------------------------|
| *agent_ptr*        | Указатель на вызывающий агент SNMP |
| object_requested | Строка ASCII, представляющая идентификатор объекта, для которого предназначена операция GETNEXT. |
| object_data      | Структура данных для хранения значения, полученного функцией обратного вызова. Эту задачу можно выполнить с помощью ряда API SNMP NetX Duo, описанных ниже. |

Так же, как и для обратных вызовов GET, для строк октетов объекту должна быть назначена длина, чтобы ее значение знала внутренняя функция, так как сам обратный вызов не имеет аргумента длины:

```c
object_data -> nx_snmp_object_octet_string_size = mib2_mib[i].length;
```

Поскольку обратному вызову GET неизвестен тип данных, нет необходимости проверять тип данных. Длина не будет оказывать влияния на числовые типы и строки с разделителями null.

Затем вызовите внутреннюю функцию:

```c
status = mib2_mib[i].object_get_callback)
                   (mib2_mib[i].object_value_ptr, object_data);
```

Если функции обратного вызова не удается найти запрошенный объект, должен возвращаться код ошибки **NX_SNMP_ERROR_NOSUCHNAME**. Если обнаружена какая-либо другая ошибка, возвращается **NX_SNMP_ERROR**.

## <a name="netx-duo-snmp-agent-set-callback"></a>Обратный вызов SET для агента SNMP NetX Duo

Приложение должно задать подпрограммы обратного вызова для обработки запросов объектов SET от диспетчера SNMP. Обратный вызов SET задает значение объекта, указанного в запросе.

Подпрограмма обратного вызова запроса SET приложения определена ниже:

```c
UINT nx_snmp_agent_set_process(NX_SNMP_AGENT *agent_ptr,
                               UCHAR *object_requested,
                               NX_SNMP_OBJECT_DATA *object_data);
```

Входные параметры определяются следующим образом:

| Параметр        | Значение |
|------------------|-------- |
| *agent_ptr*      | Указатель на вызывающий агент SNMP |
| object_requested | Строка ASCII, представляющая идентификатор объекта, для которого предназначена операция SET. |
| object_data      | Структура данных, содержащая новое значение для указанного объекта. Непосредственно операцию можно выполнить с помощью API SNMP NetX Duo, описанных ниже. |

Обратите внимание, что для строк октета обратный вызов SET должен обновить таблицу MIB, указав длину данных, так как агент SNMP проанализировал данные и знает их тип и длину:

```c
if (object_data -> nx_snmp_object_data_type ==
                           NX_SNMP_ANS1_OCTET_STRING)
{
    mib2_mib[i].length =
        object_data -> nx_snmp_object_octet_string_size;
}

object_data -> nx_snmp_object_octet_string_size =
                                 mib2_mib[i].length;
```

Если функции обратного вызова не удается найти запрошенный объект, должен возвращаться код ошибки **NX_SNMP_ERROR_NOSUCHNAME**.

Если узел SNMP NetX Duo создал закрытые строки сообщества, а SNMP-отправитель запроса SET не имеет совпадающей закрытой строки, то может возвращаться ошибка **NX_SNMP_ERROR_NOACCESS**. Если обнаружена какая-либо другая ошибка, возвращается **NX_SNMP_ERROR**.

> [!NOTE]
> *Несмотря на то, что агент SNMP NetX Duo предоставляет базу данных MIB SNMP вместе с дистрибутивом, она предназначен главным образом для тестирования и разработки. Разработчику, скорее всего, потребуется собственная база данных MIB для профессионального использования SNMP.*

## <a name="changing-snmp-version-at-run-time"></a>Изменение версии SNMP во время выполнения

Узел агента SNMP может изменить версию SNMP на любую из трех версий во время выполнения с помощью службы *nx_snmp_agent_set_version*. По умолчанию агент SNMP включен для работы со всеми тремя версиями при его создании в *nx_snmp_agent_create*. Однако приложение может ограничить использование некоторым подмножеством версий.

> [!NOTE]
> *Если определены параметры конфигурации NX_SNMP_DISABLE_V1, NX_SNMP_DISABLE_V2 и (или) NX_SNMP_DISABLE_V3, эта функция не сможет включить соответствующие версии.*

Агент SNMP может получить версию SNMP последнего полученного пакета SNMP с помощью службы *nx_snmp_agent_get_current_version*.

## <a name="snmpv3-discovery"></a>Обнаружение SNMPv3

Агент SNMP, если у него включена поддержка SNMPv3, будет отвечать на запросы обнаружения от диспетчера SNMP. Такой запрос содержит данные параметров безопасности со значениями NULL для идентификатора подсистемы авторизации, имени пользователя, количества загрузки и времени загрузки. Параметры проверки подлинности не применяются к сообщению обнаружения DISCOVERY. Список привязок переменных в таком запросе пуст (не содержит элементов). Агент SNMP реагирует с нулевым временем и количеством загрузок, а также списком привязок переменных, содержащим 1 элемент *usmStatsUnknownEngineIDs*, который представляет собой количество запросов, полученных с неизвестным идентификатором подсистемы (null). В последующем запросе GETNEXT от обозревателя или диспетчера параметры данных загрузки и параметры безопасности заполняются только в том случае, если включена безопасность. Если безопасность включена, то также будет отправлено обновление данных NotInTime в PDU. Параметры безопасности, например проверка подлинности, подтверждают личность агента для диспетчера.

Более подробные сведения о проверке подлинности SNMPv3 доступны в документе RFC 3414 "Модель безопасности на основе пользователей (USM) для версии 3 протокола простого сетевого управления (SNMPv3)".

## <a name="netx-duo-snmp-rfcs"></a>Документы RFC для SNMP NetX Duo

Протокол SNMP NetX Duo совместим с RFC1155, RFC1157, RFC1215, RFC1901, RFC1905, RFC1906, RFC1907, RFC1908, RFC2571, RFC2572, RFC2574, RFC2575, RFC3414 и связанными с ними документами RFC.
