---
title: Глава 1. Введение в клиент DNS NetX Duo для ОСРВ Azure
description: Служба DNS предоставляет распределенную базу данных, которая содержит сведения о сопоставлении между доменными именами и физическими IP-адресами.
author: philmea
ms.author: philmea
ms.date: 06/04/2020
ms.topic: article
ms.service: rtos
ms.openlocfilehash: e878d32d6bcf514bb75a76b51e66c4d267b1a5b34f6c4b2df6ab231e5814ffc5
ms.sourcegitcommit: 93d716cf7e3d735b18246d659ec9ec7f82c336de
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/07/2021
ms.locfileid: "116792064"
---
# <a name="chapter-1---introduction-to-the-azure-rtos-netx-duo-dns-client"></a>Глава 1. Введение в клиент DNS NetX Duo для ОСРВ Azure

Служба DNS предоставляет распределенную базу данных, которая содержит сведения о сопоставлении между доменными именами и физическими IP-адресами. База данных называется *распределенной*, так как в Интернете нет единой сущности, содержащей полные сведения о сопоставлении. Сущность, которая обслуживает часть сведений о сопоставлении, называется DNS-сервером. Интернет состоит из многочисленных DNS-серверов, каждый из которых содержит подмножество указанной базы данных. DNS-серверы также отвечают на запросы клиентов DNS на предоставление сведений о сопоставлении доменных имен, только если соответствующий сервер содержит запрошенное сопоставление.

Протокол клиента DNS для NetX Duo предоставляет приложению службы для запроса сведений о сопоставлении с одного DNS-сервера или нескольких.

## <a name="dns-client-setup"></a>Установка клиента DNS

Для правильной работы пакета клиента DNS требуется, чтобы экземпляр IP в NetX Duo уже был создан.

После создания клиента DNS приложение должно добавить один DNS-сервер или несколько в список серверов, обслуживаемый клиентом DNS. Для добавления DNS-серверов приложение использует службу *nxd_dns_server_add*. Службу *nx_dns_server_add* клиента NetX Duo также можно использовать для добавления серверов. Однако она принимает только IPv4-адреса, поэтому разработчикам рекомендуется использовать вместо этого службу *nxd_dns_server_add*.

Если параметр NX_DNS_IP_GATEWAY_SERVER включен, а адрес шлюза экземпляра IP-адреса не равен нулю, то шлюз экземпляра IP-адреса автоматически добавляется в качестве основного DNS-сервера. Если сведения о DNS-сервере не заданы статически, их также можно получить с помощью протокола DHCP для NetX Duo. Дополнительные сведения см. в руководстве пользователя по DHCP для NetX Duo.

Клиенту DNS нужен пул пакетов для передачи сообщений DNS. По умолчанию клиент DNS создает этот пул пакетов при вызове службы *nx_dns_create*. Параметры конфигурации NX_DNS_PACKET_PAYLOAD_UNALIGNED и NX_DNS_PACKET_POOL_SIZE позволяют приложению определить полезные данные пакета и размер (то есть число пакетов) этого пула пакетов соответственно. Эти параметры описаны в разделе "Параметры конфигурации" главы 2.

Альтернативой клиенту DNS, создающему свой пул пакетов, является создание приложением пула пакетов и его назначение в качестве пула пакетов клиента DNS с помощью службы *nx_dns_packet_pool_set*. Для этого необходимо определить параметр NX_DNS_CLIENT_USER_CREATE_PACKET_POOL. Этот параметр также требует ранее созданный с помощью *nx_packet_pool_create* пул пакетов, используемый в качестве входных данных указателя пула пакетов для *nx_dns_packet_pool_set*. При удалении экземпляра клиента DNS приложение отвечает за удаление пула пакетов клиента DNS, если он больше не требуется, когда включен параметр NX_DNS_CLIENT_USER_CREATE_PACKET_POOL.

> [!NOTE] 
> Для приложений, которые предоставляют собственный пул пакетов с помощью параметра NX_DNS_CLIENT_USER_CREATE_PACKET_POOL, размер пакета должен вмещать в себя сообщение DNS максимального размера (512 байт), а также заголовок UDP, заголовок IPv4 или IPv6 и заголовок MAC.

## <a name="dns-messages"></a>Сообщения DNS

DNS имеет очень простой механизм получения сопоставления между именами узлов и IP-адресами. Чтобы получить сопоставление, клиент DNS подготавливает сообщение запроса DNS, содержащее имя или IP-адрес, которые необходимо разрешить. Затем сообщение отправляется на первый DNS-сервер в списке серверов. Если сервер содержит такое сопоставление, он отвечает клиенту DNS, используя ответное сообщение DNS, содержащее запрошенные сведения о сопоставлении. Если сервер не отвечает, клиент DNS отправляет запрос следующему серверу в списке, пока не будут запрошены все DNS-серверы. Если не получен ответ ни от одного из DNS-серверов, клиент DNS использует логику повторных попыток для повторной передачи сообщения DNS. При повторной отправке запроса DNS время ожидания повторной передачи удваивается. Этот процесс продолжает до тех пор, пока не будет достигнуто максимальное время ожидания передачи (определенное NX_DNS_MAX_RETRANS_TIMEOUT в *nxd_dns.h*) или пока не будет получен успешный ответ от такого сервера.

Клиент DNS NetX Duo может выполнять операции поиска IPv6-адресов (типа AAAA) и IPv4-адресов (типа A), указывая версию IP-адреса в вызове *nxd_dns_host_by_name_get*. Клиент DNS может выполнять обратный просмотр IP-адресов (запросы типа PTR) для получения имен веб-узлов с помощью *nxd_dns_host_by_address_get*. Клиент DNS NetX Duo по-прежнему поддерживает службы *nx_dns_host_by_name_get* и *nx_dns_host_by_address_get*, которые являются эквивалентными, но ограничены только соединениями по протоколу IPv4. Однако разработчикам рекомендуется перевести существующие клиентские приложения DNS на использование служб *nxd_dns_host_by_name_get* и *nxd_dns_host_by_address_get*.

Служба обмена сообщениями DNS использует протокол UDP для отправки запросов и ответов полей. DNS-сервер прослушивает номер порта 53 на предмет запросов от клиентов. Поэтому в NetX Duo с помощью службы ***nx_udp_enable** _ должны быть включены службы UDP для ранее созданного экземпляра IP (_*_nx_ip_create_**).

На этом этапе клиент DNS готов принимать запросы от приложения и отправлять запросы DNS.

## <a name="extended-dns-resource-record-types"></a>Расширенные типы записей ресурсов DNS

Если параметр NX_DNS_ENABLE_EXTENDED_RR_TYPES включен, клиент DNS для NetX Duo также поддерживает запросы следующих типов записей.

- CNAME: содержит каноническое имя для псевдонима.
- TXT: содержит текстовую строку.
- NS: содержит полномочный сервер доменных имен.
- SOA: содержит начало зоны.
- MX: используется для обмена электронной почтой.
- SRV: содержит сведения о службе, предоставляемой доменом.

За исключением типов записей CNAME и TXT, приложение должно предоставить 4-байтовый выровненный буфер для получения записи данных DNS.

В клиенте DNS для NetX Duo данные записи хранятся таким образом, чтобы наиболее эффективно использовать место в буфере.

Ниже приведен пример буфера записей фиксированной длины (запись типа AAAA).

![Буфер записей фиксированной длины](media/image2.png)

Для тех запросов, типы записей которых имеют переменную длину данных, как, например, записи NS, у которых имена узлов имеют переменную длину, клиент DNS для NetX Duo сохраняет данные следующим образом. Буфер, заданный в запросе клиента DNS, организован в виде области данных фиксированной длины и области неструктурированной памяти. Верхняя часть буфера памяти поделена на 4-байтовые выровненные элементы записи. Каждый элемент записи содержит IP-адрес и указатель на данные переменной длины для этого IP-адреса. Данные переменной длины для каждого IP-адреса хранятся в области неструктурированной памяти, начиная с конца буфера памяти. Данные переменной длины для каждого последующего элемента записи сохраняются в следующей области памяти, примыкающей к данным переменной длинны предыдущих элементов записи. Таким образом, данные переменной длины "нарастают" в сторону области структурированной памяти, содержащей элементы записи, до тех пор, пока не перестанет хватать памяти для сохранения очередного элемента записи и данных переменной длины.

Это показано ниже.

![Рис. 2](media/image3.png)

Выше приведен пример хранилища данных доменных имен DNS (NS).

Запросы клиента DNS для NetX Duo, использующие формат хранения записей, возвращают число записей, сохраненных в буфере записи. Эта информация позволяет приложению извлекать записи NS из буфера записей.

Ниже приведен пример запроса клиента DNS, который сохраняет данные переменной длины DNS с помощью этого формата хранения записей.

```C
UINT  _nx_dns_domain_name_server_get(NX_DNS *dns_ptr, 
                    UCHAR *host_name, VOID *record_buffer, 
                    UINT buffer_size, UINT *record_count, 
                    ULONG wait_option);
```


Дополнительные сведения см. в главе 3, "Описание служб клиента DNS".

## <a name="dns-cache"></a>Кэш DNS

Если параметр NX_DNS_CACHE_ENABLE включен, клиент DNS для NetX Duo поддерживает функцию кэша DNS. После создания клиента DNS приложение может вызвать API *nx_dns_cache_initialize()* , чтобы задать специальный кэш DNS. Если включить функцию кэша DNS, клиент DNS выполнит поиск доступного ответа в кэше DNS перед началом отправки запроса DNS. При нахождении доступного ответа он возвращается напрямую приложению, в противном случае клиент DNS отправляет сообщение запроса на DNS-сервер и ждет ответа. Когда клиент DNS получает ответное сообщение и доступен свободный кэш, клиент DNS возвращает ответ приложению, а также добавляет этот ответ в качестве записи ресурса в кэш DNS.

Каждый ответ представляет собой структуру данных *NX_DNS_RR* (запись ресурса) в кэше. Строки (данные и имя записи ресурса) в записях имеют переменную длину, поэтому не хранятся в структуре NX_DNS_RR. Запись содержит указатели на фактическую область памяти, в которой хранятся строки. Таблица строк и записи используют кэш совместно. Записи хранятся в начале кэша и нарастают по направлению к его концу. Таблица строк начинается с конца кэша и нарастает в сторону его начала. Каждая строка в таблице строк имеет поле длины и поле счетчика. Если при добавлении строки в таблицу строк там уже присутствует такая же строка, значение счетчика увеличивается, а память для строки не выделяется. Кэш считается заполненным, если в него больше нельзя добавить записи ресурсов или новые строки.

## <a name="dns-client-limitations"></a>Ограничения клиента DNS

Клиент DNS поддерживает выполнение одного запросу DNS за раз. Потоки, пытающиеся выполнить другой запрос DNS, временно блокируются до завершения предыдущего запроса DNS.

Клиент DNS для NetX Duo не использует данные из заслуживающих доверия ответов для пересылки дополнительных запросов DNS на другие DNS-серверы.

## <a name="dns-rfcs"></a>Документы RFC по DNS

Служба DNS для NetX Duo соответствует следующим документам RFC.

- RFC1034. ДОМЕННЫЕ ИМЕНА — ПОНЯТИЯ И ВОЗМОЖНОСТИ
- RFC1035. ДОМЕННЫЕ ИМЕНА — РЕАЛИЗАЦИЯ И СПЕЦИФИКАЦИЯ
- RFC1480. Домен США
- RFC 2782. Запись ресурса DNS для указания расположения служб (DNS SRV)
- RFC 3596. Расширения DNS для поддержки протокола IP версии 6