---
title: Глава 1. Введение в POP3 для NetX (ОСРВ Azure)
description: API клиента POP3 для NetX Duo предоставляет почтовую транспортную систему, которая позволяет небольшим рабочим станциям обращаться к почтовым ящикам клиента на POP3-серверах для получения почты клиента.
author: philmea
ms.author: philmea
ms.date: 07/09/2020
ms.topic: article
ms.service: rtos
ms.openlocfilehash: 4d41da1e1e87e59c5c40674a58b288ac62ec8c78
ms.sourcegitcommit: e3d42e1f2920ec9cb002634b542bc20754f9544e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/22/2021
ms.locfileid: "104814619"
---
# <a name="chapter-1---introduction-to-azure-rtos-netx-pop3"></a>Глава 1. Введение в POP3 для NetX (ОСРВ Azure)

Протокол POP3 (Post Office Protocol Version 3) предназначен для организации почтовой транспортной системы, позволяющей небольшим рабочим станциям обращаться к почтовым ящикам клиента на POP3-серверах для получения почты клиента. Для передачи почты протокол POP3 использует службы протокола TCP. Благодаря этому POP3 считается очень надежным протоколом для обмена содержимым.

Но протокол POP3 не предоставляет сложных операций для обработки почты. Как правило, почта скачивается клиентом, а затем удаляется из почтового ящика на сервере.

## <a name="netx-duo-pop3-client-requirements"></a>Требования к использованию клиента POP3 для NetX Duo

### <a name="client-requirements"></a>Требования клиента

Для использования API клиента POP3 для NetX требуется экземпляр IP для NetX Duo, созданный с помощью *nx_ip_create*, и пул пакетов NetX, созданный с помощью *nx_packet_pool_create*. Так как клиент POP3 для NetX Duo применяет службы TCP, перед использованием API клиента POP3 для NetX Duo необходимо включить протокол TCP на этом же экземпляре IP с помощью вызова *nx_tcp_enable*. Клиент POP3 использует TCP-сокет для подключения к серверу POP3 через порт POP3 сервера. Обычно это *хорошо известный порт 110, хотя ни клиент, ни сервер POP3 не обязаны использовать именно его.*

Размер пула пакетов, используемого при создании клиента POP3, настраивается пользователем с учетом полезных данных пакета и количества доступных пакетов. Если пакет используется только в службе создания клиента POP3, полезная нагрузка пакета не должна превышать 100–120 байтов в зависимости от длины имени пользователя и пароля или дайджеста APOP. Возможно, команда USER с именем пользователя локального узла будет самым длинным сообщением, отправляемым клиентом POP3. При создании пула пакетов IP по умолчанию (nx_ip_create) можно использовать тот же пул пакетов, так как для выполнения внутренних операций IP не требуется слишком большая полезная нагрузка пакетов для отправки и получения управляющих данных TCP.

Но драйвер Ethernet не получит никаких преимуществ от использования того же пула пакетов, который настроен для клиента POP3. Как правило, полезные данные пула пакетов получения задаются с помощью MTU экземпляра IP (обычно 1500 байтов) сетевого интерфейса, размер которого значительно превышает размер сообщений клиента POP3. Как правило, входящие сообщения POP3 имеют гораздо больший объем данных, чем исходящие сообщения клиента POP3.

## <a name="netx-duo-pop3-client-creation"></a>Создание клиента POP3 для NetX Duo

Существует две службы для создания клиента POP3. Мы рекомендуем использовать *nxd_pop3_client_create*, которая принимает тип данных адреса (NXD_ADDRESS) с поддержкой IPv4- и IPv6-адресов сервера POP3. Другая служба создания клиента POP3, *nx_pop3_client_create*, принимает только IPv4-адреса сервера POP3. Обе службы привязывают порт сокета TCP и подключаются к серверу POP3.

После подключения к серверу POP3 приложение клиента POP3 может вызвать службу *nx_pop3_client _mail_items_get*, чтобы получить количество почтовых элементов, находящихся в его почтовом ящике.

```C
UINT nx_pop3_client_mail_items_get(NX_POP3_CLIENT *client_ptr,
    UINT *number_mail_items, ULONG *maildrop_total_size);
```

Если в почтовом ящике клиента есть один или несколько элементов, приложение может получить размер определенного элемента почты с помощью службы *nx_pop3_client_get_mail_item*:

```C
UINT nx_pop3_client_mail_item_get(NX_POP3_CLIENT *client_ptr,
    UINT mail_item, ULONG *item_size);
```

Первый элемент почты в почтовом ящике находится по индексу 1.

Чтобы получить реальное почтовое сообщение, приложение может вызывать службу *nx_pop3_client_mail_item_get_message_data* и получать пакеты почтовых сообщений, пока служба не сообщит о передаче последнего пакета с помощью входного аргумента final_packet.

```C
UINT nx_pop3_client_mail_item_message_get(
    NX_POP3_CLIENT *client_ptr,
    NX_PACKET **recv_packet_ptr,
    ULONG *bytes_retrieved,
    UINT *final_packet);
```

Чтобы удалить определенный элемент электронной почты, приложение вызывает службу *nx_pop3_client_mail_item_delete* с тем же индексом, который использовался в предыдущем вызове службы *nx_pop3_client_get_mail_item*.

Клиент можно удалить с помощью службы *nx_pop3_client_delete*. Обратите внимание, что приложение должно самостоятельно удалить пул пакетов клиента POP3 помощью службы *nx_packet_pool_delete*, если этот пул больше не нужен.

## <a name="netx-duo-pop3-client-constraints"></a>Ограничения клиента POP3 для NetX Duo

В реализации клиента POP3 для NetX Duo существуют некоторые ограничения:

1. Клиент POP3 для NetX Duo не поддерживает команду AUTH, хотя и реализует проверку подлинности APOP, используя DIGEST-MD5 для проверки подлинности клиента и сервера.
2. Клиент POP3 для NetX Duo не поддерживает некоторые команды POP3 (например, TOP или UIDL). Ниже приведен список поддерживаемых команд:
   - NOOP
   - RSET

## <a name="netx-duo-pop3-client-login"></a>Выполнение входа для клиента POP3 для NetX Duo

Для получения доступа к почтовому ящику клиент POP3 для NetX Duo должен пройти на сервере POP3 проверку подлинности по имени. Для этого можно в команде USER/PASS передать имя пользователя и пароль, известные серверу POP3, или в команде APOP передать дайджест MD5, как описано ниже.

Имя пользователя обычно является полным доменным именем (содержит компоненты локального имени и доменного имени, разделенные символом @). При использовании команд POP3 USER и PASS клиент отправляет имя пользователя и пароль в незашифрованном виде через Интернет.

Чтобы избежать угрозы безопасности, связанной с отправкой имени пользователя и пароля в виде открытого текста, для клиента POP3 для NetX Duo можно настроить проверку подлинности APOP, задав параметр *APOP_authentication* в службе *nx_pop3_client_create*.

```C
UINT nxd_pop3_client_create(NX_POP3_CLIENT *client_ptr,
    UINT APOP_authentication,
    NX_IP *ip_ptr,
    NX_PACKET_POOL *packet_pool_ptr,
    NXD_ADDRESS *server_ip_address, ULONG server_port,
    CHAR *client_name,
    CHAR *client_password);
```

Для приложений IPv4 можно также использовать службу *nx_pop3_client_create*.

```C
UINT  nx_pop3_client_create(NX_POP3_CLIENT *client_ptr,
    UINT APOP_authentication, NX_IP *ip_ptr,
    NX_PACKET_POOL *packet_pool_ptr,
    ULONG server_ip_address,
    ULONG server_port, CHAR *client_name,
    CHAR *client_password);
```

Когда клиент отправляет команду APOP, она принимает в качестве единственного аргумента дайджест MD5, содержащий домен сервера, местное время и идентификатор процесса, извлеченные из приветственного сообщения сервера, а также пароль клиента. Сервер POP3 создаст дайджест MD5, содержащий те же данные, и, если его дайджест MD5 совпадет с дайджестом MD5 клиента, клиент проходит проверку подлинности.

Если проверка подлинности APOP завершится сбоем, клиент POP3 для NetX Duo попытается пройти проверку подлинности с помощью команд USER/PASS.

## <a name="the-pop3-client-maildrop"></a>Почтовый ящик клиента POP3

Почта для клиента хранится на сервере POP3 в так называемом почтовом ящике. Почтовый ящик клиента на сервере POP3 представлен в виде списка элементов почты, которые нумеруются последовательно, начиная с номера 1. Это означает, что каждое сообщение определяется по его индексу в списке. Первый почтовый элемент имеет индекс 1 (а не 0). Команды POP3 ссылаются на элементы почты по индексу в этом списке.

## <a name="the-pop3-protocol-state-machine"></a>Конечный автомат протокола POP3

Для работы протокола POP3 требуется, чтобы клиент и сервер поддерживали состояние сеанса POP3. Сначала клиент пытается подключиться к серверу POP3. В случае успеха он применяет три состояния протокола POP3, определенные стандартом RFC 1939. Начальным считается состояние авторизации, в котором клиент должен пройти идентификацию на сервере. В состоянии авторизации клиент POP3 может передавать только команды USER и PASS (строго в таком порядке) или команду APOP.

После проверки подлинности сеанс клиента POP3 переходит в состояние транзакции. В этом состоянии клиент может скачивать почту и запрашивать ее удаление. В состоянии транзакции допускаются команды LIST, STAT, RETR, DELE, RSET и QUIT. Обычно клиент POP3 отправляет команду STAT, за которой следует ряд команд RETR (по одной для каждого элемента электронной почты в почтовом ящике).

Когда клиент выдает команду QUIT, сеанс POP3 переходит в состояние обновления, в котором инициируется отключение канала TCP от сервера. Чтобы снова получить почту, приложение клиента POP3 может вызвать nx_pop3_client_mail_items_get для проверки наличия новых элементов в почтовом ящике.

### <a name="pop3-server-reply-codes"></a>Коды ответа сервера POP3

- +OK: сервер использует этот ответ для подтверждения команды клиента. Сервер может отправить дополнительные сведения после ответа "+OK", но не может ожидать, что клиент будет учитывать эту информацию, за исключением сценариев со скачиванием данных почтового сообщения или выполнением команд LIST или DELE. В последнем случае после команды указывается аргумент, который обозначает индекс элемента электронной почты в почтовом ящике клиента.
- -ERR: сервер использует этот ответ для отклонения команды клиента. Сервер может отправить дополнительные сведения после ответа -ERR, но не может ожидать, что клиент будет обрабатывать эту информацию.

### <a name="sample-pop3-client---server-session"></a>Пример сеанса POP3 между клиентом и сервером

**Простой пример сеанса POP3 с использованием команд USER/PASS**

```
S: <wait for connection on TCP port 110>
C: <open connection>
S: +OK POP3 server ready <1896.697170952@dbc.mtview.ca.us>
C: USER mrose
S: +OK mrose is valid
C: PASS mvan99
S: +OK mrose is logged in
C: STAT
S: +OK 2 320
C: RETR 1
S: +OK 120 octets
S: <the POP3 server sends message 1>
S: .
C: DELE 1
S: +OK message 1 deleted
C: RETR 2
S: +OK 200 octets
S: <the POP3 server sends message 2>
S: .
C: DELE 2
S: +OK message 2 deleted
C: QUIT
S: +OK POP3 server signing off (maildrop empty)
C: <close connection>
S: <wait for next connection>
```

**Простой пример сеанса POP3 с использованием команды APOP (и LIST вместо STAT)**

```
S: <wait for connection on TCP port 110>
C: <open connection>
S: +OK POP3 server ready <1896.697170952@dbc.mtview.ca.us>
C: APOP mrose c4c9334bac560ecc979e58001b3e22fb
S: +OK mrose's maildrop has 2 messages (320 octets)
C: LIST
S: +OK 2 messages (320 octets)
S: 1 120
S: 2 200
S: .
C: RETR 1
S: +OK 120 octets
S: <the POP3 server sends message 1>
S: .
C: DELE 1
S: +OK message 1 deleted
C: RETR 2
S: +OK 200 octets
S: <the POP3 server sends message 2>
S: .
C: DELE 2
S: +OK message 2 deleted
C: QUIT
S: +OK dewey POP3 server signing off (maildrop empty)
C: <close connection>
S: <wait for next connection>
```

## <a name="rfcs-supported-by-netx-duo-pop3-client"></a>Стандарты RFC, поддерживаемые клиентом POP3 для NetX Duo

Клиент POP3 для NetX Duo соответствует стандарту RFC 1939.
