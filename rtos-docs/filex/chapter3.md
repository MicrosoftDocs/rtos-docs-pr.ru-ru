---
title: Глава 3. Функциональные компоненты FileX в ОСРВ Azure
description: В этой главе содержится описание функций высокопроизводительной встроенной файловой системы FileX в ОСРВ Azure
author: philmea
ms.author: philmea
ms.date: 05/19/2020
ms.topic: article
ms.service: rtos
ms.openlocfilehash: bb2e1d7f10d71ed01a040cea63e9e469855525d89dd6318f3147c61ed166ee4c
ms.sourcegitcommit: 93d716cf7e3d735b18246d659ec9ec7f82c336de
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/07/2021
ms.locfileid: "116783085"
---
# <a name="chapter-3---functional-components-of-azure-rtos-filex"></a>Глава 3. Функциональные компоненты FileX в ОСРВ Azure

В этой главе содержится описание функций высокопроизводительной встроенной файловой системы FileX в ОСРВ Azure.

## <a name="media-description"></a>Описание носителя

FileX — это высокопроизводительная встроенная файловая система, которая соответствует формату файловой системы FAT. FileX рассматривает физический носитель как массив логических секторов. Способ сопоставления этих секторов с базовым физическим носителем определяется драйвером ввода-вывода, подключенным к носителю FileX во время вызова ***fx_media_open***.

### <a name="fat121632-logical-sectors"></a>Логические секторы FAT12/16/32

Точная организация логических секторов носителя определяется содержимым загрузочной записи физического носителя. Общий макет логических секторов носителя показан на рис. 1.

Логические сектора FileX начинаются с логического сектора 1, который указывает на первый зарезервированный сектор носителя. Зарезервированные секторы необязательны, но в случае использования они обычно содержат системные сведения, такие как загрузочный код.

### <a name="fat121632-media-boot-record"></a>Загрузочная запись носителя FAT12/16/32

Точное смещение сектора других областей в представлении логического сектора носителя является производным от содержимого *загрузочной записи носителя*. Загрузочная запись обычно находится в секторе 0. Однако если на носителе есть *скрытые секторы*, смещение загрузочного сектора должно учитывать их (они располагаются непосредственно ПЕРЕД загрузочным сектором). В таблице 1 перечислены компоненты загрузочной записи носителя. Их описание можно увидеть в абзацах.

- **Инструкция перехода** Поле *инструкции перехода* — это поле размером три байта, которое представляет собой машинную команду Intel x86 для перехода на процессор. Это поле в большинстве случаев является устаревшим.

  ![Представление логического сектора для носителя FileX](./media/user-guide/filex-media-logical-sector-view.png)

  **РИСУНОК 1. Представление логического сектора для носителя FileX**

- **Имя OEM**. Поле *имени OEM* зарезервировано для размещения имени изготовителя или имени устройства.
- **Байт на сектор**. Поле *Байт на сектор* в загрузочной записи носителя определяет, сколько байт находится в каждом секторе (фундаментальный элемент носителя).
- **Количество секторов на кластер**. Поле *Количество секторов на кластер* в загрузочной записи носителя определяет количество секторов, назначенных кластеру. Кластер является основным элементом выделения в файловой системе, совместимой на уровне таблиц распределения файлов. Все сведения о файлах и подкаталоги выделяются из доступных кластеров носителей в соответствии с определением таблицы распределения файлов (FAT).

    **ТАБЛИЦА 1. Загрузочная запись носителя FileX**
    
    |Offset  |Поле  |Число байтов|
    |----------|-----------|------------|
    |0x00|Инструкция перехода (e9,xx,xx или eb,xx,90)|3|
    |0x03|Имя OEM|8|
    |0x0B|Байт на сектор|2|
    |0x0D|Количество секторов на кластер|1|
    |0x0E|Число зарезервированных секторов|2|
    |0x10|Количество таблиц распределения файлов|1|
    |0x11|Размер корневого каталога|2|
    |0x13|Число секторов FAT-12 и FAT-16|2|
    |0x15|Тип носителя|1|
    |0x16|Число секторов на FAT|2|
    |0x18|Сектор на дорожку|2|
    |0x1A|Количество заголовков|2|
    |0x1C|Число скрытых секторов|4|
    |0x20|Число секторов FAT-32|4|
    |0x24|Количество секторов на FAT (FAT-32)|4|
    |0x2C|Кластер корневого каталога|4|
    |0x3E|Загрузочный код системы|448
    |0x1FE|0x55AA|2|

- **Зарезервированные секторы**. Поле *Зарезервированные секторы* в загрузочной записи носителя определяет количество секторов, зарезервированных между загрузочной записью и первым сектором в области FAT. В большинстве случаев значение этой записи равно нулю.
- **Количество таблиц распределения файлов**. Запись *количества таблиц распределения файлов* в загрузочной записи носителя определяет количество FAT на носителе. На носителе всегда должна быть хотя бы одна таблица распределения файлов. Дополнительные FAT являются всего-лишь дубликатами основной (первой) FAT. Их обычно использует ПО диагностики или восстановления.
- **Размер корневого каталога**. Запись о *размере корневого каталога* в загрузочной записи носителя определяет фиксированное число записей в корневом каталоге носителя. Это поле неприменимо к подкаталогам и корневому каталогу FAT-32, так как они оба распределяются из кластеров носителей.
- **Число секторов FAT-12 и FAT-16**. Поле *числа секторов* в загрузочной записи носителя содержит общее количество секторов на носителе. Если это поле равно нулю, общее число секторов содержится в поле *Число секторов FAT-32*, расположенном дальше в загрузочной записи.
- **Тип носителя**. Поле *Тип носителя* используется для определения типа носителя в драйвере устройства. Это устаревшее поле.
- **Количество секторов на FAT**. Поле *количества секторов на FAT*, заполненное данными в загрузочной записи носителя, содержит количество секторов, связанных с каждой FAT в области FAT. Количество секторов FAT должно быть достаточным, чтобы учитывать максимально возможное количество кластеров, которые можно выделить на носителе.
- **Количество секторов на дорожку**. Поле *количества секторов на дорожку* в загрузочной записи носителя определяет количество секторов на дорожку. Обычно это поле относится только к реальным носителям типа диска. Устройства FLASH не используют это сопоставление.
- **Число заголовков**. Поле *Число заголовков* в загрузочной записи носителя определяет количество заголовков на носителе. Обычно это поле относится только к реальным носителям типа диска. Устройства FLASH не используют это сопоставление.
- **Скрытые секторы**. Поле *Скрытые секторы* в загрузочной записи носителя определяет число секторов перед загрузочной записью. Это поле сохраняется в блоке управления **FX_MEDIA** и его необходимо учитывать для драйвера ввода-вывода FileX во всех запросах на чтение и запись, выполняемых FileX.
- **Число секторов FAT-32**. Поле *числа секторов* в загрузочной записи носителя допустимо, только если значением поля *количества секторов* размером два байта является ноль. В этом случае такое 4-байтовое поле будет содержать сведения о количестве секторов на носителе.
- **Количество секторов на FAT (FAT-32)** Поле *количества секторов на FAT (FAT-32)* допустимо только в формате FAT-32 и содержит количество секторов, выделенных для каждой таблицы распределения файлов носителя.
- **Кластер корневого каталога** Поле *кластера корневого каталога* допустимо только в формате FAT-32 и содержит номер начального кластера корневого каталога.
- **Загрузочный код системы** Поле *загрузочного кода системы* — это область, в которой хранится небольшая часть загрузочного кода. В большинстве современных устройств это поле является устаревшим.
- **Подпись 0x55AA**. Поле *подписи* — это шаблон данных, используемый для определения загрузочной записи. Если это поле отсутствует, загрузочная запись станет недействительной.

### <a name="exfat"></a>exFAT

Максимальный размер файла в FAT32 составляет 4 ГБ, что ограничивает широкое внедрение высококачественных мультимедийных файлов. По умолчанию FAT32 поддерживает накопители емкостью до 32 ГБ. Так как емкость флэш-памяти и SD-карт увеличивается, файловая система FAT32 становится не менее эффективной при управлении большими томами. Для преодоления этих ограничений разработана файловая система exFAT. exFAT поддерживает файлы размером до одного эксабайта (EB), что составляет примерно 1 миллиард ГБ. Еще одно существенное различие между exFAT и FAT32 заключается в том, что в exFAT для управления доступным пространством в томе используется растровое изображение, что делает эту файловую систему более эффективной при поиске доступного пространства во время записи данных в файл. Кроме того, для файлов, хранящихся в смежных кластерах, exFAT устраняет необходимость прохода по структуре цепочки FAT, чтобы найти все кластеры, что делает эту файловую систему более эффективной при доступе к большим файлам. Файловая система exFAT является обязательной для флэш-памяти и SD-карт размером более 32 ГБ.

### <a name="exfat-logical-sectors"></a>Логические сектора exFAT

Общий макет логических секторов носителя в exFAT показан на рис. 2. В exFAT загрузочный блок и область FAT принадлежат системной области. Остальные кластеры — это пользовательская область. Хотя это требование не обязательно, стандартом exFAT рекомендуется, чтобы битовая карта распределения была расположена в начале пользовательской области, за которой должны следовать таблица массива символов Юникода и корневой каталог.

### <a name="exfat-media-boot-record"></a>Загрузочная запись носителя exFAT

Содержимое загрузочной записи носителя в exFAT отличается от содержимого в FAT12/16/32. С ними можно ознакомиться, просмотрев таблицу 2. Чтобы избежать путаницы, область между 0x0B и 0x40, которая содержит различные параметры носителя в FAT12/16/32, помечена в exFAT значением *Зарезервировано*. Эту зарезервированную область нужно программировать с использованием последовательности нулей, что позволит избежать неправильной интерпретации загрузочной записи носителя.

![Логические сектора exFAT](./media/user-guide/exfat-logical-sectors.png)

**РИСУНОК 2. Логические сектора exFAT**

- **Инструкция перехода** Поле *инструкции перехода* — это поле размером три байта, которое представляет собой машинную команду Intel x86 для перехода на процессор. Это поле в большинстве случаев является устаревшим.

    **ТАБЛИЦА 2. Загрузочная запись носителя exFAT**

    |Offset  |Поле  |Число байтов|
    |----------|-----------|------------|
    |0x00|Инструкция перехода|3|
    |0x03|Имя файловой системы|8|
    |0x0B|Зарезервировано|53|
    |0x40|Смещение секции|8|
    |0x48|Длина тома|8|
    |0x50|Смещение FAT|4|
    |0x54|Длина FAT|4|
    |0x58|Смещение кучи кластеров|4|
    |0x5C|Число кластеров|4|
    |0x60|Первый кластер корневого каталога|4|
    |0x64|Серийный номер тома|4|
    |0x68|Версия файловой системы|2|
    |0x6A|Флаги тома|2|
    |0x6C|Байт на сдвиг сектора|1|
    |0x6D|Сектор на сдвиг кластера|1|
    |0x6E|Количество таблиц распределения файлов|1|
    |0x6F|Выбор диска|1|
    |0x70|Процент использования|7|
    |0x71|Зарезервировано|1|
    |0x78|Загрузочный код|390|
    |0x1FE|Загрузочная подпись|2|

- **Имя файловой системы**. Для exFAT в поле *имени файловой системы* должно быть указано значение exFAT, за которым следуют три конечных пробела.
- **Зарезервировано**. Для поля *Зарезервировано* нужно задать значение, равное нулю. Этот регион пересекается с загрузочными записями в FAT12/16/32. Задание для этой области значения 0 позволяет избежать неправильной интерпретации этого объема файловыми системами.
- **Смещение секции**. В поле *смещения секции* указывается начало этой секции.
- **Длина тома**. Поле *Длина тома* определяет размер (в секторах) этой секции.
- **Смещение FAT**. Поле *смещения FAT* определяет номер начального сектора (который относится к началу этой секции) в таблице FAT для этой секции.
- **Длина FAT**. В поле *Длина FAT* определяется размер таблицы FAT (количество секторов).
- **Смещение кучи кластера**. Поле *смещения кучи кластера* определяет номер начального сектора, который относится к началу секции, для кучи кластера. Куча кластера — это область, в которой хранятся сведения о каталогах и файловые данные.
- **Число кластеров**. В поле *Число кластеров* определяется количество кластеров в этой секции.
- **Первый кластер корневого каталога**. Поле *Первый кластер корневого каталога* определяет начальную позицию корневого каталога, которая согласно рекомендациям должна находится сразу после битовой карты распределения и таблицы массива символов Юникода.
- **Серийный номер тома** Поле *серийного номера тома* определяет серийный номер для этой секции.
- **Версия файловой системы**. Поле *Версия файловой системы* определяет основную и дополнительную версии exFAT.
- **Флаги тома**. Поле *Флаги тома* содержит флаги, указывающие на состояние этого тома.
- **Байт на сдвиг сектора** Поле *Байт на сдвиг сектора* определяет число байтов на сектор в log2(n), где n — число байтов на сектор. Например, в SD-карте размер сектора составляет 512 байт. Поэтому это поле должно быть равно 9 (log2(512) = 9).
- **Количество секторов на сдвиг кластера** Значение поля *Количество секторов на сдвиг кластера* определяет количество секторов в кластере в log2(n), где n — число секторов на кластер.
- **Количество таблиц распределения файлов**. Поле *Количество таблиц распределения файлов* определяет количество таблиц FAT в этой секции. При использовании exFAT для одной таблицы FAT рекомендуется задавать значение 1.
- **Выбор диска**. Поле *выбора диска* определяет номер диска с расширением INT 13h.
- **Процент использования**. Поле *Процент использования* определяет процент выделяемых кластеров в куче кластера. Допустимые значения — от 0 до 100 (включительно).
- **Зарезервировано**. Это поле зарезервировано для последующего использования.
- **Загрузочный код** Поле *загрузочный код* — это область для хранения небольшой части загрузочного кода. В большинстве современных устройств это поле является устаревшим.
- **Подпись 0x55AA**. Поле *загрузочной подписи* — это шаблон данных, используемый для определения загрузочной записи. Если это поле отсутствует, загрузочная запись станет недействительной.

### <a name="file-allocation-table-fat"></a>Таблица распределения файлов (FAT)

*Таблица распределения файлов (FAT)* начинается на носителе после зарезервированных секторов. Область FAT — это, по сути, массив из 12-разрядных, 16-разрядных или 32-разрядных записей, которые определяют что будет выделятся: кластер или часть цепочки кластеров, составляющих подкаталог или файл. Размер каждой записи FAT определяется количеством кластеров, которые необходимо представить. Если количество кластеров (значение, полученное в результате деления общего числа секторов на секторы одного кластера) меньше или равно 4 086, будут использоваться 12-разрядные записи FAT. Если общее число кластеров превышает 4 086 но меньше 65 525, используются 16-разрядные записи FAT. И, если общее число кластеров больше или равно 65 525, будут использоваться 32-разрядные системы FAT или exFAT.

Для FAT12/16/32 таблица FAT не только поддерживает цепочку кластеров, но и предоставляет сведения о выделении кластера: независимо от того, доступен ли кластер. В exFAT сведения о выделении кластера хранятся в записи каталога битовой карты распределения. Каждая секция имеет собственную битовую карту распределения. Размер битовой карты достаточно велик, чтобы охватить все доступные кластеры. Если кластер доступен для выделения, соответствующему биту в битовой карте распределения задается значение 0. В противном случае биту задается значение 1. Если файлы размещены в последовательных кластерах, для exFAT не понадобится цепочка FAT, чтобы отслеживать все кластеры. Тем не менее для файлов, которые не расположены в последовательных кластерах, цепочку FAT все еще нужно администрировать.

### <a name="fat-entry-contents"></a>Содержимое записи FAT

Первые две записи в таблице FAT не используются и обычно имеют следующее содержимое.

|Запись FAT |12-разрядная таблица FAT|16-разрядная таблица FAT|32-разрядная таблица FAT| exFAT|
|----------|-----------|------------|-------|------|
|Запись 0|0x0F0|0x00F0|0x000000F0|0xF8FFFFFF|
|Запись 1|0xFFF|0xFFFF|0x0FFFFFFF|0xFFFFFFFF|

Запись FAT номер 2 представляет первый кластер в области данных носителя. Содержимое каждой записи кластера определяет, является такой кластер свободным или частью связанного списка кластеров, выделенных для файла или подкаталога. Если запись кластера содержит другую допустимую запись кластера, то кластер выделяется, а его значение указывает на следующий кластер, выделенный в цепочке кластера.

Возможные записи кластера определяются следующим образом.

|Значение|12-разрядная таблица FAT|16-разрядная таблица FAT|32-разрядная таблица FAT| exFAT|
|----------|-----------|------------|-------|------|
|Свободный кластер|0x000|0x0000|0x00000000|0x00000000|
|Не используемые|0x001|0x0001|0x00000001|0x00000001|
|Зарезервировано|0xFF0-FF6|0xFFF0-FFF6|0x0FFFFFF0-6|ClusterCounter +2 к 0xFFFFFFF6|
|Неправильный кластер|0xFF7|0xFFF7|0x0FFFFFF7|0xFFFFFFF7|
|Зарезервировано| - | - | - | 0xFFFFFFF8-E|
|Последний кластер| 0xFF8-FFF| 0xFFF8-FFFF| 0x0FFFFFF8-F| 0xFFFFFFFF|
|Ссылка на кластер| 0x002-0xFEF| 0x0002-FFEF| 0x2-0x0FFFFFEF | 0x2 — ClusterCount +1|

Последний кластер в выделенной цепочке кластеров содержит значение последнего кластера (определено выше). Номер первого кластера можно найти в записи каталога файла или подкаталога.

### <a name="internal-logical-cache"></a>Внутренний логический кэш

FileX поддерживает *наиболее часто используемый* кэш логического сектора для каждого открытого носителя. Максимальный размер кэша логического сектора определяется константой **FX_MAX_SECTOR_CACHE** и находится в файле **_fx_api.h_**. Это первый фактор, определяющий размер внутреннего кэша логического сектора.

Другой фактор, определяющий размер кэша логического сектора, — это объем памяти, предоставляемый приложением при вызове ***fx_media_open** _. Необходимо, чтобы объем памяти был достаточным, по крайней мере для одного логического сектора. Если требуется больше логических секторов, чем предоставляет _ *FX_MAX_SECTOR_CACHE**, в файле **_fx_api.h_** нужно изменить константу. Кроме того, понадобится перестроить всю библиотеку FileX.

> [!IMPORTANT]
> *Каждый открытый носитель в FileX может иметь разный размер кэша в зависимости от памяти, предоставляемой во время открытого вызова.*

### <a name="write-protect"></a>Защита от записи

FileX предоставляет драйверу приложения возможность динамически задавать защиту от записи на носителе. Если защита от записи является обязательной, драйвер задает для поля *fx_media_driver_write_protect* значение FX_TRUE в связанной структуре FX_MEDIA. Если задать это значение, все попытки приложения изменить носитель или открыть файлы для записи будут отклонены. Драйвер также может отключить защиту от записи, очистив значение этого поля.

### <a name="free-sector-update"></a>Обновление свободного сектора

FileX предоставляет механизм для информирования драйвера приложения о том, что секторы больше не используются. Это особенно полезно для диспетчеров FLASH-памяти, которые управляют всеми логическими секторами, используемыми FileX.

Если требуется уведомление о свободных секторах, драйвер приложения задает для поля *fx_media_driver_free_sector_update* в связанной структуре FX_MEDIA значение FX_TRUE. Это назначение обычно выполняется во время инициализации драйвера.

Если задать значение для этого поля, FileX вызовет драйвер **FX_DRIVER_RELEASE_SECTORS**, указывающий, когда один или несколько последовательных секторов станут свободными.

### <a name="media-control-block-fx_media"></a>Блок управления носителями FX_MEDIA

Характеристики каждого открытого носителя в FileX содержатся в блоке управления носителями. Эта структура определена в файле ***tx_api.h***.

Блоки управления носителя могут размещаться в любом месте в памяти, но чаще всего они определяются вне области какой-либо функции, благодаря чему функционируют как глобальная структура.

Поиск блока управления в других областях требует больших усилий, как и в любой динамически выделяемой памяти. Если блок управления выделяется в функции C, то связанная с ним память является частью стека вызывающего потока.

> [!WARNING]
>*Как правило, локальное хранилище не следует использовать для блоков управления, так как после возвращения функции все пространство его стека локальных переменных освобождается, независимо от того, используется ли оно.*

## <a name="fat121632-directory-description"></a>**Описание каталога FAT12/16/32**

FileX поддерживает такие форматы имен, как имена формата 8.3 и длинные имена файлов (LFN) Windows. Помимо имени, каждая запись каталога содержит атрибуты записи, дату и время последнего изменения, индекс начального кластера и размер записи в байтах. В таблице 3 представлены содержимое и размер записи каталога FileX в формате 8.3.

- **Имя каталога**

    FileX поддерживает размер имен файлов в диапазоне от 1 до 255 символов. Стандартные восьмисимвольные имена файлов представлены на носителе в одной записи каталога. Они выравниваются по левому краю в поле "Имя каталога" и являются пустыми. Кроме того, символы ASCII, составляющие имя, всегда заменяются прописными буквами.

    Длинные имена файлов (LFN) представлены последовательными записями каталога в обратном порядке, за которыми сразу следует стандартное имя файла формата 8.3. Созданное имя формата 8.3 содержит всю значимую информацию о каталоге, связанную с этим именем. В таблице 4 представлено содержимое записей каталога, используемых для хранения сведений о длинных именах файлов, а в таблице 5 показан пример 39-символьного LFN, для которого требуется всего четыре записи каталога.

> [!IMPORTANT]
> *Константа **FX_MAX_LONG_NAME_LEN**, определенная в файле **fx_api.h**, содержит максимальную длину, поддерживаемую FileX.*

- **Расширение имени файла каталога**

    Для стандартных имен файлов формата 8.3 FileX также поддерживает необязательное *расширение имени файла каталога* из трех символов. Как и имена файлов из восьми символов, расширения имен файлов выравниваются по левому краю в поле расширения имени файла каталога, заполняются пробелами и всегда заменяются прописными буквами.

    **ТАБЛИЦА 3. Запись каталога FileX формата 8.3**

    |Offset|Поле|Число байтов|
    |------------|-----------|------------|
    |0x00|Имя записи каталога|8|
    |0x08|Расширение каталога|3|
    |0x0B|Атрибуты|1|
    |0x0C|NT (вводится в формате длинного имени файла и является зарезервированным для NT [всегда 0])|1|
    |0x0D|Время создания (в миллисекундах) (вводится в формате длинного имени файла и представляет число миллисекунд, в течение которого был создан файл)|1|
    |0x0E|Время создания файла в часах и минутах (вводится в формате длинного имени файла и представляет час и минуты создания файла)|2|
    |0x10|Дата создания (вводится в формате длинного имени файла и представляет дату создания файла)|2|
    |0x12|Дата последнего доступа (вводится в формате длинного имени файла и представляет дату последнего обращения к файлу)|2|
    |0x14|Запуск кластера (только верхние 16 бит FAT-32)|2|
    |0x16|Время изменения|2|
    |0x18|Дата изменения|2|
    |0x1A|Запуск кластера (нижние 16 бит FAT-32, FAT-12 или FAT-16)|2|
    |0x1C|Размер файла|4|


- **Атрибуты каталога**

    Запись поля однобайтового *атрибута каталога* содержит ряд битов, которые определяют различные свойства записи каталога. Ниже приведены определения атрибутов каталога.

    |Бит атрибута|Значение|
    |------------|-----------|
    |0x01|Запись доступна только для чтения.|
    |0x02|Запись скрыта.|
    |0x04|Запись является системной записью.|
    |0x08|Запись является меткой тома|
    |0x10|Запись является каталогом.|
    |0x20|Запись изменена.|

    Так как все биты атрибутов являются взаимоисключающими, за один раз можно задать несколько битов атрибута.

- **Время каталога**

    Двухбайтовое поле *времени каталога* содержит часы, минуты и секунды последнего изменения указанной записи каталога. Биты с 15 по 11 содержат часы, биты с 10 по 5 содержат минуты, а биты с 4 по 0 — половину секунд. Перед записью в это поле фактические секунды делятся на два.

- **Дата каталога**

    Двухбайтовое поле *даты каталога* содержит год (смещение от 1980 г.), месяц и день последнего изменения указанной записи каталога. Биты с 15 по 9 содержат смещение года, биты с 8 по 5 содержат смещение месяца, а биты с 4 по 0 — смещение дня.

- **Начальный кластер каталога**

    Для FAT-12 и FAT-16 размер этого поля составляет 2 байта. Для FAT-32 это поле занимает 4 байта. Это поле содержит номер первого кластера, выделенного для записи (подкаталог или файл).

    > [!NOTE]
    > *Обратите внимание, что FileX создает файлы без начального кластера (значение поля начального кластера равно нулю), что позволяет пользователям при необходимости выделять непрерывное количество кластеров для недавно созданного файла. *

- **Размер файла каталога**

    Поле *Размер файла* *каталога* размером в четыре байта содержит число байтов в файле. Если запись действительно является подкаталогом, значение поля "Размер" будет равно нулю.

### <a name="long-file-name-directory"></a>Каталог длинных имен файлов

- **Порядковый номер**

    Однобайтовое поле *Порядковый номер*, указывающее номер записи LFN. Так как записи LFN располагаются в обратном порядке, значения порядковых номеров записей каталога в формате LFN, составляющих одно LFN, уменьшаются на одну ступень. Кроме того, значением порядкового номера LFN непосредственно перед именем файла в формате 8.3 должно быть "один".

    **ТАБЛИЦА 4. Запись каталога длинных имен файлов**

    | Offset | Поле | Число байтов |
    |------------|-----------|------------|
    | 0x00 | Поле "Порядковый номер" | 1 |
    | 0x01 | Символ 1 Юникода | 2 |
    | 0x03 | Символ 2 Юникода | 2 |
    | 0x05 | Символ 3 Юникода | 2 |
    | 0x07 | Символ 4 Юникода | 2 |
    | 0x09 | Символ 5 Юникода | 2 |
    | 0x0B | Атрибуты LFN | 1 |
    | 0x0C | Тип LFN (для типа "Зарезервировано" значением всегда будет 0) | 1 |
    | 0x0D | Контрольная сумма LFN | 1 |
    | 0x0E | Символ 6 Юникода | 2 | 
    | 0x10 | Символ 7 Юникода | 2 |
    | 0x12 | Символ 8 Юникода | 2 |
    | 0x14 | Символ 9 Юникода | 2 |
    | 0x16 | Символ 10 Юникода | 2 |
    | 0x18 | Символ 11 Юникода | 2 |
    | 0x1A | Кластер LFN (для типа "Не используется" значением всегда будет 0) | 2 |
    | 0x1C | Символ 12 Юникода | 2 |
    | 0x1E | Символ 13 Юникода | 2 |

- **Символьный формат Юникода**

    Двухбайтовые поля *Символьный формат Юникода* предназначены для поддержки символов из разных языков. Стандартные символы ASCII представлены с помощью символа ASCII, хранящегося в первом байте символа Юникода, за которым следует символ пробела.

- **Атрибуты LFN**

    Однобайтовое поле *Атрибуты LFN* содержит атрибуты, которые указывают запись каталога как запись каталога LFN. Это достигается с помощью задания значений для всех атрибутов: "только для чтения", "системный", "скрытый" и "том".

- **Тип LFN**

    Однобайтовое поле *Тип LFN* является зарезервированным и всегда равно 0.

- **Контрольная сумма LFN**

    Однобайтовое поле *Контрольная сумма LFN* представляет собой контрольную сумму из 11 символов имени файла связанной MS DOS в формате 8.3. Эта контрольная сумма хранится в каждой записи LFN, чтобы гарантировать, что запись LFN совпадает с соответствующим именем файла в формате 8.3.

- **Кластер LFN**

    Двухбайтовое поле *Кластер LFN* не используется и всегда равно 0.

    **ТАБЛИЦА 5. Записи каталога, состоящие из 39-символьного LFN**

    |Ввод|Значение|
    |------------|-----------|
    |1|Запись 3 каталога LFN|
    |2|Запись 2 каталога LFN|
    |3|Запись 1 каталога LFN|
    |4|Запись каталога в формате 8.3 (ttttt~n.xx)|

### <a name="exfat-directory-description"></a>Описание каталога exFAT

Способы хранения файловой системой exFAT записи каталога и имени файла отличаются. Запись каталога содержит атрибуты записи, различные метки времени создания, изменения записи, а также доступа к ней. Другие сведения, такие как размер файла и начальный кластер, хранятся в записи каталога расширения для потоковой передачи, которая следует сразу за основной записью каталога. Файловая система exFAT поддерживает только формат имени длинного файла (LFN), который хранится в записи каталога имени файла сразу после записи каталога расширения для потоковой передачи, как показано в таблице 2.

### <a name="exfat-file-directory-entry"></a>Запись каталога файлов exFAT

Описание записи каталога файлов exFAT и ее содержимого приведены в следующих таблице и абзацах.

- **Тип записи**

    В поле "Тип записи" нужно указывать тип соответствующей записи. Если это поле записи каталога файлов, значением должно быть 0x85.

- **Число вторичных записей**

    В поле *Число вторичных записей* указывается количество вторичных записей, которые следуют сразу за этой первичной записью. Вторичные записи, связанные с записью каталога файлов, включают в себя одну запись каталога расширения для потоковой передачи и одну или несколько записей каталога имен файлов.

    **ТАБЛИЦА 6. Запись каталога файлов exFAT**

    |Offset|Поле|Число байтов|
    |----|-----------|-|
    |0x00|Тип записи|1|
    |0x01|Вторичная запись|1|
    |0x02|Контрольная сумма|2|
    |0x04|Атрибуты файла|2|
    |0x06|Зарезервировано 1|2|
    |0x08|Отметка времени создания|4|
    |0x0C|Метка времени последнего изменения|4|
    |0x10|Метка времени последнего доступа|4|
    |0x14|Приращение создания на 10 мс|1|
    |0x15|Приращение последнего изменения на 10 мс|1|
    |0x16|Создание смещения времени в формате UTC|1|
    |0x17|Смещение времени последнего изменения в формате UTC|1|
    |0x18|Смещение времени последнего доступа в формате UTC|1|
    |0x19|Зарезервировано 2|7|

- **Контрольная сумма**

    Поле *Контрольная сумма* содержит значение контрольной суммы по всем записям в наборе записей каталога (запись каталога файлов и его дополнительные записи).

- **Атрибуты файла**

    Запись поля однобайтовых атрибутов содержит ряд битов, которые определяют различные свойства записи каталога. Определение большинства битов атрибутов схоже с FAT12/16/32. Ниже приведены определения атрибутов каталога:

    |Бит атрибута|Значение|
    |------------|-----------|
    |0x01| Запись доступна только для чтения|
    |0x02|Запись скрыта|
    |0x04|Запись является системной записью|
    |0x08|Запись зарезервирована|
    |0x10|Запись является каталогом|
    |0x20|Запись изменена|
    |Все остальные биты|Зарезервировано|

- **Reserved1**

    Это поле должно быть равным нулю.

- **Отметка времени создания**

    Поле *Метка времени создания*, а также сведения из поля *Приращение создания на 10 мс* описывают местные дату и время создания файла или каталога.

- **Метка времени последнего изменения**

    Поле *Метка времени последнего изменения*, а также сведения из поля *Приращение последнего изменения на 10 мс* описывают местные дату и время последнего изменения файла или каталога. См. ниже примечания к каждой метке времени.

- **Метка времени последнего доступа**

    Поле *Метка времени последнего доступа* описывает местные дату и время последнего доступа к файлу или каталогу. См. ниже примечания к каждой метке времени.

- **Приращение создания на 10 мс**

    Поле *Приращение создания на 10 мс*, а также сведения из поля *Метка времени создания* описывают местные дату и время создания файла или каталога. См. ниже примечания к каждой метке времени.

- **Приращение последнего изменения на 10 мс**

    Поле *Приращение последнего изменения на 10 мс*, а также сведения из поля *Метка времени последнего изменения* описывают местные дату и время последнего изменения файла или каталога. См. ниже примечания к каждой метке времени.

- **Создание смещения времени в формате UTC**

    В поле *Создание смещения времени в формате UTC* описывается разница между местным временем и временем в формате UTC при создании файла или каталога. См. ниже примечания к каждой метке времени.

- **Смещение времени последнего изменения в формате UTC**

    В поле *Смещение времени последнего изменения в формате UTC* описывается разница между местным временем и временем в формате UTC при последнем изменении файла или каталога. См. ниже примечания к каждой метке времени.

- **Смещение времени последнего доступа в формате UTC**

    В поле *Смещение времени последнего доступа в формате UTC* описывается разница между местным временем и временем в формате UTC при последнем доступе к файлу или каталогу. См. ниже примечания к каждой метке времени.

- **Зарезервировано 2**

    Это поле должно быть равным нулю.

### <a name="notes-on-timestamps"></a>Примечания к меткам времени

- **Запись метки времени**. Поля метки времени интерпретируются следующим образом:

- **Поля с приращением 10 мс**. Значение, предоставляемое для полей с приращением 10 мс, обеспечивает большую детализацию для значения меток времени. Допустимые значения: от 0 (0 мс) до 199 (1990 мс).

     ![Поля с приращением 10 мс](./media/user-guide/10ms-increment-fields.png)

- **Поле смещения времени в формате UTC**

     ![Поле смещения времени в формате UTC](./media/user-guide/utc-offset-field.png)

- **Значение смещения**

    7-битовое целое число со знаком представляет собой смещение от времени в формате UTC с приращением 15 минут.

- **Допустимо**

    Действительно ли значение в поле смещения. 0 значит, что значение в поле "Значение смещения" недопустимо. 1 указывает на то, что значение является допустимым.

### <a name="stream-extension-directory-entry"></a>Запись каталога расширения для потоковой передачи

Описание записи каталога файлов расширения для потоковой передачи и ее содержимого приведены в следующих таблице и абзацах.

**ТАБЛИЦА 7. Запись каталога расширения для потоковой передачи**

|Offset|Поле| Число байтов|
|------------|-----------|-------|
|0x00|Тип записи|1|
|0x01|Флаги|1|
|0x02|Зарезервировано 1|1|
|0x03|Длина имени|1|
|0x04|Хэш имени|2|
|0x06|Зарезервировано 2|2|
|0x08|Допустимая длина данных|8|
|0x10|Зарезервировано 3|4|
|0x14|Первый кластер|4|
|0x18|Длина данных|8|

- **Тип записи**

    В поле *Тип записи* нужно указывать тип соответствующей записи. Для записи каталога расширения для потоковой передачи это поле должно иметь значение 0xC0.

- **Флаги**

    Это поле содержит ряд битов, задающих различные свойства:
    
    |Бит флага|Значение    |
    |-----------------|-----------|
    |0x01            |Это поле указывает, возможно ли выделение кластеров. Для этого поля нужно задавать значение 1.|
    |0x02            |Это поле указывает, являются ли связанные кластеры непрерывными. Значение 0 значит, что запись FAT является допустимой и файловая система FileX должна следовать по цепочке FAT. Значение 1 значит, что запись FAT недопустима и кластеры непрерывны.|
    |Все остальные биты    |Зарезервировано.|

- **Зарезервировано 1**

    Для этого поля нужно задавать значение 0.

- **Длина имени**

    Поле *Длина имени* содержит длину строки в Юникоде в записях каталога имен файлов, содержащихся вместе. Записи каталога имен файлов должны следовать сразу после записи каталога расширения потоковой передачи.

- **Хэш имени**

    Поле *Хэш имени* — это 2-байтовая запись, содержащая значение хэша имени файла с учетом регистра. Значение хэша позволяет ускорить поиск по имени файла или каталога: если значения хэша не совпадают, имя файла, связанное с этой записью, не считается соответствием.

- **Зарезервировано 2**

    Для этого поля нужно задавать значение 0.

- **Допустимая длина данных**

    Поле *Допустимая длина данных* указывает на объем допустимых данных в файле.

- **Зарезервировано 3**

    Это значение должно быть равным 0.

- **Первый кластер**

    Поле *Первый кластер* содержит индекс первого кластера потока данных.

- **Длина данных**

    Поле *Длина данных* содержит общее число байтов в выделенных кластерах. Это значение может быть больше значения поля *Допустимая длина данных*, так как exFAT допускает предварительное выделение кластеров данных.

### <a name="root-directory"></a>Корневой каталог

В 12- и 16-битных форматах FAT *корневой каталог* расположен сразу после всех секторов FAT на носителе, и его можно найти, проверив ***fx_media_root_sector_start** _ в открытом блоке управления *FX_MEDIA**. Размер корневого каталога, если говорить о количестве записей каталога (размер каждого 32 байта), определяется соответствующей записью в загрузочной записи носителя.

Корневой каталог в FAT-32 и exFAT можно найти в любом месте доступных кластеров. Его расположение и размер определяются на основе загрузочной записи при открытии носителя. Открыв носитель, вы можете использовать поле ***fx_media_root_sector_start***, чтобы найти начальный кластер корневого каталога FAT-32 или exFAT.

### <a name="subdirectories"></a>Подкаталоги

В системе FAT может находиться любое количество подкаталогов. Имя подкаталога содержится в записи каталога так же, как имя файла. Однако спецификация атрибута каталога (0x10) задана таким образом, чтобы указывать, что запись является подкаталогом, а размер файла всегда равен нулю.
На рисунке 3 показано, как выглядит типичная структура подкаталогов для нового подкаталога одного кластера ***SAMPLE.DIR** _ с одним файлом с именем _*_FILE.TXT_**.
В большинстве случаев подкаталоги очень похожи на записи файлов. Первое поле кластера указывает на первый кластер связанного списка кластеров. При создании подкаталога первые две записи каталога содержат каталоги по умолчанию, а именно каталог "." и каталог "..". Каталог "." указывает на сам подкаталог, а каталог ".." — на предыдущий или родительский каталог.

### <a name="global-default-path"></a>Глобальный путь по умолчанию

FileX предоставляет глобальный путь по умолчанию для носителя. Путь по умолчанию используется в любом файле или службе каталогов, в которых полный путь не указан явно.

Изначально в качестве значения глобального каталога по умолчанию задается корневой каталог носителя. Приложение может изменить это значение путем вызова ***fx_directory_default_set***.

Текущий путь по умолчанию для носителя можно проверить, вызвав ***fx_directory_default_get** _. Эта подпрограмма предоставляет указатель строки на строку пути по умолчанию, администрируемую в блоке управления _ *FX_MEDIA**.

### <a name="local-default-path"></a>Локальный путь по умолчанию

FileX также предоставляет путь по умолчанию для конкретного потока, что позволяет различным потокам иметь уникальные пути, а также помогает избежать конфликтов. Структура **FX_LOCAL_PATH** предоставляется приложением во время вызовов **_fx_directory_local_path_set_ *_ и _* _fx_directory_local_path_restore_** для изменения локального пути вызывающего потока.

При наличии локальный путь имеет приоритет над глобальным путем по умолчанию носителя. Если локальный путь не настроен или если его удалили с помощью службы ***fx_directory_local_path_clear***, то глобальный путь по умолчанию носителя будет использован еще раз.

## <a name="file-description"></a>Описание файла

FileX поддерживает стандартные символы формата 8.3 и длинные имена файлов с расширениями, содержащими три символа. Помимо имени ASCII, каждая запись каталога содержит атрибуты записи, дату и время последнего изменения, индекс начального кластера и размер записи в байтах.

### <a name="file-allocation"></a>Выделение файлов

FileX поддерживает стандартную схему выделения кластеров в формате FAT. Кроме того, FileX поддерживает предварительное выделение непрерывных кластеров. Для этого каждый файл FileX создается без выделенных кластеров. Кластеры выделяются при последующих запросах на запись или запросах ***fx_file_allocate*** для предварительного выделения непрерывных кластеров.

На рисунке 4 с названием "Пример файла FAT-16 FileX" показан файл с именем ***FILE.TXT*** с двумя последовательными кластерами, выделенными начиная с кластера 101 размером 26 и алфавитом в качестве данных в первом кластере данных с номером 101 файла.

### <a name="file-access"></a>Доступ к файлам

Файл FileX можно открывать несколько раз одновременно для доступа на чтение. И лишь один раз для записи. Сведения, используемые для поддержки доступа к файлам, содержатся в блоке управления файлами ***FX_FILE***.

> [!NOTE]
> *Обратите внимание, что драйвер носителя может динамически устанавливать защиту от записи. В этом случае все запросы на запись, а также попытки открыть файл для записи будут отклонены.*

### <a name="file-layout-in-exfat"></a>Макет файла в exFAT

По умолчанию файловая система exFAT не требует администрирования цепочки FAT для файла, если данные хранятся в связанных кластерах. Бит *NoFATChain* в записи каталога расширения потоковой передачи указывает, следует ли использовать цепочку FAT при считывании данных из файла. Если задать параметр *NoFATChain*, FileX будет последовательно считывать данные из кластера, указанного в поле *Первый кластер* в записи каталога расширения потоковой передачи.

С другой стороны, если для *NoFATChain* не задать значение, FileX будет следовать цепочкой FAT, чтобы исследовать весь файл, как в цепочке FAT в FAT12/16/32.

На рисунке 3 показаны два примера файлов, один из которых не требует цепочки FAT, когда же другому такая цепочка FAT нужна.

## <a name="system-information"></a>Сведения о системе

Сведения о системе FileX состоят из отслеживания экземпляров открытого носителя и администрирования глобальных системных времени и даты.

![Файл со связанными кластерами по сравнению с файлами, которым необходима ссылка на FAT](./media/user-guide/system-information.png)

**РИСУНОК 3. Файл со связанными кластерами по сравнению с файлами, которым необходима ссылка на FAT**

По умолчанию в качестве системных даты и времени задается дата последнего выпуска FileX. Чтобы иметь точные системные дату и время, приложение должно вызвать ***fx_system_time_set** _ и _ *_fx_system_date_set_** во время инициализации.

### <a name="system-date"></a>Системная дата

Системная дата FileX сохраняется в глобальной переменной ***_fx_system_time***. Биты с 15 по 9 содержат смещение года (начиная с 1980 года), биты с 8 по 5 содержат смещение месяца, а биты с 4 по 0 — смещение дня. |

### <a name="system-time"></a>Системное время

Системное время FileX сохраняется в глобальной переменной ***_fx_system_time***. Биты с 15 по 11 содержат часы, биты с 10 по 5 содержат минуты, а биты с 4 по 0 — половину секунд.

### <a name="periodic-time-update"></a>Периодическое обновление времени

Во время инициализации системы FileX создает таймер приложения ThreadX для периодического обновления системных даты и времени. Скорость обновления системных даты и времени определяется двумя константами, используемыми функцией ***_fx_system_initialize***.

Константы **FX_UPDATE_RATE_IN_SECONDS** и **FX_UPDATE_RATE_IN_TICKS** представляют собой один и тот же период времени. Константа **FX_UPDATE_RATE_IN_TICKS** — число тактов таймера ThreadX, представляющее количество секунд, заданное константой **FX_UPDATE_RATE_IN_SECONDS**. Константа **FX_UPDATE_RATE_IN_SECONDS** указывает количество секунд между каждым обновлением времени FileX. Таким образом, внутреннее время FileX увеличивается с учетом интервалов **FX_UPDATE_RATE_IN_SECONDS**. Эти константы можно указать во время компиляции **_fx_system_initialize_ *_ или же разработчик может изменить значения по умолчанию, находящиеся в файле _* _fx_port.h_** выпуска FileX.

Таймер периодического действия FileX используется только для обновления глобальных системных даты и времени, применимых исключительно к созданию меток времени файла. Если создание меток времени не требуется, просто определите **FX_NO_TIMER** при компиляции **_fx_system_initialize.c_**, чтобы исключить возможность создания таймера периодического действия FileX.

![Пример файла FAT-16 FileX](./media/user-guide/fat-16-file-example.png)

**РИСУНОК 4. Пример файла FAT-16 FileX**
