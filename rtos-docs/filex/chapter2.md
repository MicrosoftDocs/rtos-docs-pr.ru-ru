---
title: Глава 2. Установка и использование FileX для ОСРВ Azure
description: Эта глава содержит вводные сведения о FileX в ОСРВ Azure, а также описание условий установки, процедур и способов использования, включая указанные ниже.
author: philmea
ms.author: philmea
ms.date: 05/19/2020
ms.topic: article
ms.service: rtos
ms.openlocfilehash: 2f064fc65ef8445ea33590f23d5a040ed8b07c6c651ea4cf5c4aaef4b6c4fa7b
ms.sourcegitcommit: 93d716cf7e3d735b18246d659ec9ec7f82c336de
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/07/2021
ms.locfileid: "116783855"
---
# <a name="chapter-2---installation-and-use-of-azure-rtos-filex"></a>Глава 2. Установка и использование FileX для ОСРВ Azure

Эта глава содержит вводные сведения о FileX в ОСРВ Azure, а также описание условий установки, процедур и способов использования. 

## <a name="host-considerations"></a>Рекомендации по размещению

### <a name="computer-type"></a>Тип компьютера

Разработка внедряемых решений обычно выполняется на главных компьютерах Windows или Linux (Unix). После компиляции, компоновки и размещения на главном компьютере приложение скачивается на целевое оборудование для выполнения.

### <a name="download-interfaces"></a>Интерфейсы скачивания

Как правило, скачивание на целевое оборудование запускается из отладчика инструмента для разработки. После скачивания отладчик отвечает за управление выполнением на целевом оборудовании (запуск, остановка, точка останова и т. д.), а также за доступ к памяти и регистрам процессора.

### <a name="debugging-tools"></a>Инструменты отладки

Большинство отладчиков инструментов разработки обмениваются данными с целевым оборудованием через подключения OCD (отладка на микросхеме), например JTAG (IEEE 1149.1) и BDM (режим фоновой отладки). Кроме того, отладчики взаимодействуют с целевым оборудованием через подключения ICE (внутрисхемная эмуляция). Подключения OCD и ICE обеспечивают надежную передачу данных с минимальным влиянием на резидентное ПО на целевом оборудовании.

### <a name="required-hard-disk-space"></a>Требуемое место на жестком диске

Исходный код FileX поставляется в формате ASCII и требует примерно 500 КБ пространства на жестком диске главного компьютера.

## <a name="target-considerations"></a>Рекомендации по целевому оборудованию

FileX требует 6–30 КБ доступной только для чтения памяти (ПЗУ) на целевом оборудовании. Еще 100 КБ ОЗУ на целевом оборудовании необходимо для глобальных структур данных FileX. На каждый открытый носитель также требуется 1,5 КБ ОЗУ для блока управления в дополнение к памяти ОЗУ для хранения данных одного сектора (обычно 512 байт).

Для правильной работы меток даты и времени FileX полагается на функции таймера ThreadX. Это реализуется за счет создания для FileX отдельного таймера во время инициализации FileX. FileX также использует семафоры ThreadX для защиты многопоточности, а также приостановку ввода-вывода.

## <a name="product-distribution"></a>Распространение продукта

FileX для ОСРВ Azure можно получить из нашего репозитория общедоступного исходного кода по адресу <https://github.com/azure-rtos/filex/>.

Ниже приведен список основных файлов в этом репозитории.

- ***fx_api.h*** — этот файл заголовка C содержит все системные равенства, структуры данных и прототипы служб.
- ***fx_port.h*** — этот файл заголовка C содержит все определения и структуры данных, относящиеся к конкретным инструментам разработки.
- ***demo_filex.c*** — этот файл на C содержит небольшое демонстрационное приложение.
- ***fx.a (или fx.lib)*** — это двоичная версия библиотеки C для FileX. Она распространяется с помощью стандартного пакета.

> [!IMPORTANT]
> *Все имена файлов содержат только строчные буквы. Это соглашение об именовании упрощает преобразование команд для использования на платформах разработки в среде Linux (UNIX).*

## <a name="filex-installation"></a>Установка FileX

FileX устанавливается путем клонирования репозитория GitHub на локальный компьютер. Ниже приведен типичный синтаксис для создания клона репозитория FileX на вашем компьютере:

```c
    git clone https://github.com/azure-rtos/filex
```

Также вы можете скачать копию репозитория с помощью соответствующей кнопки на главной странице GitHub.

Кроме того, вы можете найти инструкции по созданию библиотеки FileX на главной странице веб-репозитория.

> [!IMPORTANT]
> Прикладному программному обеспечению требуется доступ к файлу библиотеки FileX (обычно он называется* ***fx.a** _ или _*_fx.lib_*_) _и включаемым файлам C **fx_api.h** и **fx_port.h**. Для этого задайте путь к файлам в средствах разработки или скопируйте файлы в область разработки приложения.

## <a name="using-filex"></a>Использование FileX

Использовать FileX довольно просто. Код приложения должен включить файл ***fx_api.h** _ во время компиляции и компоноваться с библиотекой времени выполнения FileX _*_fx.a_*_ (или _*_fx.lib_*_). Конечно, нужны и файлы ThreadX, а именно _*_tx_api.h_*_ и _*_tx.a_*_ (или _*_tx.lib_*_)_*.

> [!IMPORTANT]
> При использовании FileX в автономном режиме (должен быть задан параметр **FX_STANDALONE_ENABLE**) файлы и библиотеки ThreadX не требуются.

Если вы уже используете ThreadX, то для создания приложения FileX необходимо выполнить четыре шага:

1. Включите файл ***fx_api.h*** во все файлы приложения, которые используют службы или структуры данных FileX.
1. Инициализируйте систему FileX, вызвав ***fx_system_initialize** _ из функции _ *_tx_application_define_** или потока приложения.

    > [!IMPORTANT]
    > При использовании FileX в автономном режиме вызов ***fx_system_initialize*** должен осуществляться напрямую из кода приложения.

1. Добавьте один или несколько вызовов ***fx_media_open***, чтобы настроить носитель FileX. Этот вызов должен выполняться из контекста потока приложения.

    > [!IMPORTANT]
    > *Помните, что для вызова **fx_media_open** требуется достаточно ОЗУ для хранения данных одного сектора.*

1. Скомпилируйте исходный код приложения и скомпонуйте его с библиотеками времени выполнения FileX и ThreadX — ***fx.a** _ (или _*_fx.lib_*_) и _*_tx.a_*_ (или _*_tx.lib_**). Полученный образ можно скачать в целевую систему и запустить.

## <a name="troubleshooting"></a>Устранение неполадок

Версии FileX для любой системы включают демонстрационное приложение. Рекомендуется сначала запустить демонстрационную систему — на целевом оборудовании или в соответствующей демонстрационной среде.

Если демонстрационная система не работает, попробуйте выполнить следующие действия, чтобы выявить проблему.

1. Определите, на каком этапе демонстрации возникает ошибка.
1. Увеличьте размеры стека (это с большей вероятностью принесет пользу в фактическом коде приложения, чем в демонстрации).
1. Убедитесь в наличии достаточного объема ОЗУ для размера электронного диска по умолчанию, равного 32 КБ. Базовая система будет использовать гораздо меньше ОЗУ, однако по мере использования все большего объема электронного диска при отсутствии достаточного объема памяти возникнут проблемы.
1. Временно отключите все недавно внесенные изменения и проверьте, сохраняется ли проблема и изменяется ли ее проявление. Такая информация будет полезной специалистам службы поддержки Майкрософт. Выполните инструкции, приведенные в разделе "Центр поддержки клиентов", чтобы отправить сведения, собранные на этапах устранения неполадок.

## <a name="configuration-options"></a>Параметры конфигурации

При сборке библиотеки FileX и приложения, использующего FileX, доступно несколько параметров конфигурации. Указанные ниже параметры можно определить в исходном коде приложения, в командной строке или во включаемом файле ***fx_user. h***.

> [!IMPORTANT]
> *Параметры, определенные в файле **fx_user.h**, применяются только в случае сборки приложения и библиотеки ThreadX с определенным параметром **_FX_INCLUDE_USER_DEFINE_FILE_*_._При использовании FileX в автономном режиме (должен быть задан параметр** FX_STANDALONE_ENABLE**) файлы и библиотеки ThreadX не требуются.

Подробное описание каждого из параметров конфигурации приведено ниже:

|Определение|Значение|
|----------    |-----------|
|FX_MAX_LAST_NAME_LEN        |Это значение определяет максимальную длину имени файла, включая полное имя пути. По умолчанию это значение равно 256.|
|FX_DONT_UPDATE_OPEN_FILES    |Когда параметр задан, FileX не изменяет уже открытые файлы.|
|FX_MEDIA_DISABLE_SEARCH_CACHE    |Когда параметр задан, оптимизация кэша поиска файлов отключена.|
|FX_MEDIA_DISABLE_SEARCH_CACHE    |Когда параметр задан, оптимизация кэша поиска файлов отключена.|
|FX_DISABLE_DIRECT_DATA_READ_CACHE_FILL |Когда параметр задан, прямое обновление сектора чтения в кэше отключено.|
|FX_MEDIA_STATISTICS_DISABLE |Когда параметр задан, сбор статистики по носителям отключен.|
|FX_SINGLE_OPEN_LEGACY |Когда параметр задан, включена устаревшая логика одиночного открытия для одного файла.|
|FX_RENAME_PATH_INHERIT    |Когда параметр задан, переименование наследует сведения о пути.|
|FX_DISABLE_ERROR_CHECKING    |Удаляет базовый API проверки ошибок FileX, что повышает производительность (до 30 %) и уменьшает размер кода.|
|FX_MAX_LONG_NAME_LEN    |Задает максимальный размер имени файла для FileX. Значение по умолчанию — 256, но его можно переопределить в командной строке. Допустимые значения находятся в диапазоне от 13 до 256.|
|FX_MAX_SECTOR_CACHE|Задает максимальное число логических секторов, которые могут быть кэшированы FileX. Фактическое количество секторов, которые могут быть кэшированы, меньше этой константы и определяет, сколько секторов может уместиться в объеме памяти, предоставляемом в fx_media_open. Значение по умолчанию — 256. Все значения должны быть степенью числа 2.|
|FX_FAT_MAP_SIZE    |Указывает число секторов, которые могут быть представлены в карте обновления FAT. Значение по умолчанию — 256, но его можно переопределить в командной строке. Увеличенные значения позволяют сократить число ненужных обновлений вторичных секторов FAT.|
|FX_MAX_FAT_CACHE    |Указывает число записей во внутреннем кэше FAT. Значение по умолчанию — 16, но его можно переопределить в командной строке. Все значения должны быть степенью числа 2.|
|FX_FAULT_TOLERANT    |Если этот параметр определен, FileX немедленно передает запросы на запись всех системных секторов (загрузочных секторов, секторов FAT и секторов каталогов) в драйвер носителя. Это может снизить производительность, но помогает ограничить повреждения потерянными кластерами. Обратите внимание, что включение этой функции не приводит к автоматическому включению модуля отказоустойчивости FileX, который включается с помощью определения|
|FX_FAULT_TOLERANT_DATA    |Если этот параметр определен, FileX немедленно передает запросы на запись файлов в драйвер носителя. Это может снизить производительность, но помогает ограничить потерю данных файлов. Обратите внимание, что включение этой функции не приводит к автоматическому включению модуля отказоустойчивости FileX, который включается с помощью определения ***FX_ENABLE_FAULT_TOLERANT***.|
|FX_NO_LOCAL_PATH|Удаляет логику локального пути из FileX, что приводит к уменьшению размера кода.|
|FX_NO_TIMER|Отменяет настройку таймера ThreadX для обновления системных времени и даты FileX. Это приводит к тому, что для всех операций с файлами указываются время и дата по умолчанию.|
|FX_UPDATE_RATE_IN_SECONDS    |Указывает частоту, с которой корректируется системное время в FileX. По умолчанию значение равно 10, то есть системное время FileX обновляется каждые 10 секунд.|
|FX_ENABLE_EXFAT| Если этот параметр определен, в FileX включена логика обработки файловой системы exFAT. По умолчанию этот символ не определен.| 
|FX_UPDATE_RATE_IN_TICKS| Задает ту же частоту, что и ***FX_UPDATE_RATE_IN_SECONDS*** (см. выше), только в виде базовой частоты таймера ThreadX. Значение по умолчанию — 1000, что подразумевает частоту таймера ThreadX 10 мс и 10-секундный интервал.|
|FX_SINGLE_THREAD|Удаляет из источника FileX логику защиты ThreadX. Этот параметр следует использовать, только если FileX используется из одного потока либо без ThreadX.|
|FX_DRIVER_USE_64BIT_LBA|При определении этот параметр включает 64-битные адреса секторов, используемые в драйвере ввода-вывода. По умолчанию этот параметр не определен.|
|FX_ENABLE_FAULT_TOLERANT| При определении этот параметр включает модуль отказоустойчивости FileX. При включении отказоустойчивости автоматически определяется символ ***FX_FAULT_TOLERANT** _ и_*_FX_FAULT_TOLERANT_DATA_**. По умолчанию этот параметр не определен.|
|FX_FAULT_TOLERANT_BOOT_INDEX|Определяет смещение в байтах в загрузочном секторе, где находится кластер для журнала отказоустойчивости. По умолчанию используется значение 116. Это поле занимает 4 байта. Выбраны байты с 116 по 119, так как они отмечены как зарезервированные в спецификации FAT 12/16/32/exFAT.|
|FX_FAULT_TOLERANT_MINIMAL_CLUSTER|Это нерекомендуемый символ. Он больше не используется модулем отказоустойчивости FileX.|
|FX_STANDALONE_ENABLE|Если этот параметр определен, он позволяет использовать FileX в автономном режиме (без ОСРВ Azure). По умолчанию этот символ не определен.|

> [!IMPORTANT]
> Если параметр **FX_STANDALONE_ENABLE** определен, логика локального пути и настройка таймера ThreadX отключаются.

## <a name="filex-version-id"></a>Идентификатор версии FileX

Сведения о текущей версии FileX доступны во время выполнения как пользователю, так и прикладному программному обеспечению. Программист может получить данные о версии FileX, изучив файл **fx_port.h**. Кроме того, этот файл содержит журнал версий для соответствующей платформы. Прикладное программное обеспечение может получить сведения о версии FileX из глобальной строки **_ _fx_version_id_**.
