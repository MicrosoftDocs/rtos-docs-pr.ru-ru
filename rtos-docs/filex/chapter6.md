---
title: Глава 6. Модуль отказоустойчивости в Azure RTOS FileX
description: В этой главе содержится описание модуля отказоустойчивости в Azure RTOS FileX, предназначенного для обеспечения целостности файловой системы, если пропадает питание для носителя или он извлекается во время записи данных в файл.
author: philmea
ms.author: philmea
ms.date: 05/19/2020
ms.topic: article
ms.service: rtos
ms.openlocfilehash: 68a24f0345a2c4d3e824270699b00a2daab32f8e
ms.sourcegitcommit: e3d42e1f2920ec9cb002634b542bc20754f9544e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/22/2021
ms.locfileid: "104815056"
---
# <a name="chapter-6---azure-rtos-filex-fault-tolerant-module"></a><span data-ttu-id="e914e-103">Глава 6. Модуль отказоустойчивости в Azure RTOS FileX</span><span class="sxs-lookup"><span data-stu-id="e914e-103">Chapter 6 - Azure RTOS FileX fault tolerant module</span></span>

<span data-ttu-id="e914e-104">В этой главе содержится описание модуля отказоустойчивости в Azure RTOS FileX, предназначенного для обеспечения целостности файловой системы, если пропадает питание для носителя или он извлекается во время записи данных в файл.</span><span class="sxs-lookup"><span data-stu-id="e914e-104">This chapter contains a description of the Azure RTOS FileX Fault Tolerant Module that is designed to maintain file system integrity if the media loses power or is ejected in the middle of a file write operation.</span></span>

## <a name="filex-fault-tolerant-module-overview"></a><span data-ttu-id="e914e-105">Общие сведения о модуле отказоустойчивости в FileX</span><span class="sxs-lookup"><span data-stu-id="e914e-105">FileX Fault Tolerant Module Overview</span></span>

<span data-ttu-id="e914e-106">Когда приложение записывает данные в файл, FileX обновляет как кластеры данных, так и сведения о системе.</span><span class="sxs-lookup"><span data-stu-id="e914e-106">When an application writes data into a file, FileX updates both data clusters and system information.</span></span> <span data-ttu-id="e914e-107">Эти обновления должны выполняться как атомарная операция, чтобы обеспечить согласованность информации в файловой системе.</span><span class="sxs-lookup"><span data-stu-id="e914e-107">These updates must be completed as an atomic operation to keep information in the file system coherent.</span></span> <span data-ttu-id="e914e-108">Например, при добавлении данных в файл FileX должна найти доступный кластер на носителе, обновить цепочку FAT, обновить длину, заданную в записи каталога, и, возможно, обновить номер начального кластера в записи каталога.</span><span class="sxs-lookup"><span data-stu-id="e914e-108">For example, when appending data to a file, FileX needs to find an available cluster in the media, update the FAT chain, update the length filed in the directory entry, and possibly update the starting cluster number in the directory entry.</span></span> <span data-ttu-id="e914e-109">Последовательность операций обновлений может быть прервана либо из-за сбоя питания, либо из-за извлечения носителя, что приведет к несогласованному состоянию файловой системы.</span><span class="sxs-lookup"><span data-stu-id="e914e-109">Either a power failure or media ejection can interrupt the sequence of updates, which will leave the file system in an inconsistent state.</span></span> <span data-ttu-id="e914e-110">Если такое состояние не устранить, обновляемые данные могут быть потеряны, а из-за повреждения сведений о системе последующая операция в файловой системе может повредить другие файлы или каталоги на носителе.</span><span class="sxs-lookup"><span data-stu-id="e914e-110">If the inconsistent state is not corrected, the data being updated can be lost, and because of damage to the system information, subsequent file system operation may damage other files or directories on the media.</span></span>

<span data-ttu-id="e914e-111">Модуль отказоустойчивости в FileX записывает в журнале действия, необходимые для обновления файла, *перед* выполнением этих действий в файловой системе.</span><span class="sxs-lookup"><span data-stu-id="e914e-111">The FileX Fault Tolerant Module works by journaling steps required to update a file *before* these steps are applied to the file system.</span></span> <span data-ttu-id="e914e-112">Если обновление файла прошло успешно, эти записи в журнале удаляются.</span><span class="sxs-lookup"><span data-stu-id="e914e-112">If the file update is successful, these log entries are removed.</span></span> <span data-ttu-id="e914e-113">Однако если обновление файла будет прервано, записи журнала сохраняются на носителе.</span><span class="sxs-lookup"><span data-stu-id="e914e-113">However, if the file update is interrupted, the log entries are stored on the media.</span></span> <span data-ttu-id="e914e-114">При следующем подключении носителя FileX обнаруживает эти записи журнала из предыдущей (незавершенной) операции записи.</span><span class="sxs-lookup"><span data-stu-id="e914e-114">Next time the media is mounted, FileX detects these log entries from the previous (unfinished) write operation.</span></span> <span data-ttu-id="e914e-115">В таких случаях FileX может выполнить восстановление после сбоя путем отката изменений, уже внесенных в файловую систему, или путем повторного внесения необходимых изменений для выполнения предыдущей операции.</span><span class="sxs-lookup"><span data-stu-id="e914e-115">In such cases, FileX can recover from a failure by either rolling back the changes already made to the file system, or by reapplying the required changes to complete the previous operation.</span></span> <span data-ttu-id="e914e-116">Таким образом, модуль отказоустойчивости в FileX обеспечивает целостность файловой системы в случае сбоя питания носителя во время обновления данных.</span><span class="sxs-lookup"><span data-stu-id="e914e-116">In this way, the FileX Fault Tolerant Module maintains file system integrity if the media loses power during an update operation.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="e914e-117">*Модуль отказоустойчивости в FileX не предназначен для предотвращения повреждения файловой системы, вызванной повреждением физического носителя, содержащего действительные данные.*</span><span class="sxs-lookup"><span data-stu-id="e914e-117">*The FileX Fault Tolerant Module is not designed to prevent file system corruption caused by physical media corruption with valid data in it.*</span></span>

> [!IMPORTANT]
> <span data-ttu-id="e914e-118">*После того как модуль отказоустойчивости в FileX начал защищать носитель, данный носитель нельзя подключать ни к чему, кроме FileX с включенной функцией отказоустойчивости. В противном случае может возникнуть несовместимость записей журнала в файловой системе со сведениями о системе на носителе. Если модуль отказоустойчивости в FileX попытается обработать записи журнала после того, как носитель будет обновлен другой файловой системой, процедура восстановления может завершиться ошибкой, в результате чего вся файловая система окажется в неизвестном состоянии.*</span><span class="sxs-lookup"><span data-stu-id="e914e-118">*After the FileX Fault Tolerant module protects a media, the media must not be mounted by anything other than FileX with Fault Tolerant enabled. Doing so can cause the log entries in the file system to be inconsistent with system information on the media. If the FileX Fault Tolerant module attempts to process log entries after the media is updated by another file system, the recovery procedure may fail, leaving the entire file system in an unpredictable state.*</span></span>

## <a name="use-of-the-fault-tolerant-module"></a><span data-ttu-id="e914e-119">Использование модуля отказоустойчивости</span><span class="sxs-lookup"><span data-stu-id="e914e-119">Use of the Fault Tolerant Module</span></span>

<span data-ttu-id="e914e-120">Модуль отказоустойчивости в FileX доступен всем файловым системам FAT, поддерживаемым системой FileX, включая FAT12, FAT16, FAT32 и exFAT.</span><span class="sxs-lookup"><span data-stu-id="e914e-120">The FileX Fault Tolerant feature is available to all FAT file systems supported by FileX, including FAT12, FAT16, FAT32, and exFAT.</span></span> <span data-ttu-id="e914e-121">Чтобы включить модуль отказоустойчивости, FileX необходимо скомпоновать с заданным символом **FX_ENABLE_FAULT_TOLERANT**.</span><span class="sxs-lookup"><span data-stu-id="e914e-121">To enable the fault tolerant feature, FileX must be built with the symbol **FX_ENABLE_FAULT_TOLERANT** defined.</span></span> <span data-ttu-id="e914e-122">В ходе своего выполнения приложение запускает службу отказоустойчивости путем вызова **_fx_fault_tolerant_enable_ *_ сразу после вызова _* _fx_media_open_**.</span><span class="sxs-lookup"><span data-stu-id="e914e-122">At run time, application starts fault tolerant service by calling **_fx_fault_tolerant_enable_*_ immediately after the call to _*_fx_media_open_**.</span></span> <span data-ttu-id="e914e-123">После включения модуля отказоустойчивости все операции записи в файлы на указанном носителе будут защищаться.</span><span class="sxs-lookup"><span data-stu-id="e914e-123">After fault tolerant is enabled, all file write operations to the designated media are protected.</span></span> <span data-ttu-id="e914e-124">По умолчанию модуль отказоустойчивости не включен.</span><span class="sxs-lookup"><span data-stu-id="e914e-124">By default the fault tolerant module is not enabled.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="e914e-125">\* Приложение должно убедиться, что доступ к файловой системе до вызова \***fx_fault_tolerant_enable** _ не выполнялся.</span><span class="sxs-lookup"><span data-stu-id="e914e-125">\*Application needs to make sure the file system is not being accessed prior to \***fx_fault_tolerant_enable** _ being called.</span></span> <span data-ttu-id="e914e-126">Если приложение записывает данные в файловую систему до включения отказоустойчивости, операция записи может повредить носитель, если предыдущие операции записи не были завершены, а файловая система не была восстановлена с помощью исправных записей журнала._</span><span class="sxs-lookup"><span data-stu-id="e914e-126">If application writes data to the file system prior to fault tolerant enable, the write operation could corrupt the media if prior write operations were not completed, and the file system was not restored using fault tolerant log entries._</span></span>

## <a name="filex-fault-tolerant-module-log"></a><span data-ttu-id="e914e-127">Журнал модуля отказоустойчивости в FileX</span><span class="sxs-lookup"><span data-stu-id="e914e-127">FileX Fault Tolerant Module Log</span></span>

<span data-ttu-id="e914e-128">Журнал модуля отказоустойчивости FileX занимает один логический кластер во флэш-памяти.</span><span class="sxs-lookup"><span data-stu-id="e914e-128">The FileX fault tolerant log takes up one logical cluster in flash.</span></span> <span data-ttu-id="e914e-129">Индекс для начального номера этого кластера записывается в загрузочный сектор носителя (смещение указывается символом **FX_FAULT_TOLERANT_BOOT_INDEX**).</span><span class="sxs-lookup"><span data-stu-id="e914e-129">The index to the starting cluster number of that cluster is recorded in the boot sector of the media, with an offset specified by the symbol **FX_FAULT_TOLERANT_BOOT_INDEX**.</span></span> <span data-ttu-id="e914e-130">По умолчанию этот символ определен со значением 116.</span><span class="sxs-lookup"><span data-stu-id="e914e-130">By default this symbol is defined to be 116.</span></span> <span data-ttu-id="e914e-131">Это расположение выбрано потому, что оно отмечено как зарезервированное в спецификации FAT12/16/32 и exFAT.</span><span class="sxs-lookup"><span data-stu-id="e914e-131">This location is chosen because it is marked as reserved in FAT12/ 16/32 and exFAT specification.</span></span>

<span data-ttu-id="e914e-132">На рис. 5 "Макет структуры журнала" показан общий макет структуры журнала.</span><span class="sxs-lookup"><span data-stu-id="e914e-132">Figure 5, "Log Structure Layout," shows the general layout of the log structure.</span></span> <span data-ttu-id="e914e-133">Структура журнала содержит три раздела: заголовок журнала, цепочка FAT и записи журнала.</span><span class="sxs-lookup"><span data-stu-id="e914e-133">The log structure contains three sections: Log Header, FAT Chain, and Log Entries.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="e914e-134">*Все многобайтовые значения, хранящиеся в записях журнала, имеют формат с прямым порядком байтов.*</span><span class="sxs-lookup"><span data-stu-id="e914e-134">*All multi-byte values stored in the log entries are in Little Endian format.*</span></span>

![Макет структуры журнала](./media/user-guide/log-structure-layout.png)

<span data-ttu-id="e914e-136">**Рис. 5. Макет структуры журнала**</span><span class="sxs-lookup"><span data-stu-id="e914e-136">**Figure 5. Log Structure Layout**</span></span>

<span data-ttu-id="e914e-137">В области заголовка журнала содержатся сведения, описывающие всю структуру журнала и подробно объясняющие каждое поле.</span><span class="sxs-lookup"><span data-stu-id="e914e-137">The Log Header area contains information that describes the entire log structure and explains each field in detail.</span></span>

<span data-ttu-id="e914e-138">**Таблица 8. Область заголовка журнала**</span><span class="sxs-lookup"><span data-stu-id="e914e-138">**TABLE 8. Log Header Area**</span></span>

|<span data-ttu-id="e914e-139">Поле</span><span class="sxs-lookup"><span data-stu-id="e914e-139">Field</span></span>|<span data-ttu-id="e914e-140">Размер (в байтах)</span><span class="sxs-lookup"><span data-stu-id="e914e-140">Size(in bytes)</span></span>|<span data-ttu-id="e914e-141">Описание</span><span class="sxs-lookup"><span data-stu-id="e914e-141">Description</span></span>|
|-----|--------------|-----------|
|<span data-ttu-id="e914e-142">ID</span><span class="sxs-lookup"><span data-stu-id="e914e-142">ID</span></span>|<span data-ttu-id="e914e-143">4</span><span class="sxs-lookup"><span data-stu-id="e914e-143">4</span></span>|<span data-ttu-id="e914e-144">Идентифицирует структуру журнала модуля отказоустойчивости FileX.</span><span class="sxs-lookup"><span data-stu-id="e914e-144">Identifies a FileX Fault Tolerant Log structure.</span></span> <span data-ttu-id="e914e-145">Структура журнала считается недопустимой, если значение идентификатора не равно 0x46544C52.</span><span class="sxs-lookup"><span data-stu-id="e914e-145">The log structure is considered invalid if the ID value is not 0x46544C52.</span></span>|
|<span data-ttu-id="e914e-146">Общий размер</span><span class="sxs-lookup"><span data-stu-id="e914e-146">Total Size</span></span>|<span data-ttu-id="e914e-147">2</span><span class="sxs-lookup"><span data-stu-id="e914e-147">2</span></span>|<span data-ttu-id="e914e-148">Указывает общий размер (в байтах) всей структуры журнала.</span><span class="sxs-lookup"><span data-stu-id="e914e-148">Indicates the total size (in bytes) of the entire log structure.</span></span>|
|<span data-ttu-id="e914e-149">Контрольная сумма заголовка</span><span class="sxs-lookup"><span data-stu-id="e914e-149">Header Checksum</span></span>|<span data-ttu-id="e914e-150">2</span><span class="sxs-lookup"><span data-stu-id="e914e-150">2</span></span>|<span data-ttu-id="e914e-151">Контрольная сумма, преобразующая область заголовка журнала.</span><span class="sxs-lookup"><span data-stu-id="e914e-151">Checksum that converts the log header area.</span></span> <span data-ttu-id="e914e-152">Структура журнала считается недопустимой, если поля заголовка не проходят проверку контрольной суммы.</span><span class="sxs-lookup"><span data-stu-id="e914e-152">The log structure is considered invalid if the header fields fail the checksum verification.</span></span>|
|<span data-ttu-id="e914e-153">Номер версии</span><span class="sxs-lookup"><span data-stu-id="e914e-153">Version Number</span></span>|<span data-ttu-id="e914e-154">2</span><span class="sxs-lookup"><span data-stu-id="e914e-154">2</span></span>|<span data-ttu-id="e914e-155">Основной и дополнительный номера версии модуля отказоустойчивости в FileX.</span><span class="sxs-lookup"><span data-stu-id="e914e-155">FileX Fault Tolerant major and minor version numbers.</span></span>|
|<span data-ttu-id="e914e-156">Зарезервировано</span><span class="sxs-lookup"><span data-stu-id="e914e-156">Reserved</span></span>|<span data-ttu-id="e914e-157">2</span><span class="sxs-lookup"><span data-stu-id="e914e-157">2</span></span>|<span data-ttu-id="e914e-158">Для расширения в будущем.</span><span class="sxs-lookup"><span data-stu-id="e914e-158">For future expansion.</span></span>|

<span data-ttu-id="e914e-159">За областью заголовка журнала следует область журнала цепочки FAT.</span><span class="sxs-lookup"><span data-stu-id="e914e-159">The Log Header area is followed by the FAT Chain Log area.</span></span> <span data-ttu-id="e914e-160">На рис. 9 приведена информация о том, как необходимо изменять цепочку FAT.</span><span class="sxs-lookup"><span data-stu-id="e914e-160">Figure 9 contains information that describes how the FAT chain should be modified.</span></span> <span data-ttu-id="e914e-161">Эта область журнала содержит сведения о кластерах, выделяемых для файла, кластерах, удаляемых из файла, а также о том, где должна выполняться операция вставки или удаления. Также здесь содержится описание каждого поля в области журнала цепочки FAT.</span><span class="sxs-lookup"><span data-stu-id="e914e-161">This log area contains information on the clusters being allocated to a file, the clusters being removed from a file, and where the insertion/deletion should be and describes each field in the FAT Chain Log area.</span></span>

<span data-ttu-id="e914e-162">**Таблица 9. Область журнала цепочки FAT**</span><span class="sxs-lookup"><span data-stu-id="e914e-162">**TABLE 9. FAT Chain Log Area**</span></span>

|<span data-ttu-id="e914e-163">Поле</span><span class="sxs-lookup"><span data-stu-id="e914e-163">Field</span></span>|<span data-ttu-id="e914e-164">Размер (в байтах)</span><span class="sxs-lookup"><span data-stu-id="e914e-164">Size(in bytes)</span></span>|<span data-ttu-id="e914e-165">Описание</span><span class="sxs-lookup"><span data-stu-id="e914e-165">Description</span></span>|
|-----|--------------|-----------|
|<span data-ttu-id="e914e-166">Контрольная сумма журнала цепочки FAT</span><span class="sxs-lookup"><span data-stu-id="e914e-166">FAT Chain Log Checksum</span></span>|<span data-ttu-id="e914e-167">2</span><span class="sxs-lookup"><span data-stu-id="e914e-167">2</span></span>|<span data-ttu-id="e914e-168">Контрольная сумма всей области журнала цепочки FAT.</span><span class="sxs-lookup"><span data-stu-id="e914e-168">Checksum of the entire FAT Chain Log area.</span></span> <span data-ttu-id="e914e-169">Область журнала цепочки FAT считается недопустимой, если она не проходит проверку контрольной суммы.</span><span class="sxs-lookup"><span data-stu-id="e914e-169">The FAT Chain Log area is considered invalid if the it fails the checksum verification.</span></span>|
|<span data-ttu-id="e914e-170">Flag</span><span class="sxs-lookup"><span data-stu-id="e914e-170">Flag</span></span>|<span data-ttu-id="e914e-171">1</span><span class="sxs-lookup"><span data-stu-id="e914e-171">1</span></span>|<span data-ttu-id="e914e-172">Допустимые значения флагов:</span><span class="sxs-lookup"><span data-stu-id="e914e-172">Valid flag values are:</span></span><br/><span data-ttu-id="e914e-173">0x01 Цепочка FAT является допустимой</span><span class="sxs-lookup"><span data-stu-id="e914e-173">0x01 FAT Chain Valid</span></span><br /><span data-ttu-id="e914e-174">0x02 Используется BITMAP</span><span class="sxs-lookup"><span data-stu-id="e914e-174">0x02 BITMAP is being used</span></span>|
|<span data-ttu-id="e914e-175">Зарезервировано</span><span class="sxs-lookup"><span data-stu-id="e914e-175">Reserved</span></span>|<span data-ttu-id="e914e-176">1</span><span class="sxs-lookup"><span data-stu-id="e914e-176">1</span></span>|<span data-ttu-id="e914e-177">Зарезервировано для использования в будущем.</span><span class="sxs-lookup"><span data-stu-id="e914e-177">Reserved for future use</span></span>|
|<span data-ttu-id="e914e-178">Точка вставки — спереди</span><span class="sxs-lookup"><span data-stu-id="e914e-178">Insertion Point – Front</span></span>|<span data-ttu-id="e914e-179">4</span><span class="sxs-lookup"><span data-stu-id="e914e-179">4</span></span>|<span data-ttu-id="e914e-180">Кластер (относящийся к исходной цепочке FAT), к которому будет присоединена новая созданная цепочка.</span><span class="sxs-lookup"><span data-stu-id="e914e-180">The cluster (that belongs to the original FAT chain) where the newly created chain is going to be attached to.</span></span>|
|<span data-ttu-id="e914e-181">Головной кластер новой цепочки FAT</span><span class="sxs-lookup"><span data-stu-id="e914e-181">Head Cluster of New FAT Chain</span></span>|<span data-ttu-id="e914e-182">4</span><span class="sxs-lookup"><span data-stu-id="e914e-182">4</span></span>|<span data-ttu-id="e914e-183">Первый кластер новой созданной цепочки FAT</span><span class="sxs-lookup"><span data-stu-id="e914e-183">The first cluster of the newly created FAT Chain</span></span>|
|<span data-ttu-id="e914e-184">Головной кластер исходной цепочки FAT</span><span class="sxs-lookup"><span data-stu-id="e914e-184">Head Cluster of Original FAT Chain</span></span>|<span data-ttu-id="e914e-185">4</span><span class="sxs-lookup"><span data-stu-id="e914e-185">4</span></span>|<span data-ttu-id="e914e-186">Первый кластер части исходной цепочки FAT, который необходимо удалить.</span><span class="sxs-lookup"><span data-stu-id="e914e-186">The first cluster of the portion of the original FAT Chain that is to be removed.</span></span>|
|<span data-ttu-id="e914e-187">Точка вставки — сзади</span><span class="sxs-lookup"><span data-stu-id="e914e-187">Insertion Point – Back</span></span>|<span data-ttu-id="e914e-188">4</span><span class="sxs-lookup"><span data-stu-id="e914e-188">4</span></span>|<span data-ttu-id="e914e-189">Исходный кластер, к которому присоединяется новая созданная цепочка FAT.</span><span class="sxs-lookup"><span data-stu-id="e914e-189">The original cluster where the newly created FAT chain joins at.</span></span>|
|<span data-ttu-id="e914e-190">Следующая точка удаления</span><span class="sxs-lookup"><span data-stu-id="e914e-190">Next Deletion Point</span></span>|<span data-ttu-id="e914e-191">4</span><span class="sxs-lookup"><span data-stu-id="e914e-191">4</span></span>|<span data-ttu-id="e914e-192">Это поле участвует в процедуре очистки цепочки FAT.</span><span class="sxs-lookup"><span data-stu-id="e914e-192">This field assists the FAT chain cleanup procedure.</span></span>|

<span data-ttu-id="e914e-193">Область записей журнала содержит записи журнала, описывающие изменения, которые необходимо внести для восстановления после сбоя.</span><span class="sxs-lookup"><span data-stu-id="e914e-193">The Log Entries Area contains log entries that describe the changes needed to recover from a failure.</span></span> <span data-ttu-id="e914e-194">Модуль отказоустойчивости в FileX поддерживает записи журнала трех типов: запись в журнале FAT, запись в журнале каталога и запись в журнале битовой карты.</span><span class="sxs-lookup"><span data-stu-id="e914e-194">There are three types of log entry supported in the FileX fault tolerant module: FAT Log Entry; Directory Log Entry; and Bitmap Log Entry.</span></span>

<span data-ttu-id="e914e-195">Следующие три рисунка и три таблицы содержат подробное описание этих записей журнала.</span><span class="sxs-lookup"><span data-stu-id="e914e-195">The following three figures and three tables describe these log entries in detail.</span></span>

![Запись журнала FAT](./media/user-guide/fat-log-entry.png)

<span data-ttu-id="e914e-197">**Рис. 6. Запись журнала FAT**</span><span class="sxs-lookup"><span data-stu-id="e914e-197">**Figure 6. FAT Log Entry**</span></span>

<span data-ttu-id="e914e-198">**Таблица 10. Запись журнала FAT**</span><span class="sxs-lookup"><span data-stu-id="e914e-198">**TABLE 10. FAT Log Entry**</span></span>

|<span data-ttu-id="e914e-199">Поле</span><span class="sxs-lookup"><span data-stu-id="e914e-199">Field</span></span>|<span data-ttu-id="e914e-200">Размер (в байтах)</span><span class="sxs-lookup"><span data-stu-id="e914e-200">Size(in bytes)</span></span>|<span data-ttu-id="e914e-201">Описание</span><span class="sxs-lookup"><span data-stu-id="e914e-201">Description</span></span>|
|-----|--------------|-----------|
<span data-ttu-id="e914e-202">Тип</span><span class="sxs-lookup"><span data-stu-id="e914e-202">Type</span></span>|<span data-ttu-id="e914e-203">2</span><span class="sxs-lookup"><span data-stu-id="e914e-203">2</span></span>|<span data-ttu-id="e914e-204">Тип записи, должен быть FX_FAULT_TOLERANT_FAT_LOG_TYPE</span><span class="sxs-lookup"><span data-stu-id="e914e-204">Type of Entry, must be FX_FAULT_TOLERANT_FAT_LOG_TYPE</span></span>|
|<span data-ttu-id="e914e-205">Размер</span><span class="sxs-lookup"><span data-stu-id="e914e-205">Size</span></span>|<span data-ttu-id="e914e-206">2</span><span class="sxs-lookup"><span data-stu-id="e914e-206">2</span></span>|<span data-ttu-id="e914e-207">Размер этой записи</span><span class="sxs-lookup"><span data-stu-id="e914e-207">Size of this entry</span></span>|
|<span data-ttu-id="e914e-208">Номер кластера</span><span class="sxs-lookup"><span data-stu-id="e914e-208">Cluster Number</span></span>|<span data-ttu-id="e914e-209">4</span><span class="sxs-lookup"><span data-stu-id="e914e-209">4</span></span>|<span data-ttu-id="e914e-210">Номер кластера</span><span class="sxs-lookup"><span data-stu-id="e914e-210">Cluster number</span></span>|
|<span data-ttu-id="e914e-211">Значение</span><span class="sxs-lookup"><span data-stu-id="e914e-211">Value</span></span>|<span data-ttu-id="e914e-212">4</span><span class="sxs-lookup"><span data-stu-id="e914e-212">4</span></span>|<span data-ttu-id="e914e-213">Значение, записываемое в запись FAT</span><span class="sxs-lookup"><span data-stu-id="e914e-213">Value to be written into the FAT entry</span></span>|

![Запись журнала каталога](./media/user-guide/directory-log-entry.png)

<span data-ttu-id="e914e-215">**Рис. 7. Запись журнала каталога**</span><span class="sxs-lookup"><span data-stu-id="e914e-215">**Figure 7. Directory Log Entry**</span></span>

<span data-ttu-id="e914e-216">**Таблица 11. Запись журнала каталога**</span><span class="sxs-lookup"><span data-stu-id="e914e-216">**TABLE 11. Directory Log Entry**</span></span>

|<span data-ttu-id="e914e-217">Поле</span><span class="sxs-lookup"><span data-stu-id="e914e-217">Field</span></span>|<span data-ttu-id="e914e-218">Размер (в байтах)</span><span class="sxs-lookup"><span data-stu-id="e914e-218">Size(in bytes)</span></span>|<span data-ttu-id="e914e-219">Описание</span><span class="sxs-lookup"><span data-stu-id="e914e-219">Description</span></span>|
|-----|--------------|-----------|
|<span data-ttu-id="e914e-220">Тип</span><span class="sxs-lookup"><span data-stu-id="e914e-220">Type</span></span>|<span data-ttu-id="e914e-221">2</span><span class="sxs-lookup"><span data-stu-id="e914e-221">2</span></span>|<span data-ttu-id="e914e-222">Тип записи, должен быть FX_FAULT_TOLERANT_DIRECTORY_LOG_TYPE</span><span class="sxs-lookup"><span data-stu-id="e914e-222">Type of Entry, must be FX_FAULT_TOLERANT_DIRECTORY_LOG_TYPE</span></span>|
|<span data-ttu-id="e914e-223">Размер</span><span class="sxs-lookup"><span data-stu-id="e914e-223">Size</span></span>|<span data-ttu-id="e914e-224">2</span><span class="sxs-lookup"><span data-stu-id="e914e-224">2</span></span>|<span data-ttu-id="e914e-225">Размер этой записи</span><span class="sxs-lookup"><span data-stu-id="e914e-225">Size of this entry</span></span>|
|<span data-ttu-id="e914e-226">Смещение сектора</span><span class="sxs-lookup"><span data-stu-id="e914e-226">Sector Offset</span></span>|<span data-ttu-id="e914e-227">4</span><span class="sxs-lookup"><span data-stu-id="e914e-227">4</span></span>|<span data-ttu-id="e914e-228">Смещение (в байтах) в сектор, в котором находится этот каталог.</span><span class="sxs-lookup"><span data-stu-id="e914e-228">Offset (in bytes) into the sector where this directory is located.</span></span>|
|<span data-ttu-id="e914e-229">Сектор журнала</span><span class="sxs-lookup"><span data-stu-id="e914e-229">Log Sector</span></span>|<span data-ttu-id="e914e-230">4</span><span class="sxs-lookup"><span data-stu-id="e914e-230">4</span></span>|<span data-ttu-id="e914e-231">Сектор, в котором находится запись каталога</span><span class="sxs-lookup"><span data-stu-id="e914e-231">The sector where the directory entry is located</span></span>|
|<span data-ttu-id="e914e-232">Данные журнала</span><span class="sxs-lookup"><span data-stu-id="e914e-232">Log Data</span></span>|<span data-ttu-id="e914e-233">Переменная</span><span class="sxs-lookup"><span data-stu-id="e914e-233">Variable</span></span>|<span data-ttu-id="e914e-234">Содержимое записи каталога</span><span class="sxs-lookup"><span data-stu-id="e914e-234">Content of the directory entry</span></span>|

![Запись журнала битовой карты](./media/user-guide/bitmap-log-entry.png)

<span data-ttu-id="e914e-236">**Рис. 8. Запись журнала битовой карты**</span><span class="sxs-lookup"><span data-stu-id="e914e-236">**Figure 8. Bitmap Log Entry**</span></span>

<span data-ttu-id="e914e-237">**Таблица 12. Запись журнала битовой карты**</span><span class="sxs-lookup"><span data-stu-id="e914e-237">**TABLE 12. Bitmap Log Entry**</span></span>

|<span data-ttu-id="e914e-238">Поле</span><span class="sxs-lookup"><span data-stu-id="e914e-238">Field</span></span>|<span data-ttu-id="e914e-239">Размер (в байтах)</span><span class="sxs-lookup"><span data-stu-id="e914e-239">Size(in bytes)</span></span>|<span data-ttu-id="e914e-240">Описание</span><span class="sxs-lookup"><span data-stu-id="e914e-240">Description</span></span>|
|-----|--------------|-----------|
|<span data-ttu-id="e914e-241">Тип</span><span class="sxs-lookup"><span data-stu-id="e914e-241">Type</span></span>|<span data-ttu-id="e914e-242">2</span><span class="sxs-lookup"><span data-stu-id="e914e-242">2</span></span>|<span data-ttu-id="e914e-243">Тип записи, должен быть FX_FAULT_TOLERANT_BITMAP_LOG_TYPE</span><span class="sxs-lookup"><span data-stu-id="e914e-243">Type of Entry, must be FX_FAULT_TOLERANT_BITMAP_LOG_TYPE</span></span>|
|<span data-ttu-id="e914e-244">Размер</span><span class="sxs-lookup"><span data-stu-id="e914e-244">Size</span></span>|<span data-ttu-id="e914e-245">2</span><span class="sxs-lookup"><span data-stu-id="e914e-245">2</span></span>|<span data-ttu-id="e914e-246">Размер этой записи</span><span class="sxs-lookup"><span data-stu-id="e914e-246">Size of this entry</span></span>|
|<span data-ttu-id="e914e-247">Номер кластера</span><span class="sxs-lookup"><span data-stu-id="e914e-247">Cluster Number</span></span>|<span data-ttu-id="e914e-248">4</span><span class="sxs-lookup"><span data-stu-id="e914e-248">4</span></span>|<span data-ttu-id="e914e-249">Номер кластера</span><span class="sxs-lookup"><span data-stu-id="e914e-249">Cluster number</span></span>|
|<span data-ttu-id="e914e-250">Значение</span><span class="sxs-lookup"><span data-stu-id="e914e-250">Value</span></span>|<span data-ttu-id="e914e-251">4</span><span class="sxs-lookup"><span data-stu-id="e914e-251">4</span></span>|<span data-ttu-id="e914e-252">Значение, записываемое в запись FAT</span><span class="sxs-lookup"><span data-stu-id="e914e-252">Value to be written into the FAT entry</span></span>|

## <a name="fault-tolerant-protection"></a><span data-ttu-id="e914e-253">Защита с помощью модуля отказоустойчивости</span><span class="sxs-lookup"><span data-stu-id="e914e-253">Fault Tolerant Protection</span></span>

<span data-ttu-id="e914e-254">После запуска модуля отказоустойчивости в FileX он выполняет поиск на носителе существующего файла журнала, обеспечивающего отказоустойчивость.</span><span class="sxs-lookup"><span data-stu-id="e914e-254">After the FileX Fault Tolerant Module starts, it first searches for an existing fault tolerant log file in the media.</span></span> <span data-ttu-id="e914e-255">Если допустимый файл журнала найти не удается, FileX считает, что носитель не защищен.</span><span class="sxs-lookup"><span data-stu-id="e914e-255">If a valid log file cannot be found, FileX considers the media unprotected.</span></span> <span data-ttu-id="e914e-256">В этом случае FileX создаст на носителе файл журнала модуля отказоустойчивости.</span><span class="sxs-lookup"><span data-stu-id="e914e-256">In this case FileX will create a fault tolerant log file on the media.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="e914e-257">\* Система FileX неспособна защитить файловую систему, если она была повреждена перед запуском модуля отказоустойчивости в FileX.</span><span class="sxs-lookup"><span data-stu-id="e914e-257">\*FileX is not able to protect a file system if it was corrupted before the FileX Fault Tolerant Module starts.</span></span> *

<span data-ttu-id="e914e-258">В случае обнаружения файла журнала модуля отказоустойчивости FileX проверяет наличие существующих записей журнала.</span><span class="sxs-lookup"><span data-stu-id="e914e-258">If a fault tolerant log file is located, FileX checks for existing log entries.</span></span> <span data-ttu-id="e914e-259">Файл журнала, в котором нет записей, указывает на то, что предыдущая операция с файлом была выполнена успешно, и все записи журнала были удалены.</span><span class="sxs-lookup"><span data-stu-id="e914e-259">A log file with no log entry indicates prior file operation was successful, and all log entries were removed.</span></span> <span data-ttu-id="e914e-260">В этом случае приложение может начать использовать файловую систему с защитой модулем отказоустойчивости.</span><span class="sxs-lookup"><span data-stu-id="e914e-260">In this case the application can start using the file system with fault tolerant protection.</span></span>

<span data-ttu-id="e914e-261">Однако, если записи журнала существуют, FileX должна либо завершить предыдущую операцию с файлом, либо откатить изменения, уже примененные к файловой системе, то есть фактически отменить их.</span><span class="sxs-lookup"><span data-stu-id="e914e-261">However if log entries are located, FileX needs to either complete the prior file operation, or revert the changes already applied to the file system, effectively undo the changes.</span></span> <span data-ttu-id="e914e-262">В любом случае после применения записей журнала к файловой системе данная система восстанавливается в свое согласованное состояние, и приложение может снова начать использовать файловую систему.</span><span class="sxs-lookup"><span data-stu-id="e914e-262">In either case, after the log entries are applied to the file system, the file system is restored into a coherent state, and application can start using the file system again.</span></span>

<span data-ttu-id="e914e-263">Для носителя, защищаемого с помощью FileX, во время обновления файлов часть данных записывается непосредственно на носитель.</span><span class="sxs-lookup"><span data-stu-id="e914e-263">For media protected by FileX, during file update operation, the data portion is written directly to the media.</span></span> <span data-ttu-id="e914e-264">Так как FileX записывает данные, эта система также регистрирует все изменения, которые должны быть применены к записям каталога, таблице FAT.</span><span class="sxs-lookup"><span data-stu-id="e914e-264">As FileX writes data, it also records any changes needed to be applied to directory entries, FAT table.</span></span> <span data-ttu-id="e914e-265">Эти сведения регистрируются в записях общего журнала.</span><span class="sxs-lookup"><span data-stu-id="e914e-265">This information is recorded in the file tolerant log entries.</span></span> <span data-ttu-id="e914e-266">Такой подход гарантирует, что обновления файловой системы произойдут после записи данных на носитель.</span><span class="sxs-lookup"><span data-stu-id="e914e-266">This approach guarantees that updates to the file system occur after the data is written to the media.</span></span> <span data-ttu-id="e914e-267">В случае извлечения носителя во время записи данных важные сведения о файловой системе не будут изменены.</span><span class="sxs-lookup"><span data-stu-id="e914e-267">If the media is ejected during the data-write phase, crucial file system information has not been changed yet.</span></span> <span data-ttu-id="e914e-268">Поэтому прерывание не повлияет на файловую систему.</span><span class="sxs-lookup"><span data-stu-id="e914e-268">Therefore the file system is not affected by the interruption.</span></span>

<span data-ttu-id="e914e-269">После успешной записи всех данных на носитель система FileX внесет изменения в сведения о системе на основе сведений в записях журнала по одной записи за раз.</span><span class="sxs-lookup"><span data-stu-id="e914e-269">After all the data is successfully written to the media, FileX then follows information in the log entries to applies the changes to system information, one entry at a time.</span></span> <span data-ttu-id="e914e-270">После переноса всех сведений о системе на носитель записи журнала будут удалены из журнала модуля отказоустойчивости.</span><span class="sxs-lookup"><span data-stu-id="e914e-270">After all the system information is committed to the media, the log entries are removed from the fault tolerant log.</span></span> <span data-ttu-id="e914e-271">На этом этапе FileX завершает операцию обновления файлов.</span><span class="sxs-lookup"><span data-stu-id="e914e-271">At this point, FileX completes the file update operation.</span></span>

<span data-ttu-id="e914e-272">В ходе этой операции файлы не обновляются на месте.</span><span class="sxs-lookup"><span data-stu-id="e914e-272">During file update operation, files are not updated in place.</span></span> <span data-ttu-id="e914e-273">Модуль отказоустойчивости выделяет сектор для данных, в который будут записываться новые данные, а затем удаляет сектор, содержащий данные, которые будут перезаписаны, обновляя связанные записи FAT, чтобы поместить новый сектор в цепочку.</span><span class="sxs-lookup"><span data-stu-id="e914e-273">The fault tolerant module allocates a sector for the data to write the new data into, and then remove the sector that contains the data to be overwritten, updating related FAT entries to link the new sector into the chian.</span></span> <span data-ttu-id="e914e-274">В случаях, когда необходимо изменить частичные данные в кластере, FileX всегда выделяет новые кластеры, записывает все данные из старых кластеров с обновленными данными в новые кластеры, а затем освобождает старые кластеры.</span><span class="sxs-lookup"><span data-stu-id="e914e-274">For situations in which partial data in a cluster needs to be modified, FileX always allocates new clusters, writes the entire data from the old clusters with updated data into the new clusters, then frees up the old clusters.</span></span> <span data-ttu-id="e914e-275">Это гарантирует, что в случае прерывания операции обновления файлов исходный файл не будет поврежден.</span><span class="sxs-lookup"><span data-stu-id="e914e-275">This guarantees that if the file update is interrupted, the original file is intact.</span></span> <span data-ttu-id="e914e-276">Приложение должно знать, что когда модуль отказоустойчивости в FileX обеспечивает защиту, для обновления данных в файле на носителе должно иметься достаточное свободное место для хранения новых данных, прежде чем можно будет освободить сектора с устаревшими данными.</span><span class="sxs-lookup"><span data-stu-id="e914e-276">The application needs to be aware that under FileX fault tolerant protection, updating data in a file requires the media to have enough free space to hold new data before sectors with old data can be released.</span></span> <span data-ttu-id="e914e-277">Если на носителе свободного места для хранения новых данных будет недостаточно, операция обновления завершится сбоем.</span><span class="sxs-lookup"><span data-stu-id="e914e-277">If the media doesn't have enough space to hold new data, the update operation fails.</span></span>
