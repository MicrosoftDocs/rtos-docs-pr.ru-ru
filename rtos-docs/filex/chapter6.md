---
title: Глава 6. Модуль отказоустойчивости в Azure RTOS FileX
description: В этой главе содержится описание модуля отказоустойчивости в Azure RTOS FileX, предназначенного для обеспечения целостности файловой системы, если пропадает питание для носителя или он извлекается во время записи данных в файл.
author: philmea
ms.author: philmea
ms.date: 05/19/2020
ms.topic: article
ms.service: rtos
ms.openlocfilehash: 68a24f0345a2c4d3e824270699b00a2daab32f8e
ms.sourcegitcommit: e3d42e1f2920ec9cb002634b542bc20754f9544e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/22/2021
ms.locfileid: "104815056"
---
# <a name="chapter-6---azure-rtos-filex-fault-tolerant-module"></a>Глава 6. Модуль отказоустойчивости в Azure RTOS FileX

В этой главе содержится описание модуля отказоустойчивости в Azure RTOS FileX, предназначенного для обеспечения целостности файловой системы, если пропадает питание для носителя или он извлекается во время записи данных в файл.

## <a name="filex-fault-tolerant-module-overview"></a>Общие сведения о модуле отказоустойчивости в FileX

Когда приложение записывает данные в файл, FileX обновляет как кластеры данных, так и сведения о системе. Эти обновления должны выполняться как атомарная операция, чтобы обеспечить согласованность информации в файловой системе. Например, при добавлении данных в файл FileX должна найти доступный кластер на носителе, обновить цепочку FAT, обновить длину, заданную в записи каталога, и, возможно, обновить номер начального кластера в записи каталога. Последовательность операций обновлений может быть прервана либо из-за сбоя питания, либо из-за извлечения носителя, что приведет к несогласованному состоянию файловой системы. Если такое состояние не устранить, обновляемые данные могут быть потеряны, а из-за повреждения сведений о системе последующая операция в файловой системе может повредить другие файлы или каталоги на носителе.

Модуль отказоустойчивости в FileX записывает в журнале действия, необходимые для обновления файла, *перед* выполнением этих действий в файловой системе. Если обновление файла прошло успешно, эти записи в журнале удаляются. Однако если обновление файла будет прервано, записи журнала сохраняются на носителе. При следующем подключении носителя FileX обнаруживает эти записи журнала из предыдущей (незавершенной) операции записи. В таких случаях FileX может выполнить восстановление после сбоя путем отката изменений, уже внесенных в файловую систему, или путем повторного внесения необходимых изменений для выполнения предыдущей операции. Таким образом, модуль отказоустойчивости в FileX обеспечивает целостность файловой системы в случае сбоя питания носителя во время обновления данных.

> [!IMPORTANT]
> *Модуль отказоустойчивости в FileX не предназначен для предотвращения повреждения файловой системы, вызванной повреждением физического носителя, содержащего действительные данные.*

> [!IMPORTANT]
> *После того как модуль отказоустойчивости в FileX начал защищать носитель, данный носитель нельзя подключать ни к чему, кроме FileX с включенной функцией отказоустойчивости. В противном случае может возникнуть несовместимость записей журнала в файловой системе со сведениями о системе на носителе. Если модуль отказоустойчивости в FileX попытается обработать записи журнала после того, как носитель будет обновлен другой файловой системой, процедура восстановления может завершиться ошибкой, в результате чего вся файловая система окажется в неизвестном состоянии.*

## <a name="use-of-the-fault-tolerant-module"></a>Использование модуля отказоустойчивости

Модуль отказоустойчивости в FileX доступен всем файловым системам FAT, поддерживаемым системой FileX, включая FAT12, FAT16, FAT32 и exFAT. Чтобы включить модуль отказоустойчивости, FileX необходимо скомпоновать с заданным символом **FX_ENABLE_FAULT_TOLERANT**. В ходе своего выполнения приложение запускает службу отказоустойчивости путем вызова **_fx_fault_tolerant_enable_ *_ сразу после вызова _* _fx_media_open_**. После включения модуля отказоустойчивости все операции записи в файлы на указанном носителе будут защищаться. По умолчанию модуль отказоустойчивости не включен.

> [!IMPORTANT]
> * Приложение должно убедиться, что доступ к файловой системе до вызова ***fx_fault_tolerant_enable** _ не выполнялся. Если приложение записывает данные в файловую систему до включения отказоустойчивости, операция записи может повредить носитель, если предыдущие операции записи не были завершены, а файловая система не была восстановлена с помощью исправных записей журнала._

## <a name="filex-fault-tolerant-module-log"></a>Журнал модуля отказоустойчивости в FileX

Журнал модуля отказоустойчивости FileX занимает один логический кластер во флэш-памяти. Индекс для начального номера этого кластера записывается в загрузочный сектор носителя (смещение указывается символом **FX_FAULT_TOLERANT_BOOT_INDEX**). По умолчанию этот символ определен со значением 116. Это расположение выбрано потому, что оно отмечено как зарезервированное в спецификации FAT12/16/32 и exFAT.

На рис. 5 "Макет структуры журнала" показан общий макет структуры журнала. Структура журнала содержит три раздела: заголовок журнала, цепочка FAT и записи журнала.

> [!IMPORTANT]
> *Все многобайтовые значения, хранящиеся в записях журнала, имеют формат с прямым порядком байтов.*

![Макет структуры журнала](./media/user-guide/log-structure-layout.png)

**Рис. 5. Макет структуры журнала**

В области заголовка журнала содержатся сведения, описывающие всю структуру журнала и подробно объясняющие каждое поле.

**Таблица 8. Область заголовка журнала**

|Поле|Размер (в байтах)|Описание|
|-----|--------------|-----------|
|ID|4|Идентифицирует структуру журнала модуля отказоустойчивости FileX. Структура журнала считается недопустимой, если значение идентификатора не равно 0x46544C52.|
|Общий размер|2|Указывает общий размер (в байтах) всей структуры журнала.|
|Контрольная сумма заголовка|2|Контрольная сумма, преобразующая область заголовка журнала. Структура журнала считается недопустимой, если поля заголовка не проходят проверку контрольной суммы.|
|Номер версии|2|Основной и дополнительный номера версии модуля отказоустойчивости в FileX.|
|Зарезервировано|2|Для расширения в будущем.|

За областью заголовка журнала следует область журнала цепочки FAT. На рис. 9 приведена информация о том, как необходимо изменять цепочку FAT. Эта область журнала содержит сведения о кластерах, выделяемых для файла, кластерах, удаляемых из файла, а также о том, где должна выполняться операция вставки или удаления. Также здесь содержится описание каждого поля в области журнала цепочки FAT.

**Таблица 9. Область журнала цепочки FAT**

|Поле|Размер (в байтах)|Описание|
|-----|--------------|-----------|
|Контрольная сумма журнала цепочки FAT|2|Контрольная сумма всей области журнала цепочки FAT. Область журнала цепочки FAT считается недопустимой, если она не проходит проверку контрольной суммы.|
|Flag|1|Допустимые значения флагов:<br/>0x01 Цепочка FAT является допустимой<br />0x02 Используется BITMAP|
|Зарезервировано|1|Зарезервировано для использования в будущем.|
|Точка вставки — спереди|4|Кластер (относящийся к исходной цепочке FAT), к которому будет присоединена новая созданная цепочка.|
|Головной кластер новой цепочки FAT|4|Первый кластер новой созданной цепочки FAT|
|Головной кластер исходной цепочки FAT|4|Первый кластер части исходной цепочки FAT, который необходимо удалить.|
|Точка вставки — сзади|4|Исходный кластер, к которому присоединяется новая созданная цепочка FAT.|
|Следующая точка удаления|4|Это поле участвует в процедуре очистки цепочки FAT.|

Область записей журнала содержит записи журнала, описывающие изменения, которые необходимо внести для восстановления после сбоя. Модуль отказоустойчивости в FileX поддерживает записи журнала трех типов: запись в журнале FAT, запись в журнале каталога и запись в журнале битовой карты.

Следующие три рисунка и три таблицы содержат подробное описание этих записей журнала.

![Запись журнала FAT](./media/user-guide/fat-log-entry.png)

**Рис. 6. Запись журнала FAT**

**Таблица 10. Запись журнала FAT**

|Поле|Размер (в байтах)|Описание|
|-----|--------------|-----------|
Тип|2|Тип записи, должен быть FX_FAULT_TOLERANT_FAT_LOG_TYPE|
|Размер|2|Размер этой записи|
|Номер кластера|4|Номер кластера|
|Значение|4|Значение, записываемое в запись FAT|

![Запись журнала каталога](./media/user-guide/directory-log-entry.png)

**Рис. 7. Запись журнала каталога**

**Таблица 11. Запись журнала каталога**

|Поле|Размер (в байтах)|Описание|
|-----|--------------|-----------|
|Тип|2|Тип записи, должен быть FX_FAULT_TOLERANT_DIRECTORY_LOG_TYPE|
|Размер|2|Размер этой записи|
|Смещение сектора|4|Смещение (в байтах) в сектор, в котором находится этот каталог.|
|Сектор журнала|4|Сектор, в котором находится запись каталога|
|Данные журнала|Переменная|Содержимое записи каталога|

![Запись журнала битовой карты](./media/user-guide/bitmap-log-entry.png)

**Рис. 8. Запись журнала битовой карты**

**Таблица 12. Запись журнала битовой карты**

|Поле|Размер (в байтах)|Описание|
|-----|--------------|-----------|
|Тип|2|Тип записи, должен быть FX_FAULT_TOLERANT_BITMAP_LOG_TYPE|
|Размер|2|Размер этой записи|
|Номер кластера|4|Номер кластера|
|Значение|4|Значение, записываемое в запись FAT|

## <a name="fault-tolerant-protection"></a>Защита с помощью модуля отказоустойчивости

После запуска модуля отказоустойчивости в FileX он выполняет поиск на носителе существующего файла журнала, обеспечивающего отказоустойчивость. Если допустимый файл журнала найти не удается, FileX считает, что носитель не защищен. В этом случае FileX создаст на носителе файл журнала модуля отказоустойчивости.

> [!IMPORTANT]
> * Система FileX неспособна защитить файловую систему, если она была повреждена перед запуском модуля отказоустойчивости в FileX. *

В случае обнаружения файла журнала модуля отказоустойчивости FileX проверяет наличие существующих записей журнала. Файл журнала, в котором нет записей, указывает на то, что предыдущая операция с файлом была выполнена успешно, и все записи журнала были удалены. В этом случае приложение может начать использовать файловую систему с защитой модулем отказоустойчивости.

Однако, если записи журнала существуют, FileX должна либо завершить предыдущую операцию с файлом, либо откатить изменения, уже примененные к файловой системе, то есть фактически отменить их. В любом случае после применения записей журнала к файловой системе данная система восстанавливается в свое согласованное состояние, и приложение может снова начать использовать файловую систему.

Для носителя, защищаемого с помощью FileX, во время обновления файлов часть данных записывается непосредственно на носитель. Так как FileX записывает данные, эта система также регистрирует все изменения, которые должны быть применены к записям каталога, таблице FAT. Эти сведения регистрируются в записях общего журнала. Такой подход гарантирует, что обновления файловой системы произойдут после записи данных на носитель. В случае извлечения носителя во время записи данных важные сведения о файловой системе не будут изменены. Поэтому прерывание не повлияет на файловую систему.

После успешной записи всех данных на носитель система FileX внесет изменения в сведения о системе на основе сведений в записях журнала по одной записи за раз. После переноса всех сведений о системе на носитель записи журнала будут удалены из журнала модуля отказоустойчивости. На этом этапе FileX завершает операцию обновления файлов.

В ходе этой операции файлы не обновляются на месте. Модуль отказоустойчивости выделяет сектор для данных, в который будут записываться новые данные, а затем удаляет сектор, содержащий данные, которые будут перезаписаны, обновляя связанные записи FAT, чтобы поместить новый сектор в цепочку. В случаях, когда необходимо изменить частичные данные в кластере, FileX всегда выделяет новые кластеры, записывает все данные из старых кластеров с обновленными данными в новые кластеры, а затем освобождает старые кластеры. Это гарантирует, что в случае прерывания операции обновления файлов исходный файл не будет поврежден. Приложение должно знать, что когда модуль отказоустойчивости в FileX обеспечивает защиту, для обновления данных в файле на носителе должно иметься достаточное свободное место для хранения новых данных, прежде чем можно будет освободить сектора с устаревшими данными. Если на носителе свободного места для хранения новых данных будет недостаточно, операция обновления завершится сбоем.
