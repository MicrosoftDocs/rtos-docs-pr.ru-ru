---
title: Глава 11. Формат буфера трассировки событий
description: ThreadX предоставляет встроенную поддержку трассировки событий для всех служб ThreadX для ОСРВ Azure, изменений состояния потоков и определяемых пользователем событий.
author: philmea
ms.service: rtos
ms.topic: article
ms.date: 5/19/2020
ms.author: philmea
ms.openlocfilehash: b230a6207cec3a0968d88b197455896881e5ef7a0d8b93d4b1fb5a37696a7b6c
ms.sourcegitcommit: 93d716cf7e3d735b18246d659ec9ec7f82c336de
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/07/2021
ms.locfileid: "116802147"
---
# <a name="chapter-11---format-of-event-trace-buffer"></a>Глава 11. Формат буфера трассировки событий

ThreadX для ОСРВ Azure предоставляет встроенную поддержку трассировки событий для всех служб ThreadX, изменений состояния потоков и определяемых пользователем событий. Чтобы использовать трассировку событий, перед сборкой библиотек ThreadX, NetX и FileX определите параметр **TX_ENABLE_EVENT_TRACE** и включите трассировку, вызвав функцию **_tx_trace_enable_**. В этой главе подробно описывается этот процесс.

## <a name="event-trace-format"></a>Формат трассировки событий

Формат буфера трассировки событий в ThreadX включает три раздела: заголовок управления, реестр объектов и записи трассировки. Ниже описан общий макет буфера трассировки событий в ThreadX:

**Заголовок управления**

**Запись 0 в реестре объектов**

**…**

**Запись "n" в реестре объектов**

**Запись 0 в трассировке событий**

**…**

**Запись "n" в трассировке событий**

### <a name="event-trace-control-header"></a>Заголовок управления для трассировки событий

Заголовок управления определяет точный макет буфера трассировки событий. Среди прочего здесь указывается, сколько объектов ThreadX можно зарегистрировать и сколько событий можно записать. Кроме того, заголовок управления определяет расположение каждого элемента буфера трассировки. Заголовок управления имеет формат следующей структуры данных:

```c
typedef struct TX_TRACE_CONTROL_HEADER_STRUCT
{
    ULONG    tx_trace_control_header_id;
    ULONG    tx_trace_control_header_timer_valid_mask;
    ULONG    tx_trace_control_header_trace_base_address;
    ULONG    tx_trace_control_header_object_registry_start_pointer;
    USHORT   tx_trace_control_header_reserved1;
    USHORT   tx_trace_control_header_object_registry_name_size;
    ULONG    tx_trace_control_header_object_registry_end_pointer;
    ULONG    tx_trace_control_header_buffer_start_pointer;
    ULONG    tx_trace_control_header_buffer_end_pointer;
    ULONG    tx_trace_control_header_buffer_current_pointer;
    ULONG    tx_trace_control_header_reserved2;
    ULONG    tx_trace_control_header_reserved3;
    ULONG    tx_trace_control_header_reserved4;
} TX_TRACE_CONTROL_HEADER;
```

### <a name="control-header-id"></a>Идентификатор заголовка управления

Идентификатор заголовка управления состоит из 32-разрядного шестнадцатеричного значения 0x54585442, которое соответствует знакам ASCII ***TXTB***. Так как это значение сохраняется в формате 32-разрядной переменной без знака, оно позволяет определить порядок следования байтов в буфере трассировки событий. Например, если в первых четырех байтах памяти размещены значения 0x54, 0x58, 0x54 и 0x42, значит буфер трассировки событий сохранялся в формате с обратным порядком байтов. В противном случае для буфера трассировки событий применялся прямой порядок байтов.

### <a name="timer-valid-mask"></a>Допустимая маска таймера

Допустимая маска таймера определяет, сколько битов метки времени учитываются в записях трассировки событий. Например, если источник метки времени предоставляет 16-разрядное значение, в этом поле должно размещаться значение 0xFFFF. Для 32-разрядного источника метки времени здесь указывается 0xFFFFFFFF. Это значение определяется константой ***TX_TRACE_TIME_MASK** _ в файле _*_tx_port.h_**.

### <a name="trace-base-address"></a>Базовый адрес трассировки

Базовый адрес буфера трассировки представляет собой адрес, который приложение указывает в качестве начала буфера трассировки в вызове ***tx_trace_enable***. Этот адрес нужен только для того, чтобы средство анализа могло получить значения смещений элементов в буфере относительно начала буфера. Например, относительное смещение текущего события в буфере трассировки вычисляется простым вычитанием базового адреса из адреса текущего события.

### <a name="registry-start-and-end-pointers"></a>Указатели начала и конца реестра

Указатель начала реестра указывает на адрес первой записи в реестре объектов, а указатель конца реестра — на адрес сразу за последней записью реестра. Эти значения устанавливаются во время обработки службы *tx_trace_enable* и не изменяются на всем протяжении трассировки.

### <a name="registry-name-size"></a>Размер имени реестра

Размер имени реестра определяет максимальный размер в байтах для каждого имени объекта в записи реестра и определяется символом ***TX_TRACE_OBJECT_REGISTRY_NAME** _. По умолчанию используется значение 32, которое определено в файле _*_tx_trace.h_*_. Имя объекта соответствует имени, которое приложение указывает при создании объекта. Например, имя реестра объектов для потока совпадает с именем, предоставленным приложением при вызове _*_tx_thread_create_**.

### <a name="buffer-start-and-end-pointers"></a>Указатели начала и конца буфера

Указатель начала буфера трассировки событий указывает на адрес первой записи трассировки, а указатель конца буфера — на адрес сразу за последней записью трассировки. Эти значения устанавливаются во время обработки службы ***tx_trace_enable*** и не изменяются на всем протяжении трассировки.

### <a name="current-buffer-pointer"></a>Указатель текущего буфера

Указатель текущего буфера трассировки событий указывает на адрес самой старой записи трассировки. Так как записи трассировки сохраняются в циклическом списке, указатель текущего буфера одновременно обозначает позицию для сохранения следующей записи трассировки. |

## <a name="event-trace-object-registry"></a>Реестр объектов трассировки событий

Реестр объектов трассировки событий содержит ***n** _ элементов реестра объектов, которые соответствуют созданным приложением объектам. Реестр объектов предназначен в первую очередь для того, чтобы внешние средства анализа могли соотнести реальные имена объектов с адресами записей в буфере трассировки. Число записей реестра задается приложением в вызове _ *_tx_trace_enable_**.

Каждая запись реестра объектов содержит сведения о конкретном объекте ThreadX, ранее созданном приложением. Следующая структура данных определяет каждую запись реестра объектов:

```c
typedef struct TX_TRACE_OBJECT_REGISTRY_ENTRY_STRUCT
{
    UCHAR    tx_trace_object_registry_entry_object_available**;
    UCHAR    tx_trace_object_registry_entry_object_type**;
    UCHAR    tx_trace_object_registry_entry_object_reserved1;
    UCHAR    tx_trace_object_registry_entry_object_reserved2;
    ULONG    tx_trace_thread_registry_entry_object_pointer;
    ULONG    tx_trace_object_registry_entry_object_parameter_1;
    ULONG    tx_trace_object_registry_entry_object_parameter_2;
    UCHAR    tx_trace_thread_registry_entry_object_name[TX_TRACE_OBJECT_REGISTRY_NAME];

} TX_TRACE_OBJECT_REGISTRY_ENTRY;
```

### <a name="object-available-flag"></a>Флаг доступности объекта

Флаг доступности объекта получает значение 1, если доступна запись реестра объектов. В противном случае (значение отличается от 1) запись в реестре объектов недоступна. Обратите внимание, что даже недоступная запись может содержать допустимые сведения.

### <a name="object-entry-type"></a>Тип записи объекта

Тип записи объекта определяет тип объекта в этой записи. Ниже представлен полный список допустимых типов объекта:

| **Значение** | **Тип объекта** |
|---------- | --------------- |
| 0         | Недействительно       |
| 1         | Thread          |
| 2         | Таймер |
| 3         | Очередь |
| 4         | Semaphore |
| 5         | Mutex |
| 6         | Группа флагов событий |
| 7         | Пул блоков |
| 8         | Пул байтов |
| 9         | ../media |
| 10        | Файл |
| 11        | IP-адрес |
| 12        | Пул пакетов |
| 13        | Сокет TCP |
| 14        | Сокет UDP |
| 15–20     | Зарезервировано |  
| 21        | Устройство стека узла USB |
| 22        | Интерфейс стека узла USB |
| 23        | Конечная точка узла USB |
| 24        | Класс узла USB |
| 25        | USB-устройство |
| 26        | Интерфейс USB-устройства |
| 27        | Конечная точка USB-устройства |
| 28        | Класс USB-устройства |

### <a name="object-pointer"></a>Указатель объекта

Указатель объекта определяет адрес объекта, который используется для доступа к этому объекту через API ThreadX.

### <a name="object-reserved-fields"></a>Зарезервированные поля объекта

Для всех объектов, кроме потоков, зарезервированные поля должны иметь значение 0. Для потоков выполняется сохранение приоритета потока в два зарезервированных поля на момент его помещения в реестр.

### <a name="object-parameters"></a>Параметры объекта

Параметры объекта содержат дополнительные сведения об этом объекте. Ниже описаны дополнительные сведения для каждого объекта ThreadX:

| **Тип объекта**        | **Параметр 1**  | **Параметр 2** |
|----------------------- | ---------------- | --------------- |
| Thread                 | Начало стека      | Размер стека |
| Таймер                  | Начальные такты | Такты переназначения |
| Очередь                  | Размер очереди | Размер сообщения |
| Semaphore              | Начальные экземпляры | - |
| Mutex                  | Флаг наследования | - |
| Группа флагов событий      | - | - |
| Пул блоков             | Общее количество блоков | Размер блока |
| Пул байтов              | Всего байт | - |
| ../media                  | Объем кэша FAT | Размер кэша секторов |
| Файл                   | - | - |
| IP-адрес                     | Начало стека | Размер стека |
| Пул пакетов            | Packet Size | Количество пакетов |
| Сокет TCP             | IP-адрес | Размер окна |
| Сокет UDP             | IP-адрес | Предел очереди RX |

### <a name="object-name"></a>Имени объекта

Имя объекта содержит имя объекта ThreadX. Это то же имя, которое передается в ThreadX при создании объекта. По умолчанию имя объекта ограничивается длиной 32 символа. Если реальное имя длиннее 32 символов, оно усекается.

## <a name="event-trace-entries"></a>Записи трассировки событий

Записи трассировки событий находятся в нижнем сегменте буфера трассировки событий. Эти записи хранятся в циклическом списке, в котором указатель текущей записи указывает на самую старую запись. Количество записей в этом списке вычисляется с помощью вызова ***tx_trace_enable***.

Каждая запись в реестре объектов содержит сведения о конкретном событии трассировки ThreadX. Следующая структура данных определяет каждую запись событий трассировки:

```c
typedef struct TX_TRACE_BUFFER_ENTRY_STRUCT
{
    ULONG     tx_trace_buffer_entry_thread_pointer;
    ULONG     tx_trace_buffer_entry_thread_priority;
    ULONG     tx_trace_buffer_entry_event_id;
    ULONG     tx_trace_buffer_entry_time_stamp;
    ULONG     tx_trace_buffer_entry_information_field_1;
    ULONG     tx_trace_buffer_entry_information_field_2;
    ULONG     tx_trace_buffer_entry_information_field_3;
    ULONG     tx_trace_buffer_entry_information_field_4;
} TX_TRACE_BUFFER_ENTRY;
```

### <a name="thread-pointer"></a>Указатель потока

Указатель потока содержит адрес потока, который выполнялся при наступлении текущего события. Если событие наступило на этапе инициализации (когда еще нет потоков), в этот указатель сохраняется значение 0xF0F0F0F0. Если событие наступило при выполнении обработчика прерываний (ISR), в этот указатель сохраняется значение 0xFFFFFFFF. Если запись еще не использовалась, значение этого указателя равно 0.

### <a name="thread-priority"></a>Приоритет потока

Поле приоритета потока содержит значения приоритета и порога вытеснения для того потока, который выполнялся при наступлении этого события. Если присутствует контекст прерывания (указатель потока равен 0xFFFFFFFF), значение этого поля содержит не приоритет, а значение ***_tx_thread_current_ptr*** на момент наступления события. В противном случае значение этого поля равно 0.

### <a name="event-id"></a>Идентификатор события

Идентификатор события определяет событие, которое произошло. В среде ThreadX допускаются идентификаторы событий трассировки в диапазоне от 1 до 1024. Значения 1025 и выше зарезервированы для пользовательских событий. Полное описание идентификаторов событий ThreadX размещено в файле ***tx_trace.h***.</td>

### <a name="information-fields-1-4"></a>Информационные поля (1–4)

Информационные поля содержат дополнительные сведения о конкретном событии. Полное описание информационных полей для каждого из определенных идентификаторов событий ThreadX размещено в файле ***tx_trace.h***.